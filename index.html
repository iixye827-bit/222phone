<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Jellyfishä¸­å¿ƒ</title>
    <style>
        /* [CSS - V7.3.1 "Gesture Fix Update"] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Arial', -apple-system, BlinkMacSystemFont, sans-serif; }
        :root { --day-color1: #f5f7fa; --day-color2: #e4eaf5; --night-color1: #1f2a40; --night-color2: #16213e; --hold-border: #5B99E2; --text-day: #2d3748; --text-night: #e0e6f0; --bg-day: #eef2f9; --bg-night: #1a2337; --shadow-light-day: rgba(255, 255, 255, 0.9); --shadow-dark-day: rgba(174, 190, 212, 0.4); --shadow-light-night: rgba(40, 52, 79, 0.9); --shadow-dark-night: rgba(0, 0, 0, 0.3); }
        body { min-height: 100vh; background: linear-gradient(135deg, var(--day-color1) 0%, var(--day-color2) 100%); padding: 20px; display: flex; flex-direction: column; align-items: center; transition: background 0.5s ease; touch-action: manipulation; overflow-x: hidden; }
        body.dark-mode { background: linear-gradient(135deg, var(--night-color1) 0%, var(--night-color2) 100%); --hold-border: #63b3ed; color: var(--text-night); }
        .title-card { width: 100%; max-width: 800px; padding: 40px 20px; margin: 20px 0; border-radius: 16px; box-shadow: 12px 12px 24px var(--shadow-dark-day), -12px -12px 24px var(--shadow-light-day); background-color: var(--bg-day); backdrop-filter: blur(8px); text-align: center; transition: all 0.5s ease; }
        body.dark-mode .title-card { box-shadow: 12px 12px 24px var(--shadow-dark-night), -12px -12px 24px var(--shadow-light-night); background-color: var(--bg-night); }
        .editable-title, .editable-subtitle { opacity: 0; transition: opacity 0.5s ease; } /* FOUC Fix */
        .editable-title { font-size: 32px; color: var(--text-day); margin-bottom: 20px; cursor: pointer; padding: 6px 12px; border-radius: 8px; display: block; width: fit-content; margin: 0 auto 20px auto; user-select: none; }
        body.dark-mode .editable-title { color: var(--text-night); }
        .editable-title:hover { background-color: rgba(255, 255, 255, 0.8); } body.dark-mode .editable-title:hover { background-color: rgba(50, 55, 75, 0.8); }
        .editable-subtitle { font-size: 16px; color: #5a6778; cursor: pointer; padding: 4px 8px; border-radius: 6px; display: block; width: fit-content; margin: 0 auto; line-height: 1.5; user-select: none; }
        body.dark-mode .editable-subtitle { color: #c0c6cc; }
        .editable-subtitle:hover { background-color: rgba(255, 255, 255, 0.8); color: var(--text-day); } body.dark-mode .editable-subtitle:hover { background-color: rgba(50, 55, 75, 0.8); color: var(--text-night); }
        .nav-container { width: 100%; max-width: 1200px; margin: 20px 0; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 25px; padding: 20px; position: relative; z-index: 10; }
        .nav-btn { position: relative; padding: 22px 16px; border: none; border-radius: 14px; box-shadow: 10px 10px 20px var(--shadow-dark-day), -10px -10px 20px var(--shadow-light-day); background-color: var(--bg-day); backdrop-filter: blur(8px); font-size: 17px; font-weight: 600; color: var(--text-day); cursor: pointer; transition: all 0.3s ease; text-align: center; user-select: none; -webkit-tap-highlight-color: transparent; }
        .nav-btn.hold { border: 2px solid var(--hold-border); transform: scale(1.02); z-index: 5; box-shadow: 8px 8px 16px rgba(174, 190, 212, 0.5), -8px -8px 16px rgba(255, 255, 255, 0.8), 0 0 0 2px rgba(91, 153, 226, 0.3); }
        body.dark-mode .nav-btn { box-shadow: 10px 10px 20px var(--shadow-dark-night), -10px -10px 20px var(--shadow-light-night); background-color: var(--bg-night); color: var(--text-night); }
        body.dark-mode .nav-btn.hold { box-shadow: 8px 8px 16px rgba(0, 0, 0, 0.4), -8px -8px 16px rgba(40, 52, 79, 0.8), 0 0 0 2px rgba(99, 179, 237, 0.3); }
        .nav-btn:hover { transform: translateY(-3px); background-color: #f7faff; } body.dark-mode .nav-btn:hover { background-color: #212d46; }
        .nav-btn:active { box-shadow: inset 6px 6px 12px var(--shadow-dark-day), inset -6px -6px 12px var(--shadow-light-day); transform: translateY(0); }
        body.dark-mode .nav-btn:active { box-shadow: inset 6px 6px 12px rgba(0, 0, 0, 0.25), inset -6px -6px 12px rgba(40, 52, 79, 0.8); }
        .delete-icon { display: none; position: absolute; top: -5px; right: -5px; width: 24px; height: 24px; background-color: #f56565; color: white; border-radius: 50%; border: 2px solid white; font-size: 16px; font-weight: bold; line-height: 20px; text-align: center; cursor: pointer; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .page-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(2px); z-index: 99; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .page-overlay.show { opacity: 1; pointer-events: auto; }
        .page-overlay.management-overlay { background: transparent; backdrop-filter: none; z-index: 5; }
        .management-active .nav-btn { cursor: move; animation: wiggle 0.2s ease-in-out infinite alternate; pointer-events: auto !important; }
        .management-active .nav-btn > .delete-icon { display: block; }
        @keyframes wiggle { from { transform: rotate(-0.5deg); } to { transform: rotate(0.5deg); } }
        .fab-container { position: fixed; right: 30px; bottom: 30px; z-index: 100; }
        .fab-main, .fab-drawer-item { width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); box-shadow: 4px 4px 8px var(--shadow-dark-day), -4px -4px 8px var(--shadow-light-day); background-color: var(--bg-day); color: var(--text-day); font-size: 22px; display: flex; align-items: center; justify-content: center; user-select: none; -webkit-tap-highlight-color: transparent; }
        body.dark-mode .fab-main, body.dark-mode .fab-drawer-item { box-shadow: 4px 4px 8px var(--shadow-dark-night), -4px -4px 8px var(--shadow-light-night); background-color: var(--bg-night); color: var(--text-night); }
        .fab-main:active, .fab-drawer-item:active { transform: scale(0.95); }
        .fab-container.active .fab-main { transform: rotate(45deg); }
        .fab-drawer { position: absolute; bottom: 65px; left: 0; display: flex; flex-direction: column; gap: 15px; opacity: 0; transform: translateY(20px); transition: opacity 0.2s ease-out, transform 0.2s ease-out; pointer-events: none; }
        .fab-container.active .fab-drawer { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .fab-drawer-item { position: relative; }
        #sync-status-indicator { position: absolute; right: 5px; top: 5px; width: 10px; height: 10px; border-radius: 50%; background-color: transparent; transition: all 0.3s ease; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        #sync-status-indicator.synced { background-color: #28a745; } #sync-status-indicator.syncing { background-color: #ffc107; animation: pulse 1.5s infinite; } #sync-status-indicator.error { background-color: #dc3545; animation: none; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);backdrop-filter:blur(5px);display:none;align-items:center;justify-content:center;z-index:1000;opacity:0;transition:opacity .3s ease}.modal-overlay.show{display:flex;opacity:1}.modal-content{width:90%;background:var(--bg-day);color:var(--text-day);border-radius:16px;box-shadow:12px 12px 24px var(--shadow-dark-day),-12px -12px 24px var(--shadow-light-day);padding:25px;transition:transform .3s ease,background .5s ease,box-shadow .5s ease;transform:scale(.95);display:flex;flex-direction:column;max-height:90vh}.modal-overlay.show .modal-content{transform:scale(1)}body.dark-mode .modal-content{background:var(--bg-night);color:var(--text-night);box-shadow:12px 12px 24px var(--shadow-dark-night),-12px -12px 24px var(--shadow-light-night)}.modal-header{display:flex;justify-content:space-between;align-items:center;font-size:20px;font-weight:600;margin-bottom:20px;flex-shrink:0}.modal-title-group{display:flex;align-items:center;gap:8px}.modal-header .close-btn,.modal-header .settings-btn{cursor:pointer;border:none;background:transparent;color:inherit;padding:5px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:background .2s ease}.modal-header .close-btn{font-size:24px;font-weight:bold;width:36px;height:36px}.modal-header .settings-btn{font-size:20px;width:32px;height:32px}.modal-header .close-btn:hover,.modal-header .settings-btn:hover{background:rgba(0,0,0,0.05)}body.dark-mode .modal-header .close-btn:hover,body.dark-mode .modal-header .settings-btn:hover{background:rgba(255,255,255,0.08)}
        .modal-body { overflow-y: auto; flex-grow: 1; display:flex; flex-direction:column; gap: 15px; margin-right: -5px; padding-right: 5px; scrollbar-width: none; -ms-overflow-style: none; }
        .modal-body::-webkit-scrollbar { width: 0; background: transparent; }
        .modal-input,.modal-select{width:100%;padding:12px 15px;border:none;border-radius:10px;font-size:16px;background:var(--bg-day);color:var(--text-day);box-shadow:inset 4px 4px 8px var(--shadow-dark-day),inset -4px -4px 8px var(--shadow-light-day);transition:all .3s ease;caret-color:var(--hold-border)}body.dark-mode .modal-input,body.dark-mode .modal-select{background:var(--bg-night);color:var(--text-night);box-shadow:inset 4px 4px 8px var(--shadow-dark-night),inset -4px -4px 8px var(--shadow-light-night)}.modal-input:focus,.modal-select:focus{outline:none;box-shadow:inset 4px 4px 8px var(--shadow-dark-day),inset -4px -4px 8px var(--shadow-light-day),0 0 0 2px var(--hold-border)}body.dark-mode .modal-input:focus,body.dark-mode .modal-select:focus{box-shadow:inset 4px 4px 8px var(--shadow-dark-night),inset -4px -4px 8px var(--shadow-light-night),0 0 0 2px var(--hold-border)}
        .modal-button{width:100%;padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;color:var(--hold-border);background:var(--bg-day);box-shadow:4px 4px 8px var(--shadow-dark-day),-4px -4px 8px var(--shadow-light-day);transition:all .2s ease}body.dark-mode .modal-button{color:var(--hold-border);background:var(--bg-night);box-shadow:4px 4px 8px var(--shadow-dark-night),-4px -4px 8px var(--shadow-light-night)}.modal-button:active{box-shadow:inset 4px 4px 8px var(--shadow-dark-day),inset -4px -4px 8px var(--shadow-light-day)}body.dark-mode .modal-button:active{box-shadow:inset 4px 4px 8px var(--shadow-dark-night),inset -4px -4px 8px var(--shadow-light-night)}.modal-button:disabled{color:#9db2c2;cursor:not-allowed;box-shadow:none;}
        #syncErrorModal .modal-content { max-width: 450px; } #sync-error-message { padding: 12px; border-radius: 8px; background: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.2); font-family: monospace; font-size: 14px; word-wrap: break-word; user-select: text; } body.dark-mode #sync-error-message { background: rgba(252, 129, 129, 0.1); border-color: rgba(252, 129, 129, 0.2); }
        #colorPaletteModal .modal-content { max-width: 450px; } #colorPaletteModal .modal-body { gap: 20px; }
        .color-picker-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; } .color-picker-group { display: flex; flex-direction: column; gap: 8px; }
        .color-picker-group label { font-size: 14px; color: #5a6778; } body.dark-mode .color-picker-group label { color: #c0c6cc; }
        .color-input-wrapper { display: flex; align-items: center; border-radius: 10px; padding: 5px; background:var(--bg-day); box-shadow: inset 4px 4px 8px var(--shadow-dark-day), inset -4px -4px 8px var(--shadow-light-day); } body.dark-mode .color-input-wrapper { background:var(--bg-night); box-shadow: inset 4px 4px 8px var(--shadow-dark-night), inset -4px -4px 8px var(--shadow-light-night); }
        input[type="color"] { width: 36px; height: 30px; border: none; background: transparent; cursor: pointer; -webkit-appearance: none; padding: 0; flex-shrink: 0; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; } input[type="color"]::-webkit-color-swatch { border-radius: 6px; border: none; }
        .hex-display { flex-grow: 1; text-align: right; padding: 0 10px; font-family: monospace; font-size: 16px; color: #889; }
        .preview-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; } .preview-box { height: 40px; border-radius: 8px; position: relative; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .preview-box::before { content: attr(data-label); } #dayPreview { border: 2px solid var(--bg-day); color: var(--text-day); } body.dark-mode #dayPreview { border-color: rgba(255,255,255,0.1); }
        #nightPreview { border: 2px solid var(--bg-night); color: var(--text-night); } body.dark-mode #nightPreview { border-color: rgba(255,255,255,0.2); }
        .preset-manager { border-top: 1px solid rgba(0,0,0,0.1); padding-top: 20px; display: flex; flex-direction: column; gap: 15px; }
        body.dark-mode .preset-manager { border-color: rgba(255,255,255,0.1); } .preset-row { display: flex; align-items: center; gap: 10px; }
        .preset-row .modal-input, .preset-row .modal-select { flex-grow: 1; }
        .preset-row .modal-button { width: auto; padding: 12px 15px; flex-shrink: 0; font-size: 14px; }
        .preset-row .modal-button.save { color: #28a745; } .preset-row .modal-button.delete { color: #dc3545; }
        .random-toggle-section { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-radius: 12px; background:var(--bg-day); box-shadow: inset 4px 4px 8px var(--shadow-dark-day), inset -4px -4px 8px var(--shadow-light-day); }
        body.dark-mode .random-toggle-section { background:var(--bg-night); box-shadow: inset 4px 4px 8px var(--shadow-dark-night), inset -4px -4px 8px var(--shadow-light-night); }
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 22px; } .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; } .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--hold-border); } input:checked + .slider:before { transform: translateX(18px); }
        #file-list-container{flex-grow:1;overflow-y:auto;border-radius:10px;padding:5px;margin-top:10px;background:var(--bg-day);box-shadow:inset 4px 4px 8px var(--shadow-dark-day),inset -4px -4px 8px var(--shadow-light-day)}body.dark-mode #file-list-container{background:var(--bg-night);box-shadow:inset 4px 4px 8px var(--shadow-dark-night),inset -4px -4px 8px var(--shadow-light-night)}#file-list-container ul{list-style:none;padding:5px}#file-list-container li{padding:8px 15px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;transition:background .2s;gap:10px}#file-list-container li:hover{background-color:rgba(0,0,0,0.05)}body.dark-mode #file-list-container li:hover{background-color:rgba(255,255,255,0.08)}#file-list-status{text-align:center;color:#889;padding:30px 10px}.file-info{flex-grow:1;cursor:pointer;min-width:0}.file-name{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:16px}.file-timestamp{font-size:12px;font-weight:300;color:#9A86A4}.delete-btn{background:transparent;border:none;cursor:pointer;padding:0;flex-shrink:0;width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background .2s,color .2s;color:#bbb;font-size:22px;font-weight:bold;line-height:1}.delete-btn:hover{background:#f0f0f0;color:#e53e3e}body.dark-mode .delete-btn{color:#889}body.dark-mode .delete-btn:hover{background:rgba(255,255,255,0.1);color:#fc8181}
        #settingsModal .modal-content,#addNavModal .modal-content, #syncModal .modal-content {max-width:400px}
        #settingsModal .modal-body .form-section,#addNavModal .modal-body .form-section{display:flex;flex-direction:column;gap:8px}#settingsModal label,#addNavModal label{font-size:14px;color:#5a6778}body.dark-mode #settingsModal label,body.dark-mode #addNavModal label{color:#c0c6cc}
        .nav-type-selector-wrapper { position: relative; } .nav-type-selector-wrapper input[name="nav-type"] { display: none; }
        .nav-type-selector { position: relative; display: flex; border-radius: 12px; padding: 5px; background:var(--bg-day); box-shadow: inset 4px 4px 8px var(--shadow-dark-day), inset -4px -4px 8px var(--shadow-light-day); } body.dark-mode .nav-type-selector { background:var(--bg-night); box-shadow: inset 4px 4px 8px var(--shadow-dark-night), inset -4px -4px 8px var(--shadow-light-night); }
        .nav-type-selector::before { content: ""; position: absolute; top: 5px; bottom: 5px; width: calc(50% - 5px); background: var(--bg-day); box-shadow: 4px 4px 8px var(--shadow-dark-day), -4px -4px 8px var(--shadow-light-day); border-radius: 8px; transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); z-index: 0; transform: translateX(0); } body.dark-mode .nav-type-selector::before { background: var(--bg-night); box-shadow: 4px 4px 8px var(--shadow-dark-night), -4px -4px 8px var(--shadow-light-night); }
        .nav-type-selector-wrapper #type-upload:checked ~ .nav-type-selector::before { transform: translateX(100%); }
        .nav-type-selector label { position: relative; z-index: 1; flex: 1; text-align: center; padding: 10px; border-radius: 8px; cursor: pointer; transition: color .3s ease; font-weight: 600; color: #889; } 
        .nav-type-selector-wrapper input[name="nav-type"]:checked + label { color: var(--hold-border); }
        #addNavModal .status-text{text-align:center;font-size:14px;color:#889;min-height:20px} #addNavModal .modal-header { gap: 10px; } #addNavModal .modal-title-group { flex-grow: 1; }
        .header-toggle-group { display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: normal; color: #5a6778; } body.dark-mode .header-toggle-group { color: #c0c6cc; }
        .file-select-wrapper { display: flex; align-items: center; gap: 10px; width: 100%; } .file-select-wrapper .modal-button { flex-shrink: 0; width: auto; padding: 10px 15px; font-size: 14px; }
        .file-select-wrapper .status-text { flex-grow: 1; font-size: 14px; color: #889; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #syncModal .file-upload-section { display: flex; flex-direction: column; gap: 10px; } #syncModal input[type="file"] { display: none; }
        #syncModal .progress-container { display: none; height: 12px; background-color: var(--bg-day); border-radius: 6px; box-shadow: inset 2px 2px 4px var(--shadow-dark-day), inset -2px -2px 4px var(--shadow-light-day); padding: 2px; } body.dark-mode #syncModal .progress-container { box-shadow: inset 2px 2px 4px var(--shadow-dark-night), inset -2px -2px 4px var(--shadow-light-night); }
        #syncModal .progress-bar { width: 0%; height: 100%; border-radius: 4px; background-color: #707899; transition: width 0.2s linear; }
        /* == Iframe Modal Styles == */
        .iframe-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .iframe-modal-overlay.active { transform: translateX(0); }
        .iframe-modal-content { width: 100%; height: 100%; background: #fff; box-shadow: -5px 0 15px rgba(0,0,0,0.2); transition: transform 0.3s ease-out; }
        .iframe-modal-content.dragging { transition: none; }
        .iframe-modal-content iframe { width: 100%; height: 100%; border: none; }
        .swipe-hint { position: fixed; left: 0; top: 50%; transform: translateY(-50%); display: flex; align-items: center; background: rgba(0,0,0,0.6); color: white; padding: 10px 15px 10px 10px; border-radius: 0 8px 8px 0; z-index: 2001; opacity: 0; transition: opacity 0.5s ease; pointer-events: none; }
        .swipe-hint.show { opacity: 1; }
        .swipe-hint .arrow { width: 16px; height: 16px; border-right: 3px solid white; border-bottom: 3px solid white; transform: rotate(-45deg); animation: hint-pulse 1.5s infinite; margin-right: 10px; }
        @keyframes hint-pulse { 0% { opacity: 0.3; } 50% { opacity: 1; transform: rotate(-45deg) scale(1.1); } 100% { opacity: 0.3; } }
        /* NEW: Invisible zone for gesture capture */
        #gestureCaptureZone {
            position: fixed;
            top: 0;
            left: 0;
            width: 50px; /* æ‰‹åŠ¿æ„Ÿåº”åŒºçš„å®½åº¦ */
            height: 100%;
            z-index: 2002; /* å¿…é¡»é«˜äºiframeå†…å®¹, ç¡®ä¿èƒ½æ•è·äº‹ä»¶ */
            /* background: rgba(255, 0, 0, 0.2); */ /* å–æ¶ˆæ³¨é‡Šå¯çœ‹åˆ°æ„Ÿåº”åŒº, ç”¨äºè°ƒè¯• */
        }
        @media (max-width: 480px) { .editable-title { font-size: 26px; } .editable-subtitle { font-size: 14px; } .title-card { padding: 30px 15px; } .nav-container { grid-template-columns: 1fr 1fr; gap: 18px; padding: 10px; } .nav-btn { padding: 18px 10px; font-size: 15px; } .fab-container { right: 20px; bottom: 20px; } .fab-main, .fab-drawer-item { width: 44px; height: 44px; font-size: 20px; } .fab-drawer { bottom: 55px; } }
    </style>
</head>
<body>
    <div class="page-overlay" id="pageOverlay"></div>
    <div class="title-card">
        <h1 class="editable-title" id="title">Jellyfishä¸­å¿ƒ</h1>
        <div class="editable-subtitle" id="subtitle">ç‚¹å‡»å³å¯è·³è½¬ | Byæ·¡å­£æ°´æ¯</div>
    </div>
    <div class="nav-container" id="navContainer">
        <p id="loading-status" style="text-align: center; color: #889; width: 100%;">æ­£åœ¨ä»äº‘ç«¯åŠ è½½é…ç½®...</p>
    </div>

    <div class="fab-container" id="fabContainer">
        <div class="fab-drawer" id="fabDrawer">
            <button class="fab-drawer-item" id="syncBtn" title="æ•°æ®äº‘ç›˜">â˜ï¸<span id="sync-status-indicator" title="äº‘åŒæ­¥çŠ¶æ€"></span></button>
            <button class="fab-drawer-item" id="addNavBtn" title="ç®¡ç†å°æ‰‹æœº">ğŸ“±</button>
            <button class="fab-drawer-item" id="colorBtn" title="ä¸»é¢˜è®¾ç½®">ğŸ¨</button>
        </div>
        <button class="fab-main theme-toggle" id="themeBtn" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ</button>
    </div>
    
    <!-- Modals -->
    <div class="modal-overlay" id="syncErrorModal"><div class="modal-content"><div class="modal-header"><div class="modal-title-group"><span>âš ï¸ åŒæ­¥å¤±è´¥</span></div><button class="close-btn" data-modal-id="syncErrorModal">&times;</button></div><div class="modal-body"><p>æ— æ³•è¿æ¥åˆ°äº‘ç«¯ã€‚è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥æˆ–GitHubé…ç½®ã€‚</p><p><strong>å¤±è´¥åŸå› :</strong></p><div id="sync-error-message"></div><button id="forceSyncBtn" class="modal-button" style="margin-top: 20px;">å¼ºåˆ¶åŒæ­¥</button></div></div></div>
    <div class="modal-overlay" id="addNavModal"><div class="modal-content"><div class="modal-header"><div class="modal-title-group"><span>ç®¡ç†å°æ‰‹æœº</span></div><div class="header-toggle-group"><span>è¿ç»­æ·»åŠ </span><label class="toggle-switch"><input type="checkbox" id="stayOpenToggle"><span class="slider"></span></label></div><button class="close-btn" data-modal-id="addNavModal">&times;</button></div><div class="modal-body"><button id="enterManageModeBtn" class="modal-button" style="color:#5a6778;">è¿›å…¥ç®¡ç†æ¨¡å¼</button><div class="nav-type-selector-wrapper"><input type="radio" id="type-link" name="nav-type" value="link" checked><label for="type-link">å¤–éƒ¨é“¾æ¥</label><input type="radio" id="type-upload" name="nav-type" value="upload"><label for="type-upload">ä¸Šä¼ é¡¹ç›®</label><div class="nav-type-selector"></div></div><div class="form-section"><label for="newButtonNameInput">æŒ‰é’®åç§°</label><input type="text" id="newButtonNameInput" class="modal-input" placeholder="ä¾‹å¦‚: æˆ‘çš„åšå®¢"></div><div id="link-section" class="form-section"><label for="newButtonUrlInput">ç½‘å€é“¾æ¥</label><input type="text" id="newButtonUrlInput" class="modal-input" placeholder="https://example.com"></div><div id="upload-section" class="form-section" style="display: none;"><label>é€‰æ‹©é¡¹ç›®æ–‡ä»¶å¤¹</label><div class="file-select-wrapper"><button id="folderPickerBtn" class="modal-button">é€‰æ‹©æ–‡ä»¶å¤¹</button><span id="folder-picker-status" class="status-text">æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶å¤¹</span></div></div><button id="createNavBtn" class="modal-button">åŠ å…¥æ–°æ‰‹æœº</button><div class="status-text" id="upload-status"></div></div></div></div>
    <div class="modal-overlay" id="syncModal"><div class="modal-content"><div class="modal-header"><div class="modal-title-group"><span>æ•°æ®äº‘ç›˜</span><button class="settings-btn" id="settingsBtn" title="è®¾ç½®GitHubä¿¡æ¯">âš™ï¸</button></div><button class="close-btn" data-modal-id="syncModal">&times;</button></div><div class="modal-body"><select id="buttonSelector" class="modal-select"></select><div class="file-upload-section"><input type="file" id="fileUploader"><div class="file-select-wrapper"><button id="selectFileBtn" class="modal-button">é€‰æ‹©æ–‡ä»¶</button><span id="selectedFileName" class="status-text">æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶</span></div><input type="text" id="fileNameInput" class="modal-input" placeholder="å¯ä¿®æ”¹æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰"><button id="uploadBtn" class="modal-button">ä¸Šä¼ æ–‡ä»¶</button><div id="progressContainer" class="progress-container"><div id="uploadProgressBar" class="progress-bar"></div></div></div><div id="file-list-container"><ul id="fileList"></ul><div id="fileListStatus" class="file-list-status">è¯·é€‰æ‹©ä¸€ä¸ªåˆ†ç±»</div></div></div></div></div>
    <div class="modal-overlay" id="settingsModal"><div class="modal-content"><div class="modal-header"><div class="modal-title-group"><span>GitHub é…ç½®</span></div><button class="close-btn" data-modal-id="settingsModal">&times;</button></div><div class="modal-body"><div class="form-section"><label for="githubRepoInput">ä»“åº“ (æ ¼å¼: ç”¨æˆ·å/ä»“åº“å)</label><input type="text" id="githubRepoInput" class="modal-input" placeholder="ä¾‹å¦‚: my-username/my-repo"></div><div class="form-section"><label for="githubTokenInput">Personal Access Token</label><input type="password" id="githubTokenInput" class="modal-input" placeholder="ghp_xxxxxxxxxx"></div><button id="saveSettingsBtn" class="modal-button">ä¿å­˜é…ç½®</button></div></div></div>
    <div class="modal-overlay" id="colorPaletteModal"><div class="modal-content"><div class="modal-header"><div class="modal-title-group"><span>ä¸»é¢˜è®¾ç½®</span></div><button class="close-btn" data-modal-id="colorPaletteModal">&times;</button></div><div class="modal-body"><div class="color-picker-grid"><div class="color-picker-group"><label>æ—¥é—´æ¨¡å¼ - æ¸å˜1</label><div class="color-input-wrapper"><input type="color" id="dayColor1Picker"><span class="hex-display" id="dayColor1Hex"></span></div></div><div class="color-picker-group"><label>æ—¥é—´æ¨¡å¼ - æ¸å˜2</label><div class="color-input-wrapper"><input type="color" id="dayColor2Picker"><span class="hex-display" id="dayColor2Hex"></span></div></div><div class="color-picker-group"><label>å¤œé—´æ¨¡å¼ - æ¸å˜1</label><div class="color-input-wrapper"><input type="color" id="nightColor1Picker"><span class="hex-display" id="nightColor1Hex"></span></div></div><div class="color-picker-group"><label>å¤œé—´æ¨¡å¼ - æ¸å˜2</label><div class="color-input-wrapper"><input type="color" id="nightColor2Picker"><span class="hex-display" id="nightColor2Hex"></span></div></div></div><div class="preview-container"><div class="preview-box" id="dayPreview" data-label="Day"></div><div class="preview-box" id="nightPreview" data-label="Night"></div></div><div class="preset-manager"><div class="preset-row"><input type="text" id="presetNameInput" class="modal-input" placeholder="ä¸ºå½“å‰é…è‰²å‘½å"><button id="savePresetBtn" class="modal-button save">ä¿å­˜</button><button id="updatePresetBtn" class="modal-button">æ›´æ–°</button></div><div class="preset-row"><select id="presetSelector" class="modal-select"></select><button id="deletePresetBtn" class="modal-button delete">åˆ é™¤</button></div></div><div class="random-toggle-section"><span>æ¯æ¬¡å¯åŠ¨æ—¶éšæœºåº”ç”¨é¢„è®¾</span><label class="toggle-switch"><input type="checkbox" id="randomPaletteToggle"><span class="slider"></span></label></div></div></div></div>

    <!-- == Iframe Modal for In-App Browser == -->
    <div class="iframe-modal-overlay" id="iframeModal">
        <div class="iframe-modal-content">
            <iframe id="iframeContent" src="about:blank" frameborder="0" allow="fullscreen" sandbox="allow-forms allow-modals allow-pointer-lock allow-popups allow-popups-to-escape-sandbox allow-presentation allow-same-origin allow-scripts"></iframe>
        </div>

        <!-- NEW: Invisible zone to capture the swipe-back gesture -->
        <div id="gestureCaptureZone"></div>

        <div class="swipe-hint" id="swipeHint">
            <div class="arrow"></div>
            <span>å‘å³æ»‘åŠ¨å…³é—­</span>
        </div>
    </div>


    <script>
    // [JS - V7.3.1 "Gesture Fix Update"]
    let GITHUB_CONFIG = {}, configSha = null, isManagementMode = false, isLongPress = false;
    let longPressTimer = null, sourceBtn = null, targetBtn = null, localDirectoryHandle = null;
    const navContainer = document.getElementById('navContainer'), pageOverlay = document.getElementById('pageOverlay');
    const syncStatusIndicator = document.getElementById('sync-status-indicator');
    const syncErrorModal = document.getElementById('syncErrorModal');
    // Iframe Modal Elements
    const iframeModal = document.getElementById('iframeModal');
    const iframeModalContent = iframeModal.querySelector('.iframe-modal-content');
    const iframeEl = document.getElementById('iframeContent');
    const swipeHint = document.getElementById('swipeHint');

    const getDefaultConfig = () => ({ title: 'Jellyfishä¸­å¿ƒ', subtitle: 'ç‚¹å‡»å³å¯è·³è½¬ | Byæ·¡å­£æ°´æ¯', buttons: [], themePresets: [] });
    let currentConfig = getDefaultConfig();
    
    const utf8_to_b64 = (str) => btoa(unescape(encodeURIComponent(str)));
    const b64_to_utf8 = (str) => decodeURIComponent(escape(atob(str)));

    let syncStatusTimeout;
    function updateSyncStatus(status, message = '') {
        syncStatusIndicator.className = status;
        syncStatusIndicator.title = message || `äº‘åŒæ­¥çŠ¶æ€: ${status}`;
        clearTimeout(syncStatusTimeout);
        if (status === 'synced') {
            syncStatusTimeout = setTimeout(() => {
                syncStatusIndicator.className = '';
                syncStatusIndicator.title = 'äº‘åŒæ­¥çŠ¶æ€: å·²åŒæ­¥';
            }, 3000);
            syncErrorModal.classList.remove('show');
        } else if (status === 'error') {
            document.getElementById('sync-error-message').textContent = message;
            syncErrorModal.classList.add('show');
        }
    }

    const withCacheBust = (url) => `${url}${url.includes('?') ? '&' : '?'}v=${Date.now()}`;
    
    async function fetchConfigFromGithub() {
        if (!checkConfig(false)) return getDefaultConfig();
        updateSyncStatus('syncing', 'æ­£åœ¨ä»äº‘ç«¯è¯»å–é…ç½®...');
        const url = withCacheBust(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/config.json`);
        try {
            const response = await fetch(url, { headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` } });
            if (response.status === 404) {
                console.log('Config.json not found. Auto-creating it now.'); configSha = null;
                await saveGlobalConfig('Auto-create initial config.json');
                return getDefaultConfig();
            }
            if (!response.ok) throw new Error(`${response.status}: ${response.statusText}`);
            const data = await response.json();
            configSha = data.sha;
            updateSyncStatus('synced', 'é…ç½®è¯»å–æˆåŠŸ');
            return JSON.parse(b64_to_utf8(data.content));
        } catch (error) {
            console.error('Failed to fetch config from GitHub:', error);
            updateSyncStatus('error', `è¯»å–å¤±è´¥: ${error.message}`);
            return getDefaultConfig();
        }
    }

    async function saveGlobalConfig(commitMessage) {
        if (!checkConfig(true)) { updateSyncStatus('error', 'é…ç½®ä¸å®Œæ•´ï¼Œæ— æ³•åŒæ­¥ã€‚'); return; }
        updateSyncStatus('syncing', `æ­£åœ¨åŒæ­¥: ${commitMessage}`);
        const url = withCacheBust(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/config.json`);
        const content = utf8_to_b64(JSON.stringify(currentConfig, null, 2));
        const body = { message: commitMessage, content: content, branch: 'main' };
        if (configSha) { body.sha = configSha; }
        try {
            const response = await fetch(url, { method: 'PUT', headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` }, body: JSON.stringify(body) });
            if (!response.ok) {
                 const errorData = await response.json().catch(() => ({ message: response.statusText }));
                 throw new Error(`${response.status}: ${errorData.message}`);
            }
            const data = await response.json();
            configSha = data.content.sha;
            console.log('Global configuration saved successfully.');
            updateSyncStatus('synced', 'åŒæ­¥æˆåŠŸï¼');
        } catch (error) {
            console.error('Failed to save config to GitHub:', error);
            updateSyncStatus('error', `å†™å…¥å¤±è´¥: ${error.message}`);
        }
    }
    document.getElementById('forceSyncBtn').addEventListener('click', () => saveGlobalConfig('Manual force sync'));
    
    function toggleManagementMode(forceState) { isManagementMode = forceState !== undefined ? forceState : !isManagementMode; pageOverlay.classList.toggle('show', isManagementMode); pageOverlay.classList.toggle('management-overlay', isManagementMode); document.body.classList.toggle('management-active', isManagementMode); document.querySelectorAll('.nav-btn').forEach(btn => { const deleteIcon = btn.querySelector('.delete-icon'); if (isManagementMode && !deleteIcon) { const icon = document.createElement('span'); icon.className = 'delete-icon'; icon.innerHTML = '&times;'; icon.title = 'åˆ é™¤æ­¤æŒ‰é’®'; btn.appendChild(icon); } else if (!isManagementMode && deleteIcon) { deleteIcon.remove(); } }); }
    pageOverlay.addEventListener('click', (e) => { if (isManagementMode && !e.target.closest('.nav-btn')) { toggleManagementMode(false); } if (fabContainer.classList.contains('active')) { toggleFabMenu(false); } });
    const fabContainer = document.getElementById('fabContainer'), fabMainBtn = document.getElementById('themeBtn');
    let fabPressTimer = null, isFabLongPress = false;
    function toggleFabMenu(forceState) { const isActive = forceState !== undefined ? forceState : !fabContainer.classList.contains('active'); fabContainer.classList.toggle('active', isActive); if (!isManagementMode) pageOverlay.classList.toggle('show', isActive); }
    fabMainBtn.addEventListener('mousedown', (e) => { e.preventDefault(); isFabLongPress = false; fabPressTimer = setTimeout(() => { isFabLongPress = true; toggleFabMenu(true); }, 300); });
    fabMainBtn.addEventListener('mouseup', () => { clearTimeout(fabPressTimer); if (!isFabLongPress) { fabContainer.classList.contains('active') ? toggleFabMenu(false) : toggleTheme(); } });
    fabMainBtn.addEventListener('contextmenu', e => e.preventDefault());
    fabMainBtn.addEventListener('touchstart', e => { e.preventDefault(); fabMainBtn.dispatchEvent(new MouseEvent('mousedown')); }, { passive: false });
    fabMainBtn.addEventListener('touchend', e => { e.preventDefault(); fabMainBtn.dispatchEvent(new MouseEvent('mouseup')); }, { passive: false });
    function clearHoldClass() { document.querySelectorAll('.nav-btn.hold').forEach(btn => btn.classList.remove('hold')); }
    async function swapButtons(a, b) { if (!a || !b || a === b) return; const parent = a.parentNode; const aNext = a.nextSibling; const bNext = b.nextSibling; if (aNext === b) { parent.insertBefore(b, a); } else if (bNext === a) { parent.insertBefore(a, b); } else { parent.insertBefore(b, aNext); parent.insertBefore(a, bNext); } updateButtonOrderAndSave('Reorder buttons'); }
    function updateButtonOrderAndSave(commitMessage) { const newOrder = []; document.querySelectorAll('.nav-btn').forEach(btn => newOrder.push({ text: btn.textContent.replace('Ã—', '').trim(), href: btn.dataset.href })); currentConfig.buttons = newOrder; saveGlobalConfig(commitMessage); }
    
    function attachButtonListeners(btn) {
        function startDrag(e) { /* ... existing drag logic ... */ }
        function endDrag() { /* ... existing drag logic ... */ }
        btn.addEventListener('mousedown', startDrag); btn.addEventListener('touchstart', startDrag);
        btn.addEventListener('mouseup', endDrag); btn.addEventListener('touchend', endDrag); btn.addEventListener('touchcancel', endDrag);

        btn.addEventListener('click', function(e) {
            if (isManagementMode || isLongPress) {
                e.preventDefault();
                return;
            }
            const href = this.dataset.href;
            if (!href) return;

            if (href.startsWith('http')) {
                e.preventDefault();
                openIframeModal(href);
            } else {
                window.location.href = href;
            }
        });
    }

    function detectTarget(e) { e.preventDefault(); const touch = e.type.startsWith('touch') ? e.touches[0] : e; const hoverBtn = document.elementFromPoint(touch.clientX, touch.clientY)?.closest('.nav-btn'); if (hoverBtn && hoverBtn !== sourceBtn) { if (targetBtn) targetBtn.classList.remove('hold'); targetBtn = hoverBtn; targetBtn.classList.add('hold'); } }
    document.getElementById('enterManageModeBtn').addEventListener('click', () => { document.getElementById('addNavModal').classList.remove('show'); setTimeout(() => toggleManagementMode(true), 150); });
    navContainer.addEventListener('click', async (e) => { if (!e.target.classList.contains('delete-icon')) return; const btnToDelete = e.target.closest('.nav-btn'); const buttonName = btnToDelete.textContent.replace('Ã—', '').trim(); if (!confirm(`ç¡®å®šè¦åˆ é™¤ "${buttonName}" å—ï¼Ÿ\nè­¦å‘Šï¼šå¦‚æœè¿™æ˜¯ä¸Šä¼ çš„é¡¹ç›®ï¼Œå…¶åœ¨GitHubä¸Šçš„æ•´ä¸ªæ–‡ä»¶å¤¹éƒ½å°†è¢«æ°¸ä¹…åˆ é™¤ï¼`)) return; btnToDelete.style.cssText = 'transition: all 0.3s ease; transform: scale(0.8); opacity: 0;'; setTimeout(async () => { btnToDelete.remove(); const href = btnToDelete.dataset.href; const isExternalLink = href.startsWith('http'); if (!isExternalLink && href.includes('/')) { const folderPath = href.substring(0, href.lastIndexOf('/')); const success = await deleteGithubFolder(folderPath); if (!success) { alert('åˆ é™¤äº‘ç«¯æ–‡ä»¶å¤¹å¤±è´¥!'); location.reload(); return; } } updateButtonOrderAndSave(`Delete button: ${buttonName}`); }, 300); });
    document.getElementById('title').addEventListener('click', () => { if(isManagementMode) return; const newTitle = prompt('æ–°æ ‡é¢˜ï¼š', currentConfig.title); if (newTitle?.trim() && newTitle.trim() !== currentConfig.title) { document.getElementById('title').textContent = newTitle.trim(); currentConfig.title = newTitle.trim(); saveGlobalConfig('Update main title'); } });
    document.getElementById('subtitle').addEventListener('click', () => { if(isManagementMode) return; const newSubtitle = prompt('æ–°æè¿°ï¼š', currentConfig.subtitle); if (newSubtitle !== null && newSubtitle.trim() !== currentConfig.subtitle) { document.getElementById('subtitle').textContent = newSubtitle.trim(); currentConfig.subtitle = newSubtitle.trim(); saveGlobalConfig('Update subtitle'); } });
    function initTheme() { const t=localStorage.getItem('theme'); if (t==='dark' || (!t && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.body.classList.add('dark-mode'); fabMainBtn.textContent = 'ğŸŒ™'; } else { fabMainBtn.textContent = 'ğŸŒ'; } }
    function toggleTheme() { document.body.classList.toggle('dark-mode'); const i=document.body.classList.contains('dark-mode'); fabMainBtn.textContent=i?'ğŸŒ™':'ğŸŒ'; localStorage.setItem('theme', i?'dark':'light'); };
    const colorModal = { pickerD1: document.getElementById('dayColor1Picker'), hexD1: document.getElementById('dayColor1Hex'), pickerD2: document.getElementById('dayColor2Picker'), hexD2: document.getElementById('dayColor2Hex'), pickerN1: document.getElementById('nightColor1Picker'), hexN1: document.getElementById('nightColor1Hex'), pickerN2: document.getElementById('nightColor2Picker'), hexN2: document.getElementById('nightColor2Hex'), presetName: document.getElementById('presetNameInput'), presetSelector: document.getElementById('presetSelector'), saveBtn: document.getElementById('savePresetBtn'), updateBtn: document.getElementById('updatePresetBtn'), deleteBtn: document.getElementById('deletePresetBtn'), randomToggle: document.getElementById('randomPaletteToggle'), dayPreview: document.getElementById('dayPreview'), nightPreview: document.getElementById('nightPreview') };
    const root = document.documentElement; function applyColors(colors, saveToLocal = true) { Object.entries(colors).forEach(([key, value]) => { const cssVar = `--${key.replace('Color', '-color')}`; root.style.setProperty(cssVar, value); if (saveToLocal) localStorage.setItem(key, value); }); updateColorUI(colors); }
    function updateColorUI(colors) { colorModal.pickerD1.value = colors.dayColor1; colorModal.hexD1.textContent = colors.dayColor1; colorModal.pickerD2.value = colors.dayColor2; colorModal.hexD2.textContent = colors.dayColor2; colorModal.pickerN1.value = colors.nightColor1; colorModal.hexN1.textContent = colors.nightColor1; colorModal.pickerN2.value = colors.nightColor2; colorModal.hexN2.textContent = colors.nightColor2; colorModal.dayPreview.style.background = `linear-gradient(135deg, ${colors.dayColor1}, ${colors.dayColor2})`; colorModal.nightPreview.style.background = `linear-gradient(135deg, ${colors.nightColor1}, ${colors.nightColor2})`; }
    function getCurrentColors(fromLocalStorage = true) { const source = fromLocalStorage ? localStorage : { getItem: (key) => getComputedStyle(root).getPropertyValue(`--${key.replace('Color', '-color')}`).trim() }; return { dayColor1: source.getItem('dayColor1') || '#f5f7fa', dayColor2: source.getItem('dayColor2') || '#e4eaf5', nightColor1: source.getItem('nightColor1') || '#1f2a40', nightColor2: source.getItem('nightColor2') || '#16213e', }; }
    function setupColorSync(picker, hexDisplay, key) { picker.addEventListener('input', () => { hexDisplay.textContent = picker.value; applyColors({ ...getCurrentColors(), [key]: picker.value }); }); }
    function loadColorState() { populatePresetDropdown(); const randomPaletteEnabled = localStorage.getItem('randomPaletteEnabled') === 'true'; colorModal.randomToggle.checked = randomPaletteEnabled; if (randomPaletteEnabled && currentConfig.themePresets && currentConfig.themePresets.length > 0) { const randomPreset = currentConfig.themePresets[Math.floor(Math.random() * currentConfig.themePresets.length)]; applyColors(randomPreset.colors); } else { applyColors(getCurrentColors()); } }
    function populatePresetDropdown() { colorModal.presetSelector.innerHTML = '<option value="">é€‰æ‹©ä¸€ä¸ªé¢„è®¾...</option>'; (currentConfig.themePresets || []).forEach((p, i) => { const opt = document.createElement('option'); opt.value = i; opt.textContent = p.name; colorModal.presetSelector.appendChild(opt); }); }
    colorModal.saveBtn.addEventListener('click', () => { const name = colorModal.presetName.value.trim(); if (!name) return alert('è¯·è¾“å…¥é¢„è®¾åç§°'); if ((currentConfig.themePresets || []).some(p => p.name === name)) return alert('é¢„è®¾åç§°å·²å­˜åœ¨'); if (!currentConfig.themePresets) currentConfig.themePresets = []; currentConfig.themePresets.push({ name, colors: getCurrentColors(false) }); saveGlobalConfig(`Save theme preset: ${name}`); populatePresetDropdown(); colorModal.presetSelector.value = currentConfig.themePresets.length - 1; colorModal.presetName.value = ''; });
    colorModal.updateBtn.addEventListener('click', () => { const index = colorModal.presetSelector.value; if (index === '' || !currentConfig.themePresets) return alert('è¯·é€‰æ‹©ä¸€ä¸ªé¢„è®¾'); const name = colorModal.presetName.value.trim() || currentConfig.themePresets[index].name; currentConfig.themePresets[index] = { name, colors: getCurrentColors(false) }; saveGlobalConfig(`Update theme preset: ${name}`); populatePresetDropdown(); colorModal.presetSelector.value = index; });
    colorModal.deleteBtn.addEventListener('click', () => { const index = colorModal.presetSelector.value; if (index === '' || !currentConfig.themePresets) return alert('è¯·é€‰æ‹©ä¸€ä¸ªé¢„è®¾'); const presetName = currentConfig.themePresets[index].name; if (!confirm(`ç¡®å®šåˆ é™¤äº‘ç«¯é¢„è®¾ "${presetName}"?`)) return; currentConfig.themePresets.splice(index, 1); saveGlobalConfig(`Delete theme preset: ${presetName}`); populatePresetDropdown(); });
    colorModal.presetSelector.addEventListener('change', () => { const index = colorModal.presetSelector.value; if (index === '' || !currentConfig.themePresets) return; applyColors(currentConfig.themePresets[index].colors); colorModal.presetName.value = currentConfig.themePresets[index].name; });
    colorModal.randomToggle.addEventListener('change', () => { localStorage.setItem('randomPaletteEnabled', colorModal.randomToggle.checked); });
    const syncModalElements = { buttonSelector: document.getElementById("buttonSelector"), fileList: document.getElementById("fileList"), fileListStatus: document.getElementById("fileListStatus"), fileUploader: document.getElementById("fileUploader"), selectFileBtn: document.getElementById("selectFileBtn"), selectedFileName: document.getElementById("selectedFileName"), fileNameInput: document.getElementById("fileNameInput"), uploadBtn: document.getElementById("uploadBtn"), progressContainer: document.getElementById("progressContainer"), progressBar: document.getElementById("uploadProgressBar"), githubRepoInput: document.getElementById("githubRepoInput"), githubTokenInput: document.getElementById("githubTokenInput"), saveSettingsBtn: document.getElementById("saveSettingsBtn") };
    function setupModals(){document.querySelectorAll(".close-btn").forEach(e=>e.addEventListener("click",()=>{document.getElementById(e.dataset.modalId).classList.remove("show")})),document.querySelectorAll(".modal-overlay").forEach(e=>e.addEventListener("click",t=>e===t.target&&e.classList.remove("show"))),document.getElementById("syncBtn").addEventListener("click",()=>{document.getElementById("syncModal").classList.add("show"),populateButtonSelector(),fetchFilesForSelectedButton(),toggleFabMenu(!1)}),document.getElementById("settingsBtn").addEventListener("click",()=>{GITHUB_CONFIG.owner&&GITHUB_CONFIG.repo&&(syncModalElements.githubRepoInput.value=`${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}`),syncModalElements.githubTokenInput.value=GITHUB_CONFIG.token||"",document.getElementById("settingsModal").classList.add("show")}),document.getElementById("addNavBtn").addEventListener("click",()=>{document.getElementById("addNavModal").classList.add("show"),toggleFabMenu(!1)}),document.getElementById("colorBtn").addEventListener("click",()=>{document.getElementById("colorPaletteModal").classList.add("show"),updateColorUI(getCurrentColors()),toggleFabMenu(!1)})}
    function saveGithubConfig(e){localStorage.setItem("githubConfig",JSON.stringify(e)),GITHUB_CONFIG=e}function loadGithubConfig(){const e=localStorage.getItem("githubConfig");e&&(GITHUB_CONFIG=JSON.parse(e))}function checkConfig(e=!0){return!GITHUB_CONFIG.owner||!GITHUB_CONFIG.repo||!GITHUB_CONFIG.token?(e&&alert("è¯·å…ˆé…ç½®GitHubä»“åº“ä¿¡æ¯ã€‚\n(æ‰“å¼€èœå• -> æ•°æ®äº‘ç›˜ -> æ ‡é¢˜æ—âš™ï¸)"),!1):!0}
    async function loadInitialData() { navContainer.innerHTML = '<p id="loading-status" style="text-align: center; color: #889;">æ­£åœ¨ä»äº‘ç«¯åŠ è½½é…ç½®...</p>'; const fetchedConfig = await fetchConfigFromGithub(); currentConfig = { ...getDefaultConfig(), ...fetchedConfig }; document.getElementById('title').textContent = currentConfig.title; document.getElementById('subtitle').textContent = currentConfig.subtitle; document.querySelector('.editable-title').style.opacity = 1; document.querySelector('.editable-subtitle').style.opacity = 1; navContainer.innerHTML = ''; if (!currentConfig.buttons || currentConfig.buttons.length === 0) { navContainer.innerHTML = '<p id="loading-status" style="text-align: center; color: #889;">é…ç½®ä¸ºç©ºï¼Œè¯·æ·»åŠ å¯¼èˆªæŒ‰é’®ã€‚</p>'; } else { currentConfig.buttons.forEach(item => addNewButtonToDOM(item.text, item.href, false)); } loadColorState(); }
    async function deleteGithubFolder(folderPath) { if (!checkConfig(true)) return false; const contentsUrl = withCacheBust(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${folderPath}`); try { const contentsResponse = await fetch(contentsUrl, { headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` } }); if (!contentsResponse.ok) throw new Error(`Could not list folder: ${contentsResponse.statusText}`); const files = await contentsResponse.json(); const deletePromises = files.map(file => fetch(withCacheBust(file.url), { method: 'DELETE', headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` }, body: JSON.stringify({ message: `Delete file: ${file.path}`, sha: file.sha, branch: 'main' }) })); await Promise.all(deletePromises); return true; } catch (error) { console.error(`Failed to delete folder "${folderPath}":`, error); return false; } }
    syncModalElements.saveSettingsBtn.addEventListener("click",async()=>{const[e,t]=syncModalElements.githubRepoInput.value.trim().split("/").map(e=>e.trim()),n=syncModalElements.githubTokenInput.value.trim();if(e&&t&&n){saveGithubConfig({owner:e,repo:t,token:n,branch:"main"}),alert("é…ç½®å·²ä¿å­˜ï¼åˆ·æ–°é¡µé¢åŠ è½½äº‘ç«¯é…ç½®ã€‚"),document.getElementById("settingsModal").classList.remove("show"),await loadInitialData()}else{alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ã€‚")}});function populateButtonSelector(){const e=syncModalElements.buttonSelector.value;syncModalElements.buttonSelector.innerHTML="",document.querySelectorAll(".nav-btn").forEach(t=>{const n=t.textContent.replace("Ã—","").trim(),o=document.createElement("option");o.value=o.textContent=n,syncModalElements.buttonSelector.appendChild(o)}),Array.from(syncModalElements.buttonSelector.options).some(t=>t.value===e)&&(syncModalElements.buttonSelector.value=e)}
    syncModalElements.buttonSelector.addEventListener("change",fetchFilesForSelectedButton); syncModalElements.selectFileBtn.addEventListener('click', () => syncModalElements.fileUploader.click());
    syncModalElements.fileUploader.addEventListener("change",()=>{ if(syncModalElements.fileUploader.files.length>0){ const file = syncModalElements.fileUploader.files[0]; syncModalElements.fileNameInput.value=file.name; syncModalElements.selectedFileName.textContent = file.name; } else { syncModalElements.selectedFileName.textContent = "æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶"; }});
    async function fetchFilesForSelectedButton(){const e=syncModalElements.buttonSelector.value;if(syncModalElements.fileList.innerHTML="",syncModalElements.fileListStatus.style.display="block",!e)return void(syncModalElements.fileListStatus.textContent="è¯·é€‰æ‹©ä¸€ä¸ªåˆ†ç±»");if(!checkConfig(!0))return void(syncModalElements.fileListStatus.innerHTML="å°šæœªé…ç½®GitHubä¿¡æ¯<br>è¯·ç‚¹å‡»æ ‡é¢˜æ— âš™ï¸");syncModalElements.fileListStatus.textContent="æ­£åœ¨åŠ è½½...";const t=withCacheBust(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/data_sync/${e}`);try{const n=await fetch(t,{headers:{"Authorization":`token ${GITHUB_CONFIG.token}`}});if(404===n.status)return void(syncModalElements.fileListStatus.textContent="è¯¥åˆ†ç±»ä¸‹æš‚æ— æ–‡ä»¶");if(!n.ok)throw new Error(`HTTP ${n.status}`);const o=await n.json();if(0===o.length)syncModalElements.fileListStatus.textContent="è¯¥åˆ†ç±»ä¸‹æš‚æ— æ–‡ä»¶";else{const l=await Promise.all(o.map(async e=>({...e,commitDate:await getLatestCommitDate(e.path)})));l.sort((e,t)=>new Date(t.commitDate)-new Date(e.commitDate)),syncModalElements.fileList.innerHTML="",syncModalElements.fileListStatus.style.display="none",l.forEach(e=>{const t=document.createElement("li"),n=document.createElement("div");n.className="file-info",n.dataset.downloadUrl=e.download_url,n.dataset.fileName=e.name;const o=document.createElement("span");o.className="file-name",o.textContent=e.name;const l=document.createElement("span");l.className="file-timestamp",l.textContent=(new Date(e.commitDate)).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),n.append(o,l);const a=document.createElement("button");a.className="delete-btn",a.innerHTML="&times;",a.title="åˆ é™¤æ–‡ä»¶",t.append(n,a),syncModalElements.fileList.appendChild(t),n.addEventListener("click",t=>forceDownload(t.currentTarget.dataset.downloadUrl,t.currentTarget.dataset.fileName,n)),a.addEventListener("click",()=>deleteFile(e.path,e.sha,t))})}}catch(n){console.error("è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:",n),syncModalElements.fileListStatus.textContent="åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é…ç½®ã€‚"}}
    async function getLatestCommitDate(e){const t=withCacheBust(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/commits?path=${encodeURIComponent(e)}&page=1&per_page=1`);try{const n=await fetch(t,{headers:{"Authorization":`token ${GITHUB_CONFIG.token}`}});if(!n.ok)return(new Date(0)).toISOString();const o=await n.json();return o[0]?.commit.committer.date||(new Date(0)).toISOString()}catch(n){return console.error(`Error fetching commit date for ${e}:`,n),(new Date(0)).toISOString()}}async function deleteFile(e,t,n){if(!confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤æ–‡ä»¶ "${e.split("/").pop()}" å—ï¼Ÿ`))return;n.style.opacity="0.5";const o=withCacheBust(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${e}`);try{const l=await fetch(o,{method:"DELETE",headers:{"Authorization":`token ${GITHUB_CONFIG.token}`},body:JSON.stringify({message:`Delete file: ${e}`,sha:t,branch:"main"})});if(!l.ok)throw new Error(`åˆ é™¤å¤±è´¥: ${(await l.json()).message}`);n.remove(),0===syncModalElements.fileList.children.length&&(syncModalElements.fileListStatus.textContent="è¯¥åˆ†ç±»ä¸‹æš‚æ— æ–‡ä»¶",syncModalElements.fileListStatus.style.display="block")}catch(l){console.error("åˆ é™¤æ–‡ä»¶å¤±è´¥:",l),alert(`åˆ é™¤æ–‡ä»¶å¤±è´¥: ${l.message}`),n.style.opacity="1"}}async function forceDownload(e,t,n){const o=n.querySelector(".file-name").textContent;n.querySelector(".file-name").textContent="å‡†å¤‡ä¸‹è½½...";n.style.pointerEvents="none";try{const l=await fetch(e);if(!l.ok)throw new Error(`ä¸‹è½½è¯·æ±‚å¤±è´¥: ${l.statusText}`);const a=await l.blob(),c=document.createElement("a");c.href=window.URL.createObjectURL(a),c.download=t,document.body.appendChild(c),c.click(),c.remove(),window.URL.revokeObjectURL(c.href)}catch(l){console.error("Download error:",l),alert(`ä¸‹è½½å‡ºé”™: ${l.message}`)}finally{n.querySelector(".file-name").textContent=o,n.style.pointerEvents="auto"}}
    function uploadFileWithProgress(url, fileContent, token, commitMessage) { return new Promise((resolve, reject) => { const body = { message: commitMessage, content: fileContent, branch: "main" }; const xhr = new XMLHttpRequest(); xhr.open("PUT", url, true); xhr.setRequestHeader("Authorization", `token ${token}`); xhr.setRequestHeader("Content-Type", "application/json"); xhr.upload.onprogress = (event) => { if (event.lengthComputable) { const percentComplete = (event.loaded / event.total) * 100; syncModalElements.progressBar.style.width = percentComplete + '%'; } }; xhr.onload = () => { if (xhr.status >= 200 && xhr.status < 300) { resolve(JSON.parse(xhr.responseText)); } else { reject(new Error(`ä¸Šä¼ å¤±è´¥: ${xhr.statusText} - ${xhr.responseText}`)); } }; xhr.onerror = () => reject(new Error("ç½‘ç»œé”™è¯¯ï¼Œä¸Šä¼ å¤±è´¥ã€‚")); xhr.send(JSON.stringify(body)); }); }
    syncModalElements.uploadBtn.addEventListener("click", async () => { if (!checkConfig()) return; const category = syncModalElements.buttonSelector.value; const file = syncModalElements.fileUploader.files[0]; let fileName = syncModalElements.fileNameInput.value.trim() || (file && file.name); if (!category || !file || !fileName) { return alert("è¯·é€‰æ‹©åˆ†ç±»ã€æ–‡ä»¶ï¼Œå¹¶ç¡®ä¿æ–‡ä»¶åä¸ä¸ºç©ºã€‚"); } syncModalElements.uploadBtn.disabled = true; syncModalElements.uploadBtn.textContent = "ä¸Šä¼ ä¸­..."; syncModalElements.progressContainer.style.display = 'block'; syncModalElements.progressBar.style.width = '0%'; try { const content = await fileToBase64(file); const url = withCacheBust(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/data_sync/${category}/${fileName}`); await uploadFileWithProgress(url, content, GITHUB_CONFIG.token, `Upload ${fileName}`); syncModalElements.uploadBtn.textContent = 'æ­£åœ¨å¤„ç†...'; setTimeout(() => { alert("ä¸Šä¼ æˆåŠŸï¼"); syncModalElements.fileUploader.value = ""; syncModalElements.fileNameInput.value = ""; syncModalElements.selectedFileName.textContent = 'æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶'; fetchFilesForSelectedButton(); }, 200); } catch (error) { console.error("ä¸Šä¼ å¤±è´¥:", error); alert(`ä¸Šä¼ å¤±è´¥: ${error.message}`); } finally { setTimeout(() => { syncModalElements.uploadBtn.disabled = false; syncModalElements.uploadBtn.textContent = "ä¸Šä¼ æ–‡ä»¶"; syncModalElements.progressContainer.style.display = 'none'; }, 1000); } });
    const addNavModalElements={typeLinkRadio:document.getElementById("type-link"),typeUploadRadio:document.getElementById("type-upload"),linkSection:document.getElementById("link-section"),uploadSection:document.getElementById("upload-section"),nameInput:document.getElementById("newButtonNameInput"),urlInput:document.getElementById("newButtonUrlInput"),folderPickerBtn:document.getElementById("folderPickerBtn"),folderStatus:document.getElementById("folder-picker-status"),createBtn:document.getElementById("createNavBtn"),uploadStatus:document.getElementById("upload-status"),stayOpenToggle:document.getElementById("stayOpenToggle")};
    function addNewButtonToDOM(text, href, save=true) { navContainer.querySelector("#loading-status")?.remove(); const btn = document.createElement("button"); btn.className = "nav-btn"; btn.textContent = text; btn.dataset.href = href; navContainer.appendChild(btn); attachButtonListeners(btn); if (isManagementMode) { const icon = document.createElement('span'); icon.className = 'delete-icon'; icon.innerHTML = '&times;'; icon.title = 'åˆ é™¤æ­¤æŒ‰é’®'; btn.appendChild(icon); } if (save) { if(!currentConfig.buttons) currentConfig.buttons = []; currentConfig.buttons.push({text, href}); saveGlobalConfig(`Add button: ${text}`); } }
    function resetAddNavForm() { addNavModalElements.nameInput.value = ""; addNavModalElements.urlInput.value = ""; addNavModalElements.folderStatus.textContent = "æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶å¤¹"; addNavModalElements.uploadStatus.textContent = ""; localDirectoryHandle = null; }
    addNavModalElements.typeLinkRadio.addEventListener("change",()=>{addNavModalElements.linkSection.style.display="flex",addNavModalElements.uploadSection.style.display="none"});addNavModalElements.typeUploadRadio.addEventListener("change",()=>{addNavModalElements.linkSection.style.display="none",addNavModalElements.uploadSection.style.display="flex"});
    (function initSlidingSelector() { const wrapper = document.querySelector('.nav-type-selector-wrapper'); const container = document.createElement('div'); container.className = 'nav-type-selector';const radios = wrapper.querySelectorAll('input[name="nav-type"]'); const labels = wrapper.querySelectorAll('label'); radios.forEach((radio, index) => {
        container.appendChild(labels[index]);
    }); wrapper.appendChild(container);})();
    addNavModalElements.folderPickerBtn.addEventListener("click",async()=>{if(!window.showDirectoryPicker)return void alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶å¤¹é€‰æ‹©ã€‚");try{localDirectoryHandle=await window.showDirectoryPicker(),addNavModalElements.folderStatus.textContent=`å·²é€‰æ‹©: ${localDirectoryHandle.name}`}catch(e){console.log("ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶å¤¹é€‰æ‹©")}});function fileToBase64(e){return new Promise((t,n)=>{const o=new FileReader;o.onload=()=>t(o.result.split(",")[1]),o.onerror=n,o.readAsDataURL(e)})}async function getFilesInDirectory(e,t=""){const n=[];for await(const o of e.values()){const l=t?`${t}/${o.name}`:o.name;if("file"===o.kind){const file=await o.getFile();n.push({file,path:l})}else"directory"===o.kind&&n.push(...await getFilesInDirectory(o,l))}return n}
    addNavModalElements.createBtn.addEventListener("click",async()=>{const e=addNavModalElements.nameInput.value.trim();if(!e)return void alert("è¯·è¾“å…¥æŒ‰é’®åç§°ã€‚");const t=document.querySelector('input[name="nav-type"]:checked').value;addNavModalElements.createBtn.disabled=!0,addNavModalElements.createBtn.textContent="å¤„ç†ä¸­...";try{let n;if("link"===t){const o=addNavModalElements.urlInput.value.trim();if(!o)return void alert("è¯·è¾“å…¥ç½‘å€é“¾æ¥ã€‚");n={text:e,href:o}}else if("upload"===t){if(!checkConfig())return;if(!localDirectoryHandle)return void alert("è¯·é€‰æ‹©ä¸€ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹ã€‚");const l=await getFilesInDirectory(localDirectoryHandle),path=e.toLowerCase().replace(/[^a-z0-9\u4e00-\u9fa5]/g,"").replace(/\s+/g,"-")||`project-${Date.now()}`;if(!l.some(e=>e.path.endsWith("index.html")))return void alert("é”™è¯¯ï¼šæ–‡ä»¶å¤¹ä¸­å¿…é¡»åŒ…å« index.html");for(let c=0;c<l.length;c++){const{file,path:subpath}=l[c];addNavModalElements.uploadStatus.textContent=`ä¸Šä¼ ä¸­ ${c+1}/${l.length}: ${subpath}`; const content_b64 = await fileToBase64(file); const u=withCacheBust(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}/${subpath}`); await uploadFileWithProgress(u, content_b64, GITHUB_CONFIG.token, `Create ${subpath}`);}addNavModalElements.uploadStatus.textContent="æ­£åœ¨å¤„ç†...";n={text:e,href:`${path}/index.html`};alert("é¡¹ç›®ä¸Šä¼ å‘å¸ƒæˆåŠŸï¼")} addNewButtonToDOM(n.text, n.href); resetAddNavForm(); if(!addNavModalElements.stayOpenToggle.checked) { document.getElementById("addNavModal").classList.remove("show"); } }catch(o){console.error("åˆ›å»ºå¤±è´¥:",o),alert(`æ“ä½œå¤±è´¥: ${o.message}`),addNavModalElements.uploadStatus.textContent="æ“ä½œå¤±è´¥!"}finally{addNavModalElements.createBtn.disabled=!1,addNavModalElements.createBtn.textContent="åŠ å…¥æ–°æ‰‹æœº"}});
    
    // == In-App Browser Logic ==
    function openIframeModal(url) {
        if (!localStorage.getItem('swipeHintShown')) {
            swipeHint.classList.add('show');
            setTimeout(() => {
                swipeHint.classList.remove('show');
                localStorage.setItem('swipeHintShown', 'true');
            }, 4000);
        }
        iframeEl.src = url;
        iframeModal.classList.add('active');
    }
    function closeIframeModal() {
        iframeModal.classList.remove('active');
        setTimeout(() => { iframeEl.src = 'about:blank'; }, 400); 
    }

    // == Corrected In-App Browser Gesture Logic ==
    const gestureCaptureZone = document.getElementById('gestureCaptureZone');

    let startX = 0;
    let currentX = 0;
    let isDragging = false;
    
    gestureCaptureZone.addEventListener('touchstart', (e) => {
        isDragging = true;
        startX = e.touches[0].clientX;
        iframeModalContent.classList.add('dragging'); 
    }, { passive: true });

    window.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
        currentX = e.touches[0].clientX;
        const diffX = currentX - startX;
        if (diffX > 0) {
            iframeModalContent.style.transform = `translateX(${diffX}px)`;
        }
    }, { passive: false }); 

    window.addEventListener('touchend', (e) => {
        if (!isDragging) return;
        isDragging = false;
        iframeModalContent.classList.remove('dragging'); 
        iframeModalContent.style.transform = ''; 

        const diffX = currentX - startX;
        const closeThreshold = window.innerWidth / 3.5; 

        if (diffX > closeThreshold) {
            closeIframeModal();
        }
        
        startX = 0;
        currentX = 0;
    });

    window.addEventListener('load', async () => {
        initTheme(); loadGithubConfig();
        await loadInitialData();
        setupModals();
        setupColorSync(colorModal.pickerD1, colorModal.hexD1, 'dayColor1'); setupColorSync(colorModal.pickerD2, colorModal.hexD2, 'dayColor2');
        setupColorSync(colorModal.pickerN1, colorModal.hexN1, 'nightColor1'); setupColorSync(colorModal.pickerN2, colorModal.hexN2, 'nightColor2');
    });
    </script>
</body>
</html>
