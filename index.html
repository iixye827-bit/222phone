<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0"> -->
<!-- <meta http-equiv="Pragma" content="no-cache"> -->
<!-- <meta http-equiv="Expires" content="0"> -->

    <!-- PWA & Mobile App Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#16213e">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <title>JellyfishCenter</title>
    <style>
        /* [CSS - V12.5.0 "Cascade Select"] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Arial', -apple-system, BlinkMacSystemFont, sans-serif; }
        :root {
            --day-color1: #f5f7fa; --day-color2: #e4eaf5;
            --night-color1: #1f2a40; --night-color2: #16213e;
            --hold-border: #5B99E2; --text-day: #2d3748; --text-night: #e0e6f0;
            --handle-color-day: #5a6778; --handle-color-night: #ffffff;
            --bg-day-element: linear-gradient(135deg, var(--day-color2), var(--day-color1));
            --bg-night-element: linear-gradient(135deg, var(--night-color2), var(--night-color1));
            --shadow-light-day: rgba(255, 255, 255, 0.9); --shadow-dark-day: rgba(174, 190, 212, 0.4);
            --shadow-light-night: rgba(40, 52, 79, 0.9); --shadow-dark-night: rgba(0, 0, 0, 0.3);
        }
        body { 
            min-height: 100vh; 
            background-color: var(--day-color1);
            background-image: linear-gradient(135deg, var(--day-color1) 0%, var(--day-color2) 100%); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            padding: 20px; 
            display: flex; flex-direction: column; align-items: center; 
            transition: background 0.5s ease; 
            touch-action: manipulation; overflow-x: hidden; 
        }
        body.dark-mode { 
            background-color: var(--night-color1);
            background-image: linear-gradient(135deg, var(--night-color1) 0%, var(--night-color2) 100%); 
            --hold-border: #63b3ed; color: var(--text-night); 
            --shadow-dark-night: rgba(0, 0, 0, 0.3);
        }
        body.dark-mode .nav-btn {
            box-shadow: 12px 12px 24px var(--shadow-dark-night), -12px -12px 24px var(--shadow-light-night);
        }
        body.dark-mode.theme-glass .nav-btn {
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }
        .title-card { width: 100%; max-width: 800px; padding: 40px 20px; margin: 20px 0; border-radius: 16px; box-shadow: 12px 12px 24px var(--shadow-dark-day), -12px -12px 24px var(--shadow-light-day); background: var(--bg-day-element); backdrop-filter: blur(8px); text-align: center; transition: all 0.5s ease; background-size: cover; background-position: center; }
        body.dark-mode .title-card { box-shadow: 12px 12px 24px var(--shadow-dark-night), -12px -12px 24px var(--shadow-light-night); background: var(--bg-night-element); }
        .editable-title, .editable-subtitle { opacity: 0; transition: opacity 0.5s ease; background-color: rgba(255,255,255,0.1); backdrop-filter: blur(4px); } /* FOUC Fix */
        .editable-title { font-size: 36px; font-weight: 700; color: var(--text-day); margin-bottom: 20px; cursor: pointer; padding: 6px 12px; border-radius: 8px; display: block; width: fit-content; margin: 0 auto 20px auto; user-select: none; }
        body.dark-mode .editable-title { color: var(--text-night); background-color: rgba(0,0,0,0.1); }
        .editable-title:hover { background-color: rgba(255, 255, 255, 0.8); } body.dark-mode .editable-title:hover { background-color: rgba(50, 55, 75, 0.8); }
        .editable-subtitle { font-size: 16px; color: #5a6778; cursor: pointer; padding: 4px 8px; border-radius: 6px; display: block; width: fit-content; margin: 0 auto; line-height: 1.5; user-select: none; }
        body.dark-mode .editable-subtitle { color: #c0c6cc; background-color: rgba(0,0,0,0.1); }
        .editable-subtitle:hover { background-color: rgba(255, 255, 255, 0.8); color: var(--text-day); } body.dark-mode .editable-subtitle:hover { background-color: rgba(50, 55, 75, 0.8); color: var(--text-night); }
        
        .category-nav-container { width: 100%; max-width: 1200px; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; padding: 10px 0; margin-bottom: 10px; }
        .category-nav-container::-webkit-scrollbar { display: none; }
        .category-nav { display: flex; flex-wrap: nowrap; gap: 12px; padding: 0 20px; }
        .category-pill { flex-shrink: 0; padding: 8px 18px; border: none; border-radius: 20px; background: var(--bg-day-element); box-shadow: none; color: var(--text-day); font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; opacity: 0.6; }
        body.dark-mode .category-pill { background: var(--bg-night-element); color: var(--text-night); }
        body:not(.theme-glass) .category-pill.active { background: var(--bg-day-element); color: var(--text-day); font-weight: 700; box-shadow: inset 4px 4px 8px var(--shadow-dark-day), inset -4px -4px 8px var(--shadow-light-day); opacity: 1; }
        body.dark-mode:not(.theme-glass) .category-pill.active { background: #000000; color: var(--text-night); box-shadow: inset 4px 4px 8px var(--shadow-dark-night), inset -4px -4px 8px var(--shadow-light-night); }
        body.theme-glass .category-pill.active { background: rgba(255, 255, 255, 0.4); border-color: rgba(255, 255, 255, 0.6); opacity: 1; transform: scale(1.05); color: #000; }
        body.dark-mode.theme-glass .category-pill.active { color: #fff; background: rgba(255, 255, 255, 0.2); border-color: rgba(255, 255, 255, 0.3); }

        .nav-container { width: 100%; max-width: 1200px; margin: 10px 0; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 25px; padding: 20px; position: relative; z-index: 10; touch-action: pan-y; }
        .nav-btn { position: relative; padding: 22px 16px; border: none; border-radius: 14px; box-shadow: 10px 10px 20px var(--shadow-dark-day), -10px -10px 20px var(--shadow-light-day); background: var(--bg-day-element); backdrop-filter: blur(8px); font-size: 17px; font-weight: 600; color: var(--text-day); cursor: pointer; transition: all 0.3s ease; text-align: center; user-select: none; -webkit-tap-highlight-color: transparent; }
        .nav-btn.hold { border: 2px solid var(--hold-border); transform: scale(1.02); z-index: 5; box-shadow: 8px 8px 16px rgba(174, 190, 212, 0.5), -8px -8px 16px rgba(255, 255, 255, 0.8), 0 0 0 2px rgba(91, 153, 226, 0.3); }
        body.dark-mode .nav-btn { box-shadow: 10px 10px 20px var(--shadow-dark-night), -10px -10px 20px var(--shadow-light-night); background: var(--bg-night-element); color: var(--text-night); }
        body.dark-mode .nav-btn:active { box-shadow: inset 6px 6px 12px rgba(0, 0, 0, 0.25), inset -6px -6px 12px var(--shadow-dark-night); }
        body.dark-mode .nav-btn.hold { box-shadow: 8px 8px 16px rgba(0, 0, 0, 0.4), -8px -8px 16px rgba(40, 52, 79, 0.8), 0 0 0 2px rgba(99, 179, 237, 0.3); }
        .nav-btn:hover { transform: translateY(-3px); filter: brightness(1.05); }
        .nav-btn:active { box-shadow: inset 6px 6px 12px var(--shadow-dark-day), inset -6px -6px 12px var(--shadow-light-day); transform: translateY(0); }
        body.dark-mode .nav-btn:active { box-shadow: inset 6px 6px 12px rgba(0, 0, 0, 0.25), inset -6px -6px 12px rgba(40, 52, 79, 0.8); }
        .delete-icon { display: none; position: absolute; top: -5px; right: -5px; width: 24px; height: 24px; background-color: #f56565; color: white; border-radius: 50%; border: 2px solid white; font-size: 16px; font-weight: bold; line-height: 20px; text-align: center; cursor: pointer; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .page-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(2px); z-index: 99; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .page-overlay.show { opacity: 1; pointer-events: auto; }
        .page-overlay.management-overlay { background: transparent; backdrop-filter: none; z-index: 5; }
        .management-active .nav-btn { animation: wiggle 0.2s ease-in-out infinite alternate; pointer-events: auto !important; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
        .management-active .nav-btn > .delete-icon { display: block; }
        @keyframes wiggle { from { transform: rotate(-0.5deg); } to { transform: rotate(0.5deg); } }
        .fab-container { position: fixed; right: 30px; bottom: 30px; z-index: 100; }
        .fab-main, .fab-drawer-item { position: relative; width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); box-shadow: 4px 4px 8px var(--shadow-dark-day), -4px -4px 8px var(--shadow-light-day); background: var(--bg-day-element); color: var(--text-day); font-size: 22px; display: flex; align-items: center; justify-content: center; user-select: none; -webkit-tap-highlight-color: transparent; }
        body.dark-mode .fab-main, body.dark-mode .fab-drawer-item { box-shadow: 4px 4px 8px var(--shadow-dark-night), -4px -4px 8px var(--shadow-light-night); background: var(--bg-night-element); color: var(--text-night); }
        .fab-main:active, .fab-drawer-item:active { transform: scale(0.95); }
        .fab-container.active .fab-main { transform: rotate(45deg); }
        .fab-drawer { position: absolute; bottom: 65px; left: 0; display: flex; flex-direction: column; gap: 15px; opacity: 0; transform: translateY(20px); transition: opacity 0.2s ease-out, transform 0.2s ease-out; pointer-events: none; }
        .fab-container.active .fab-drawer { opacity: 1; transform: translateY(0); pointer-events: auto; }
        #sync-status-indicator { position: absolute; right: 5px; top: 5px; width: 10px; height: 10px; border-radius: 50%; background-color: transparent; transition: all 0.3s ease; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        #sync-status-indicator.synced { background-color: #28a745; } #sync-status-indicator.syncing { background-color: #ffc107; animation: pulse 1.5s infinite; } #sync-status-indicator.error { background-color: #dc3545; animation: none; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);backdrop-filter:blur(5px);display:none;align-items:center;justify-content:center;z-index:1000;opacity:0;transition:opacity .3s ease}.modal-overlay.show{display:flex;opacity:1}.modal-content{width:90%;background:var(--bg-day-element);color:var(--text-day);border-radius:16px;box-shadow:12px 12px 24px var(--shadow-dark-day),-12px -12px 24px var(--shadow-light-day);padding:12px;transition:transform .3s ease,background .5s ease,box-shadow .5s ease;transform:scale(.95);display:flex;flex-direction:column;max-height:90vh}.modal-overlay.show .modal-content{transform:scale(1)}body.dark-mode .modal-content{background:var(--bg-night-element);color:var(--text-night);box-shadow:12px 12px 24px var(--shadow-dark-night),-12px -12px 24px var(--shadow-light-night)}.modal-header{display:flex;justify-content:space-between;align-items:center;font-size:20px;font-weight:600;margin-bottom:20px;flex-shrink:0; padding: 0 3px;}.modal-title-group{display:flex;align-items:center;gap:8px}.modal-header .close-btn,.modal-header .settings-btn{cursor:pointer;border:none;background:transparent;color:inherit;padding:5px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:background .2s ease}.modal-header .close-btn{font-size:24px;font-weight:bold;width:36px;height:36px}.modal-header .settings-btn{font-size:20px;width:32px;height:32px}.modal-header .close-btn:hover,.modal-header .settings-btn:hover{background:rgba(0,0,0,0.05)}body.dark-mode .modal-header .close-btn:hover,body.dark-mode .modal-header .settings-btn:hover{background:rgba(255,255,255,0.08)}
        .modal-body { overflow-y: auto; overflow-x: hidden; flex-grow: 1; display:flex; flex-direction:column; gap: 15px; margin-right: -5px; padding-right: 5px; scrollbar-width: none; -ms-overflow-style: none; }
        .modal-body > * { margin-left: 3px; margin-right: 3px; width: calc(100% - 6px); }
        .modal-body::-webkit-scrollbar { width: 0; background: transparent; }
        .modal-input,.modal-select,.modal-textarea{padding:12px 15px;border:none;border-radius:10px;font-size:16px;background:var(--bg-day-element);color:var(--text-day);box-shadow:inset 4px 4px 8px var(--shadow-dark-day),inset -4px -4px 8px var(--shadow-light-day);transition:all .3s ease;caret-color:var(--hold-border)}body.dark-mode .modal-input,body.dark-mode .modal-select,body.dark-mode .modal-textarea{background:var(--bg-night-element);color:var(--text-night);box-shadow:inset 4px 4px 8px var(--shadow-dark-night),inset -4px -4px 8px var(--shadow-light-night)}.modal-input:focus,.modal-select:focus,.modal-textarea:focus{outline:none;box-shadow:inset 4px 4px 8px var(--shadow-dark-day),inset -4px -4px 8px var(--shadow-light-day),0 0 0 2px var(--hold-border)}body.dark-mode .modal-input:focus,body.dark-mode .modal-select:focus,body.dark-mode .modal-textarea:focus{box-shadow:inset 4px 4px 8px var(--shadow-dark-night),inset -4px -4px 8px var(--shadow-light-night),0 0 0 2px var(--hold-border)} .modal-textarea{resize:vertical;min-height:80px;}
        .modal-button{padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;color:var(--hold-border);background:var(--bg-day-element);box-shadow:4px 4px 8px var(--shadow-dark-day),-4px -4px 8px var(--shadow-light-day);transition:all .2s ease}body.dark-mode .modal-button{color:var(--hold-border);background:var(--bg-night-element);box-shadow:4px 4px 8px var(--shadow-dark-night),-4px -4px 8px var(--shadow-light-night)}.modal-button:active{box-shadow:inset 4px 4px 8px var(--shadow-dark-day),inset -4px -4px 8px var(--shadow-light-day)}body.dark-mode .modal-button:active{box-shadow:inset 4px 4px 8px var(--shadow-dark-night),inset -4px -4px 8px var(--shadow-light-night)}.modal-button:disabled{color:#9db2c2;cursor:not-allowed;box-shadow:none;}
        #nukeDataBtn { background: #e53e3e !important; color: white !important; box-shadow: 4px 4px 8px rgba(229, 62, 62, 0.5), -4px -4px 8px rgba(255, 255, 255, 0.9) !important; }
        #nukeDataBtn:active { background: #c53030 !important; box-shadow: inset 4px 4px 8px rgba(155, 37, 37, 0.7) !important; }
        #settingsModal .modal-body .nuke-section { margin: 15px 0 10px; border-top: 1px solid rgba(128,128,128,0.3); padding-top: 15px; display: flex; justify-content: center; }
        #syncErrorModal .modal-content { max-width: 450px; } #sync-error-message { padding: 12px; border-radius: 8px; background: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.2); font-family: monospace; font-size: 14px; word-wrap: break-word; user-select: text; } body.dark-mode #sync-error-message { background: rgba(252, 129, 129, 0.1); border-color: rgba(252, 129, 129, 0.2); }
        #colorPaletteModal .modal-content, #helpModal .modal-content { max-width: 500px; } 
        .theme-style-selector { border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 20px; margin-bottom: 20px; } body.dark-mode .theme-style-selector { border-color: rgba(255,255,255,0.1); }
        .theme-style-selector label { font-size: 14px; color: #5a6778; display: block; margin-bottom: 8px; } body.dark-mode .theme-style-selector label { color: #c0c6cc; }
        #pneumorphism-settings.hidden { display: none; }
        #colorPaletteModal .modal-body { gap: 20px; padding-bottom: 15px; }
        .color-picker-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; } .color-picker-group { display: flex; flex-direction: column; gap: 8px; }
        .color-picker-group label { font-size: 14px; color: #5a6778; } body.dark-mode .color-picker-group label { color: #c0c6cc; }
        .color-input-wrapper { display: flex; align-items: center; border-radius: 10px; padding: 5px; background:var(--bg-day-element); box-shadow: inset 4px 4px 8px var(--shadow-dark-day), inset -4px -4px 8px var(--shadow-light-day); } body.dark-mode .color-input-wrapper { background:var(--bg-night-element); box-shadow: inset 4px 4px 8px var(--shadow-dark-night), inset -4px -4px 8px var(--shadow-light-night); }
        input[type="color"] { width: 36px; height: 30px; border: none; background: transparent; cursor: pointer; -webkit-appearance: none; padding: 0; flex-shrink: 0; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; } input[type="color"]::-webkit-color-swatch { border-radius: 6px; border: none; }
        .hex-display { flex-grow: 1; text-align: right; padding: 0 10px; font-family: monospace; font-size: 16px; color: #889; }
        .preview-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; } .preview-box { height: 40px; border-radius: 8px; position: relative; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .preview-box::before { content: attr(data-label); } #dayPreview { border: 2px solid var(--bg-day-element); color: var(--text-day); } body.dark-mode #dayPreview { border-color: rgba(255,255,255,0.1); }
        #nightPreview { border: 2px solid var(--bg-night-element); color: var(--text-night); } body.dark-mode #nightPreview { border-color: rgba(255,255,255,0.2); }
        .preset-manager, .background-image-manager { border-top: 1px solid rgba(0,0,0,0.1); padding-top: 20px; display: flex; flex-direction: column; gap: 15px; }
        body.dark-mode .preset-manager, body.dark-mode .background-image-manager { border-color: rgba(255,255,255,0.1); } 
        .preset-row, .background-image-row { display: flex; align-items: center; gap: 10px; }
        .preset-row .modal-input, .preset-row .modal-select { flex-grow: 1; }
        .preset-row .modal-button, .background-image-row .modal-button { width: auto; padding: 12px 15px; flex-shrink: 0; font-size: 14px; }
        .preset-row .modal-button.save { color: #28a745; } .preset-row .modal-button.delete, .background-image-row .modal-button.delete { color: #dc3545; }
        .background-image-row .status { flex-grow: 1; font-size: 12px; color: #889; text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .toggle-section { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-radius: 12px; background:var(--bg-day-element); box-shadow: inset 4px 4px 8px var(--shadow-dark-day), inset -4px -4px 8px var(--shadow-light-day); }
        body.dark-mode .toggle-section { background:var(--bg-night-element); box-shadow: inset 4px 4px 8px var(--shadow-dark-night), inset -4px -4px 8px var(--shadow-light-night); }
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 22px; } .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; } .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--hold-border); } input:checked + .slider:before { transform: translateX(18px); }
        
        #projectSelector.hidden { display: none; }
        #settingsModal .modal-content,#addNavModal .modal-content, #musicSettingsModal .modal-content {max-width:400px}
        #settingsModal .modal-body .form-section,#addNavModal .modal-body .form-section{display:flex;flex-direction:column;gap:8px}#settingsModal label,#addNavModal label{font-size:14px;color:#5a6778}body.dark-mode #settingsModal label,body.dark-mode #addNavModal label{color:#c0c6cc}
        .segmented-control { position: relative; display: flex; border-radius: 12px; padding: 5px; background:var(--bg-day-element); box-shadow: inset 4px 4px 8px var(--shadow-dark-day), inset -4px -4px 8px var(--shadow-light-day); }
        body.dark-mode .segmented-control { background:var(--bg-night-element); box-shadow: inset 4px 4px 8px var(--shadow-dark-night), inset -4px -4px 8px var(--shadow-light-night); }
        .segmented-control label { position: relative; z-index: 1; flex: 1; text-align: center; padding: 10px; border-radius: 8px; cursor: pointer; transition: color .3s ease; font-weight: 600; }
        .segmented-control .slider-indicator { position: absolute; top: 5px; left: 5px; bottom: 5px; background: var(--bg-day-element); box-shadow: 4px 4px 8px var(--shadow-dark-day), -4px -4px 8px var(--shadow-light-day); border-radius: 8px; transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); z-index: 0; }
        body.dark-mode .segmented-control .slider-indicator { background: var(--bg-night-element); box-shadow: 4px 4px 8px var(--shadow-dark-night), -4px -4px 8px var(--shadow-light-night); }
        #addNavModal input[type="radio"]:checked + label, #helpModal input[type="radio"]:checked + label, #colorPaletteModal input[type="radio"]:checked + label { color: var(--hold-border); }
        #type-upload:checked ~ .slider-indicator { transform: translateX(100%); }
        #theme-style-glass:checked ~ .slider-indicator { transform: translateX(100%); }
        .segmented-control.two-segments .slider-indicator { width: calc(50% - 5px); }
        .segmented-control.three-segments .slider-indicator { width: calc(33.33% - 4px); }
        #addNavModal .status-text{text-align:center;font-size:14px;color:#889;min-height:20px} #addNavModal .modal-header { gap: 10px; } #addNavModal .modal-title-group { flex-grow: 1; }
        .header-toggle-group { display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: normal; color: #5a6778; } body.dark-mode .header-toggle-group { color: #c0c6cc; }
        .file-select-wrapper { display: flex; align-items: center; gap: 10px; width: 100%; } .file-select-wrapper .modal-button { flex-shrink: 0; width: auto; padding: 10px 15px; font-size: 14px; }
        .file-select-wrapper .status-text { flex-grow: 1; font-size: 14px; color: #889; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-upload-section { display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; } input[type="file"] { display: none; }
        .progress-container { display: none; height: 12px; background:var(--bg-day-element); border-radius: 6px; box-shadow: inset 2px 2px 4px var(--shadow-dark-day), inset -2px -2px 4px var(--shadow-light-day); padding: 2px; } body.dark-mode .progress-container { box-shadow: inset 2px 2px 4px var(--shadow-dark-night), inset -2px -2px 4px var(--shadow-light-night); }
        .progress-bar { width: 0%; height: 100%; border-radius: 4px; background-color: #707899; transition: width 0.2s linear; }
        #helpModal .modal-body { gap: 0; padding-top: 15px; } #helpModal .modal-body > input[name="help-tab"] { display: none; } 
        .help-page-content { display: none; padding: 15px 5px 0 5px; overflow-x: hidden; }
        .help-page-content h3 { font-size: 1.3em; margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid rgba(128,128,128,0.3); } .help-page-content h4 { font-size: 1.1em; margin: 18px 0 8px 0; }
        .help-page-content p, .help-page-content li, .help-page-content a { line-height: 1.7; color: #4a5568; margin-bottom: 8px; word-wrap: break-word; }
        body.dark-mode .help-page-content p, body.dark-mode .help-page-content li, body.dark-mode .help-page-content a { color: #a0aec0; }
        .help-page-content ul, .help-page-content ol { padding-left: 25px; } .help-page-content ol li { margin-bottom: 12px; }
        .help-page-content strong { color: var(--hold-border); font-weight: 600; } .help-page-content code { background-color: rgba(128,128,128,0.15); padding: 2px 5px; border-radius: 4px; font-family: monospace; word-wrap: break-word; }
        .help-page-content a { color: var(--hold-border); text-decoration: none; font-weight: 600; } .help-page-content a:hover { text-decoration: underline; }
        .help-page-content .warning { background-color: rgba(229, 62, 62, 0.1); border-left: 4px solid #e53e3e; padding: 10px 15px; margin: 15px 0; border-radius: 0 8px 8px 0; }
        .help-page-content .important-note { background-color: rgba(91, 153, 226, 0.1); border-left: 4px solid var(--hold-border); padding: 10px 15px; margin: 15px 0; border-radius: 0 8px 8px 0; }
        /* == Iframe Modal & Confirmation Toast Styles == */
        .iframe-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .iframe-modal-overlay.active { transform: translateX(0); }
        .iframe-modal-content { width: 100%; height: 100%; background: #fff; box-shadow: -5px 0 15px rgba(0,0,0,0.2); transition: transform 0.3s ease-out; }
        .iframe-modal-content.dragging { transition: none; }
        .iframe-modal-content iframe { width: 100%; height: 100%; border: none; }
        .swipe-hint { position: fixed; left: 0; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; align-items: center; background: rgba(0,0,0,0.6); color: white; padding: 15px 8px; border-radius: 0 8px 8px 0; z-index: 2001; opacity: 0; transition: opacity 0.5s ease; pointer-events: none; }
        .swipe-hint.show { opacity: 1; }
        .swipe-hint .arrow { width: 16px; height: 16px; border-right: 3px solid white; border-bottom: 3px solid white; transform: rotate(-45deg); animation: hint-pulse 1.5s infinite; margin-bottom: 10px; }
        .swipe-hint span { writing-mode: vertical-rl; }
        @keyframes hint-pulse { 0% { opacity: 0.3; } 50% { opacity: 1; transform: rotate(-45deg) scale(1.1); } 100% { opacity: 0.3; } }
        #gestureCaptureZone { position: fixed; top: 50%; left: 0; width: 20px; height: 200px; transform: translateY(-50%); z-index: 2002; } /* REFINED: Gesture Area */
        #returnConfirmationToast { position: fixed; top: 0; left: 50%; transform: translate(-50%, -120%); width: calc(100% - 30px); max-width: 400px; background: var(--bg-night-element); color: var(--text-night); padding: 12px 16px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 2003; display: flex; justify-content: space-between; align-items: center; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); user-select: none; }
        #returnConfirmationToast.show { transform: translate(-50%, 0); }
        .toast-btn { background: transparent; border: none; color: white; font-size: 15px; font-weight: 600; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
        .toast-btn-confirm { background-color: rgba(99, 179, 237, 0.8); } .toast-btn-confirm:hover { background-color: rgba(99, 179, 237, 1); }
        .toast-btn-cancel { background-color: rgba(255, 255, 255, 0.2); } .toast-btn-cancel:hover { background-color: rgba(255, 255, 255, 0.3); }
        @media (max-width: 480px) { .editable-title { font-size: 28px; } .editable-subtitle { font-size: 14px; } .title-card { padding: 30px 15px; } .nav-container { grid-template-columns: 1fr 1fr; gap: 18px; padding: 10px; } .nav-btn { padding: 18px 10px; font-size: 15px; } .fab-container { right: 20px; bottom: 20px; } .fab-main, .fab-drawer-item { width: 44px; height: 44px; font-size: 20px; } .fab-drawer { bottom: 55px; } .segmented-control label { font-size: 13px; padding: 8px 5px; } .category-nav { padding: 0 15px; } }
        
        /* ===== [START] MEMORY MODAL STYLES ===== */
        #memoryModal .modal-content { max-width: 800px; height: calc(100vh - 40px); padding: 0; display: flex; flex-direction: column; overflow: hidden; }
        #memoryModal .modal-header { padding: 0 15px; margin-top: 15px; margin-bottom: 10px; }
        #memoryModal .app-container { width: 100%; flex-grow: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        #memoryModal .page { width: 100%; height: 100%; display: none; flex-direction: column; position: absolute; top: 0; left: 0; opacity: 0; transform: scale(0.98); transition: opacity 0.3s ease, transform 0.3s ease; pointer-events: none; }
        #memoryModal .page.active { display: flex; opacity: 1; transform: scale(1); pointer-events: auto; z-index: 10; }
        #memoryModal .page-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; flex-shrink: 0; position: relative; }
        #memoryModal .page-header .title { position: absolute; left: 50%; transform: translateX(-50%); font-size: 20px; font-weight: 700; white-space: nowrap; }
        #memoryModal .header-btn { font-size: 16px; font-weight: 600; cursor: pointer; padding: 8px 12px; border-radius: 10px; transition: background-color 0.2s; border: none; background: transparent; color: inherit; z-index: 5; }
        #memoryModal .header-btn:hover { background-color: rgba(0,0,0,0.05); } body.dark-mode #memoryModal .header-btn:hover { background-color: rgba(255,255,255,0.1); }
        #memoryModal .header-btn.back-btn { font-size: 24px; padding: 5px 10px; }
        #memoryModal .header-btn.manage-btn { color: var(--hold-border); }
        #memoryModal .header-btn.wander-btn { font-size: 20px; padding: 6px; }
        #memoryModal .header-controls { display: flex; gap: 8px; align-items:center; }
        #memoryModal .list-container { flex-grow: 1; overflow-y: auto; padding: 0 15px 80px 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; align-content: flex-start; }
        #memoryModal #hub-view-content { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 30px; }
        #memoryModal .hub-btn { width: 80%; max-width: 300px; padding: 40px 20px; border: none; border-radius: 20px; box-shadow: 10px 10px 20px var(--shadow-dark-day), -10px -10px 20px var(--shadow-light-day); background: var(--bg-day-element); color: var(--text-day); font-size: 24px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        body.dark-mode #memoryModal .hub-btn { box-shadow: 10px 10px 20px var(--shadow-dark-night), -10px -10px 20px var(--shadow-light-night); background: var(--bg-night-element); color: var(--text-night); }
        #memoryModal .hub-btn:active { box-shadow: inset 6px 6px 12px var(--shadow-dark-day), inset -6px -6px 12px var(--shadow-light-day); } body.dark-mode #memoryModal .hub-btn:active { box-shadow: inset 6px 6px 12px var(--shadow-dark-night), inset -6px -6px 12px var(--shadow-light-night); }
        #memoryModal #notes-list-container { grid-template-columns: 1fr; }
        #memoryModal .folder-item, #memoryModal .album-item { margin-bottom: 10px; position: relative; padding: 20px 15px; border: none; border-radius: 14px; box-shadow: 8px 8px 16px var(--shadow-dark-day), -8px -8px 16px var(--shadow-light-day); background: var(--bg-day-element); font-size: 16px; font-weight: 600; color: var(--text-day); cursor: pointer; transition: all 0.3s ease; user-select: none; -webkit-tap-highlight-color: transparent; text-align: left; }
        #memoryModal .note-item { position: relative; padding: 20px 15px; border: none; border-radius: 14px; box-shadow: 8px 8px 16px var(--shadow-dark-day), -8px -8px 16px var(--shadow-light-day); background: var(--bg-day-element); font-size: 16px; color: var(--text-day); cursor: pointer; transition: all 0.3s ease; user-select: none; -webkit-tap-highlight-color: transparent; text-align: left; }
        body.dark-mode #memoryModal .folder-item, body.dark-mode #memoryModal .note-item, body.dark-mode #memoryModal .album-item { box-shadow: 8px 8px 16px var(--shadow-dark-night), -8px -8px 16px var(--shadow-light-night); background: var(--bg-night-element); color: var(--text-night); }
        #memoryModal .folder-item:active, #memoryModal .note-item:active, #memoryModal .album-item:active { box-shadow: inset 4px 4px 8px var(--shadow-dark-day), inset -4px -4px 8px var(--shadow-light-day); transform: translateY(0); }
        body.dark-mode #memoryModal .folder-item:active, body.dark-mode #memoryModal .note-item:active, body.dark-mode #memoryModal .album-item:active { box-shadow: inset 4px 4px 8px var(--shadow-dark-night), inset -4px -4px 8px var(--shadow-light-night); }
        #memoryModal .folder-icon { font-size: 24px; margin-bottom: 10px; }
        #memoryModal .note-title { font-size: 18px; font-weight: bold; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #memoryModal .note-preview { font-size: 14px; font-weight: normal; color: #6a7889; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        body.dark-mode #memoryModal .note-preview { color: #a0aec0; }
        #memoryModal .note-timestamp { font-size: 12px; font-weight: 300; color: #9A86A4; margin-top: 12px; }
        #memoryModal .album-item { aspect-ratio: 1 / 1; display: flex; flex-direction: column; justify-content: space-between; align-items: flex-start; }
        #memoryModal .album-item .folder-icon { font-size: 32px; }
        #memoryModal .album-info { font-size: 12px; color: #889; }
        #memoryModal #photo-list-container { grid-template-columns: repeat(3, 1fr); gap: 15px; }
        #memoryModal .photo-item, .photo-item-set { position: relative; width: 100%; aspect-ratio: 1 / 1; border-radius: 12px; overflow: hidden; box-shadow: inset 2px 2px 4px rgba(0,0,0,0.1), inset -2px -2px 4px rgba(255,255,255,0.7); cursor: pointer; transition: transform 0.2s ease; background-color: rgba(128,128,128,0.1); }
        #memoryModal .photo-item img, .photo-item-set img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
        .photo-item-set .photo-stack-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: transform 0.3s ease; border: 2px solid var(--bg-day-element); }
        body.dark-mode .photo-item-set .photo-stack-img { border-color: var(--bg-night-element); }
        .photo-item-set .photo-stack-img:nth-child(1) { transform: translate(6px, 6px); z-index: 1; }
        .photo-item-set .photo-stack-img:nth-child(2) { transform: translate(3px, 3px); z-index: 2; }
        .photo-item-set .photo-stack-img:nth-child(3) { transform: translate(0, 0); z-index: 3; }
        .photo-item-set:hover .photo-stack-img:nth-child(1) { transform: translate(10px, 10px); }
        .photo-item-set:hover .photo-stack-img:nth-child(2) { transform: translate(5px, 5px); }
        #memoryModal .photo-title-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.6), transparent); color: white; font-size: 12px; padding: 12px 8px 4px 8px; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; z-index: 5; }
        .photo-item-set .count-overlay { position: absolute; bottom: 5px; right: 8px; background: rgba(0,0,0,0.5); color: white; padding: 2px 6px; font-size: 10px; font-weight: bold; border-radius: 4px; z-index: 5; }
        #memoryPhotoViewerOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 5000; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #memoryPhotoViewerOverlay.active { opacity: 1; pointer-events: auto; }
        #memoryPhotoViewerOverlay .viewer-header { flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; padding: 20px; color: white; background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent); z-index: 10;}
        #memoryPhotoViewerOverlay .viewer-header .counter { font-size: 16px; font-weight: bold; }
        #memoryPhotoViewerOverlay .viewer-btn { background: rgba(40,40,40,0.5); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 18px; cursor: pointer; transition: background-color 0.2s; }
        #memoryPhotoViewerOverlay .viewer-btn:hover { background: rgba(60,60,60,0.7); }
        #memoryPhotoViewerOverlay .viewer-content { flex-grow: 1; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        #viewer-img-container { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; transition: padding 0.3s ease; }
        #memoryPhotoViewerOverlay #viewer-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        #memoryPhotoViewerOverlay .nav-arrow { position: absolute; top: 50%; transform: translateY(-50%); width: 44px; height: 44px; font-size: 24px; opacity: 0.6; display: flex; align-items: center; justify-content: center; }
        #memoryPhotoViewerOverlay .nav-arrow:hover { opacity: 1; }
        #prev-photo-btn { left: 15px; } #next-photo-btn { right: 15px; }
        #memoryPhotoViewerOverlay .viewer-footer { flex-shrink: 0; padding: 20px; color: white; text-align: center; background: linear-gradient(to top, rgba(0,0,0,0.5), transparent); z-index: 10;}
        #viewer-title { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        #viewer-description { font-size: 14px; margin-bottom: 8px; }
        #viewer-timestamp { font-size: 12px; color: #ccc; }
        #memoryModal .empty-list-placeholder { grid-column: 1 / -1; text-align: center; color: #889; margin-top: 50px; }
        #memoryModal .fab { position: absolute; right: 25px; bottom: 25px; width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); box-shadow: 4px 4px 8px var(--shadow-dark-day), -4px -4px 8px var(--shadow-light-day); background: var(--bg-day-element); color: var(--text-day); font-size: 28px; display: flex; align-items: center; justify-content: center; user-select: none; z-index: 100; }
        body.dark-mode #memoryModal .fab { box-shadow: 4px 4px 8px var(--shadow-dark-night), -4px -4px 8px var(--shadow-light-night); background: var(--bg-night-element); color: var(--text-night); }
        #memoryModal .fab:active { transform: scale(0.95); }
        #memoryModal #note-editor-view { background: var(--bg-day-element); z-index: 200; padding: 10px; transform: translateY(100%); }
        body.dark-mode #memoryModal #note-editor-view { background: var(--bg-night-element); }
        body.theme-glass #memoryModal #note-editor-view, body.theme-glass.dark-mode #memoryModal #note-editor-view { background: transparent; }
        #memoryModal #note-editor-view.active { transform: translateY(0); }
        #memoryModal .editor-header{display:flex;justify-content:space-between;align-items:center;padding:10px 5px;flex-shrink:0}
        #memoryModal .editor-btn{padding:10px 18px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;color:var(--hold-border);background:var(--bg-day-element);box-shadow:4px 4px 8px var(--shadow-dark-day),-4px -4px 8px var(--shadow-light-day);transition:all .2s ease}body.dark-mode #memoryModal .editor-btn{color:var(--hold-border);background:var(--bg-night-element);box-shadow:4px 4px 8px var(--shadow-dark-night),-4px -4px 8px var(--shadow-light-night)}
        #memoryModal .editor-btn:active{box-shadow:inset 4px 4px 8px var(--shadow-dark-day),inset -4px -4px 8px var(--shadow-light-day)}body.dark-mode #memoryModal .editor-btn:active{box-shadow:inset 4px 4px 8px var(--shadow-dark-night),inset -4px -4px 8px var(--shadow-light-night)}
        #memoryModal #delete-note-btn{color:#f56565}
        #memoryModal .editor-content{flex-grow:1;display:flex;flex-direction:column;gap:10px;padding:10px 5px}
        #memoryModal #note-title-input,#memoryModal #note-content-textarea{width:100%;border:none;background:transparent;color:inherit;font-size:18px;padding:10px}
        #memoryModal #note-title-input{font-size:24px;font-weight:bold;flex-shrink:0}
        #memoryModal #note-content-textarea{flex-grow:1;resize:none;line-height:1.6}
        #memoryModal #note-title-input:focus,#memoryModal #note-content-textarea:focus{outline:none}
        #memoryFolderModal .modal-content, #memoryPhotoDetailsModal .modal-content { max-width: 400px; }
        #memoryPhotoDetailsModal #upload-thumbnail { max-width: 100px; max-height: 100px; border-radius: 8px; margin: 10px auto; object-fit: cover; }
        #memoryPhotoDetailsModal #photoset-toggle-container { display: none; padding: 10px; border-bottom: 1px solid rgba(128,128,128,0.2); }
        #memoryPhotoDetailsModal .modal-footer { display:flex; justify-content:flex-end; gap:10px; margin-top:20px; }
        #memoryPhotoDetailsModal .modal-button.primary { color: var(--hold-border); }
        #memoryModal .pin-btn { position: absolute; top: 10px; right: 10px; background: transparent; border: none; font-size: 20px; cursor: pointer; opacity: 0.3; transition: opacity 0.2s, transform 0.2s; z-index: 5; }
        #memoryModal .note-item.pinned .pin-btn { opacity: 1; color: var(--hold-border); }
        #memoryModal .pin-btn:hover { transform: scale(1.2); }
        .management-controls { display: none; position: absolute; bottom: 0; left: 0; right: 0; padding: 15px; background: var(--bg-day-element); box-shadow: 0 -4px 12px rgba(0,0,0,0.1); z-index: 101; flex-direction: row; justify-content: space-between; gap: 10px; border-radius: 16px 16px 0 0;}
        body.dark-mode .management-controls { background: var(--bg-night-element); }
        .management-controls.active { display: flex; }
        .management-controls .modal-button { flex-grow: 1; margin: 0; padding: 12px; }
        .folder-item.manage-mode, .album-item.manage-mode, .photo-item.manage-mode, .photo-item-set.manage-mode { cursor: pointer; }
        .folder-item .manage-checkbox, .album-item .manage-checkbox, .photo-item .manage-checkbox, .photo-item-set .manage-checkbox { display: none; position: absolute; top: 10px; left: 10px; width: 22px; height: 22px; z-index: 5; }
        .folder-item.manage-mode .manage-checkbox, .album-item.manage-mode .manage-checkbox, .photo-item.manage-mode .manage-checkbox, .photo-item-set.manage-mode .manage-checkbox { display: block; }
        .folder-item.manage-selected, .album-item.manage-selected, .photo-item.manage-selected, .photo-item-set.manage-selected { border: 2px solid var(--hold-border); box-shadow: 0 0 0 2px var(--hold-border), 8px 8px 16px var(--shadow-dark-day), -8px -8px 16px var(--shadow-light-day) !important; }
        body.dark-mode .folder-item.manage-selected, body.dark-mode .album-item.manage-selected, body.dark-mode .photo-item.manage-selected, body.dark-mode .photo-item-set.manage-selected { box-shadow: 0 0 0 2px var(--hold-border), 8px 8px 16px var(--shadow-dark-night), -8px -8px 16px var(--shadow-light-night) !important; }
        
        #cloud-drive-section .list-container { display: flex; flex-direction: column; gap: 15px; padding: 15px; overflow-y: hidden; min-height: 0; }
        #file-list-container { flex-shrink: 1; flex-grow: 1; min-height: 100px; overflow-y: auto; border-radius: 10px; padding: 5px; background:var(--bg-day-element); box-shadow: inset 4px 4px 8px var(--shadow-dark-day), inset -4px -4px 8px var(--shadow-light-day); display: flex; flex-direction: column; }
        body.dark-mode #file-list-container { background:var(--bg-night-element); box-shadow: inset 4px 4px 8px var(--shadow-dark-night), inset -4px -4px 8px var(--shadow-light-night); }
        #file-list-container ul { list-style:none; padding: 5px; }
        #file-list-container li { padding: 8px 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; transition: background .2s; gap: 10px; position: relative; }
        #file-list-container li:hover { background-color: rgba(0,0,0,0.05); } body.dark-mode #file-list-container li:hover { background-color:rgba(255,255,255,0.08); }
        #fileListStatus { flex-grow: 1; text-align: center; color: #a0aec0; display: flex; align-items: center; justify-content: center; min-height: 50px; } body.dark-mode #fileListStatus { color:#889; }
        .file-info { flex-grow: 1; cursor: pointer; min-width: 0; }
        .file-name { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 16px; }
        .file-meta { font-size: 12px; font-weight: 300; color: #9A86A4; }
        .delete-btn { background:transparent; border:none; cursor:pointer; padding:0; flex-shrink:0; width:28px; height:28px; display:flex; align-items:center; justify-content:center; border-radius:50%; transition:background .2s,color .2s; color:#bbb; font-size:22px; font-weight:bold; line-height:1; }
        .delete-btn:hover { background:#f0f0f0; color:#e53e3e; } body.dark-mode .delete-btn { color:#889; } body.dark-mode .delete-btn:hover { background:rgba(255,255,255,0.1); color:#fc8181; }

        /* ===== [END] MEMORY MODAL STYLES ===== */
        
        /* ===== [START] WANDER VIEW 4.0 STYLES (Architecture) ===== */
        @keyframes breathing-glow {
            0% { box-shadow: 0 0 8px 1px var(--handle-color); }
            50% { box-shadow: 0 0 16px 4px var(--handle-color); }
            100% { box-shadow: 0 0 8px 1px var(--handle-color); }
        }
        #wanderViewOverlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 6000; background: var(--bg-day-element); color: var(--text-day); display: none; flex-direction: column; opacity: 0; transition: opacity 0.4s ease; }
        body.dark-mode #wanderViewOverlay { background: var(--bg-night-element); color: var(--text-night); }
        #wanderViewOverlay.active { display: flex; opacity: 1; }
        .wander-header { display: flex; justify-content: flex-end; padding: 5px; flex-shrink: 0; position: absolute; top: 0; right: 0; z-index: 10001; }
        .wander-header .close-btn { font-size: 24px; font-weight: bold; width: 36px; height: 36px; cursor: pointer; border: none; background: transparent; color: inherit; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background .2s ease; }
        .wander-header .close-btn:hover { background: rgba(0,0,0,0.05); } body.dark-mode .wander-header .close-btn:hover { background: rgba(255,255,255,0.08); }
        .wander-main-content { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px 20px; overflow: hidden; min-height: 0; transition: transform 0.4s ease; }
        .wander-photo-container { position: relative; width: 100%; max-width: 500px; aspect-ratio: 0.85; display: flex; align-items: center; justify-content: center; transition: all 0.4s ease; margin: auto 0;
            background: white; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-radius: 4px; padding: 15px 15px 80px 15px;
        }
        #wander-img { cursor: pointer; width:100%; height:100%; object-fit: cover; }
        .wander-info-container { position: absolute; bottom: 15px; left: 15px; right: 15px; text-align: center; }
        #wander-title { font-size: 18px; font-weight: 700; margin-bottom: 5px; color: #333; }
        #wander-description { font-size: 14px; color: #777; line-height: 1.5; }
        .wander-photo-container.fullscreen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; max-width: none; z-index: 10000; padding: 0; background: transparent; box-shadow: none; border-radius: 0; }
        .wander-photo-container.fullscreen::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: var(--blur-bg); background-size: cover; background-position: center; filter: blur(20px); transform: scale(1.1); opacity: 0.8; z-index: -1; }
        .wander-photo-container.fullscreen #wander-img { padding: 0; background: transparent; box-shadow: none; border-radius: 0; width: 100%; height: 100%; object-fit: contain; }
        .wander-photo-container.fullscreen .wander-info-container { display: none; }
        .wander-music-player { position: relative; flex-shrink: 0; width: calc(100% - 20px); max-width: 400px; margin: 0 auto 15px auto; z-index: 15; transition: transform 0.4s ease; }
        .wander-music-player.hidden { display: none; }
        .player-handle-container { padding: 10px 0 5px; cursor: pointer; }
        .player-handle { width: 40px; height: 5px; border-radius: 2.5px; background: #ccc; margin: 0 auto; } body.dark-mode .player-handle { background: #555; }
        .wander-music-player.collapsed { transform: translateY(calc(100% - 30px)); }
        .wander-music-player.collapsed .player-content { box-shadow: none; background: transparent; }
        .wander-music-player.collapsed > *:not(.player-handle-container) { display: none; }
        .player-content { padding: 15px; border-radius: 24px; background: var(--bg-day-element); box-shadow: 8px 8px 16px var(--shadow-dark-day), -8px -8px 16px var(--shadow-light-day); }
        body.dark-mode .player-content { background: var(--bg-night-element); box-shadow: 8px 8px 16px var(--shadow-dark-night), -8px -8px 16px var(--shadow-light-night); }
        .player-controls { display: flex; justify-content: space-between; align-items: center; gap: 5px; margin-top: 10px; }
        .player-btn { width: 44px; height: 44px; border-radius: 50%; border: none; background: var(--bg-day-element); box-shadow: 4px 4px 8px var(--shadow-dark-day), -4px -4px 8px var(--shadow-light-day); color: var(--text-day); font-size: 18px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
        .player-btn svg { width: 1em; height: 1em; fill: currentColor; }
        body.dark-mode .player-btn { background: var(--bg-night-element); box-shadow: 4px 4px 8px var(--shadow-dark-night), -4px -4px 8px var(--shadow-light-night); color: var(--text-night); }
        .player-btn:active { box-shadow: inset 4px 4px 8px var(--shadow-dark-day), inset -4px -4px 8px var(--shadow-light-day); }
        body.dark-mode .player-btn:active { box-shadow: inset 4px 4px 8px var(--shadow-dark-night), inset -4px -4px 8px var(--shadow-light-night); }
        .player-btn#play-pause-btn { width: 52px; height: 52px; font-size: 22px; }
        .player-display { margin: 10px 0; height: 1.5em; text-align: center; font-size: 14px; overflow: hidden; display: flex; flex-direction: column; justify-content: center; position: relative; }
        .song-title-display { display: flex; align-items: center; justify-content: center; height: 100%; font-weight: 600; }
        #lyrics-container { position: absolute; width: 100%; height: 1.5em; top: 0; left: 0; overflow: hidden; }
        #lyrics-ul { list-style: none; transition: transform 0.5s ease; padding: 0; margin: 0;}
        #lyrics-ul li { line-height: 1.5em; opacity: 0.5; transition: opacity 0.5s ease; }
        #lyrics-ul li.current-lyric { opacity: 1; font-weight: bold; }
        .player-progress-track { position: relative; height: 16px; margin: 10px 0 0 0; cursor: pointer; --handle-color: var(--handle-color-day); }
        body.dark-mode .player-progress-track { --handle-color: var(--handle-color-night); }
        .player-progress-bar-bg { position: absolute; top: 50%; transform: translateY(-50%); left:0; right: 0; height: 3px; background-color: rgba(128,128,128,0.2); border-radius: 1.5px; }
        #player-progress-bar { position: absolute; top: 50%; transform: translateY(-50%); left:0; height: 3px; background-color: var(--handle-color); border-radius: 1.5px; width: 0; }
        #player-progress-handle { position: absolute; top: 50%; left: 0; width: 14px; height: 14px; transform: translate(-50%, -50%); background-color: var(--handle-color); border-radius: 50%; box-shadow: 0 0 8px 1px var(--handle-color); transition: box-shadow 0.3s ease; }
        #player-progress-handle.playing { animation: breathing-glow 2s ease-in-out infinite; }
        .player-progress-track:hover #player-progress-handle { box-shadow: 0 0 12px 3px var(--handle-color); }
        .player-popover { display: none; position: absolute; bottom: calc(100% + 10px); left: 15px; width: 250px; background: var(--bg-day-element); border-radius: 12px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); padding: 10px; border: 1px solid rgba(0,0,0,0.05); z-index: 20; }
        .player-popover.active { display: block; }
        body.dark-mode .player-popover { background: var(--bg-night-element); border-color: rgba(255,255,255,0.1); }
        .player-popover .popover-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 0 5px; }
        .player-popover h4 { font-size: 16px; flex-grow: 1; }
        .player-popover .settings-btn { width: 32px; height: 32px; font-size: 20px; flex-shrink: 0; }
        .player-popover ul { list-style: none; max-height: 150px; overflow-y: auto; padding: 0; }
        .player-popover li { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 6px; cursor: pointer; }
        .player-popover li:hover { background: rgba(0,0,0,0.05); } body.dark-mode .player-popover li:hover { background: rgba(255,255,255,0.08); }
        .player-popover li.playing { color: var(--hold-border); font-weight: bold; }
        .player-popover .playlist-item-name { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #musicSettingsModal.modal-overlay { z-index: 15000; }
        #musicSettingsModal .modal-body { gap: 20px; }
        .music-upload-section, .music-playlist-section { border-top: 1px solid rgba(0,0,0,0.1); padding-top: 20px; display: flex; flex-direction: column; gap: 15px; }
        .music-upload-section .confirm-upload-wrapper { display: flex; justify-content: center; padding-top: 5px; }
        body.dark-mode .music-upload-section, body.dark-mode .music-playlist-section { border-color: rgba(255,255,255,0.1); }
        #music-playlist-container { max-height: 200px; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        #music-playlist-container li { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 6px; }
        #music-playlist-container li:hover { background: rgba(0,0,0,0.05); } body.dark-mode #music-playlist-container li:hover { background: rgba(255,255,255,0.08); }
        #music-playlist-container li.playing { color: var(--hold-border); font-weight: bold; }
        #music-playlist-container .song-name { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        #music-playlist-container .delete-song-btn { width: 28px; height: 28px; color: #aaa; } #music-playlist-container .delete-song-btn:hover { color: #f56565; background: rgba(229, 62, 62, 0.1); }
        .music-loader{width:1.2em;height:1.2em;border:2px solid rgba(128,128,128,0.3);border-top-color:var(--hold-border);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
        @keyframes spin{to{transform:rotate(360deg)}}
        /* ===== [END] WANDER VIEW STYLES ===== */
        
        /* ===== [START] HELP MODAL UPDATE STYLES ===== */
        .segmented-control.four-segments .slider-indicator { width: calc(25% - 4px); }
        #help-tab-0:checked ~ .segmented-control .slider-indicator { transform: translateX(0%); }
        #help-tab-1:checked ~ .segmented-control .slider-indicator { transform: translateX(100%); }
        #help-tab-2:checked ~ .segmented-control .slider-indicator { transform: translateX(200%); }
        #help-tab-3:checked ~ .segmented-control .slider-indicator { transform: translateX(300%); }

        #help-tab-0:checked ~ .help-content-wrapper > #help-page-0,
        #help-tab-1:checked ~ .help-content-wrapper > #help-page-1,
        #help-tab-2:checked ~ .help-content-wrapper > #help-page-2,
        #help-tab-3:checked ~ .help-content-wrapper > #help-page-3 { display: block; }
        
        details { border: 1px solid rgba(128,128,128,0.2); border-radius: 8px; margin-bottom: 12px; }
        summary { cursor: pointer; padding: 12px 15px; font-weight: bold; font-size: 1.1em; list-style: none; }
        summary::-webkit-details-marker { display: none; }
        summary::before { content: ''; margin-right: 8px; display: inline-block; transition: transform 0.2s; }
        details[open] > summary::before { transform: rotate(90deg); }
        .details-content { padding: 0 15px 15px 15px; border-top: 1px solid rgba(128,128,128,0.2); }
        .details-content p, .details-content ul, .details-content div { margin-top: 10px; }
        .details-content ul { padding-left: 20px; }
        .details-content .sub-note { font-size: 0.9em; color: #889; }

        .update-header-info {
            padding: 10px 15px;
            background-color: rgba(128,128,128,0.1);
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
        }
        .update-header-info p { margin: 5px 0; color: inherit; }
        .update-log-entry {
            padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(128,128,128,0.2);
        }
        .update-log-entry:last-of-type { border-bottom: none; }
        .update-log-entry h4 { font-size: 1.2em; margin: 0 0 10px 0; }
        .update-date { font-size: 0.8em; font-weight: normal; color: #889; }
        .update-log-entry ul { list-style: none; padding-left: 5px; }
        .update-log-entry li { margin-bottom: 8px; display: flex; align-items: flex-start; }
        .tag {
            flex-shrink: 0;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 10px;
            color: white;
        }
        .tag.new { background-color: #769fcd; } /* Morandi Blue */
        .tag.fix { background-color: #93b5b3; } /* Morandi Green */
        .tag.opt { background-color: #d1a787; } /* Morandi Orange/Brown */
        .tag.release { background-color: #b091a2; }
        .update-footer {
            position: sticky;
            bottom: -1px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 12px;
            color: #a0aec0;
            padding: 10px 0 5px 0;
            background: var(--bg-day-element);
            margin: 15px -15px -15px -15px;
        }
        body.dark-mode .update-footer { background: var(--bg-night-element); }

        .fab-drawer-item#helpBtn { position: relative; }
        .fab-drawer-item.has-update::after {
            content: '';
            position: absolute;
            top: 6px;
            right: 6px;
            width: 8px;
            height: 8px;
            background-color: #e53e3e;
            border-radius: 50%;
            border: 1px solid white;
            box-shadow: 0 0 5px #e53e3e;
        }
        /* ===== [END] HELP MODAL UPDATE STYLES ===== */

        /* ...  CSS ... */
        .fab-drawer-item.has-update::after {
            /* ... */
        }
        /* ===== [END] HELP MODAL UPDATE STYLES ===== */


        /* =============================================================== */
        /* ============ [] iOS  ============ */
        /* =============================================================== */
        #iosWarningModal .modal-body p {
            line-height: 1.6;
            margin-bottom: 12px;
        }
        #iosWarningModal .modal-body strong {
            color: var(--hold-border);
            font-weight: 600;
        }
        /* =============================================================== */
        /* ========================= [] ========================== */
        /* =============================================================== */


        /* ===== [START] FROSTED GLASS THEME ===== */
        body.theme-glass .modal-overlay,
        /* ... */


        /* ===== [START] FROSTED GLASS THEME ===== */
        body.theme-glass .modal-overlay,
        body.theme-glass #memoryPhotoViewerOverlay {
            background: transparent;
        }

        body.theme-glass .nav-btn,
        body.theme-glass .title-card,
        body.theme-glass .fab-main,
        body.theme-glass .fab-drawer-item,
        body.theme-glass .modal-content,
        body.theme-glass .category-pill,
        body.theme-glass .player-content,
        body.theme-glass .player-popover,
        body.theme-glass #memoryModal .hub-btn,
        body.theme-glass #memoryModal .folder-item,
        body.theme-glass #memoryModal .note-item,
        body.theme-glass #memoryModal .album-item,
        body.theme-glass #memoryModal .fab,
        body.theme-glass #memoryModal .editor-btn,
        body.theme-glass #memoryModal #note-editor-view,
        body.theme-glass .management-controls,
        body.theme-glass #returnConfirmationToast {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }
        body.theme-glass.dark-mode .nav-btn,
        body.theme-glass.dark-mode .title-card,
        body.theme-glass.dark-mode .fab-main,
        body.theme-glass.dark-mode .fab-drawer-item,
        body.theme-glass.dark-mode .modal-content,
        body.theme-glass.dark-mode .category-pill,
        body.theme-glass.dark-mode .player-content,
        body.theme-glass.dark-mode .player-popover,
        body.theme-glass.dark-mode #memoryModal .hub-btn,
        body.theme-glass.dark-mode #memoryModal .folder-item,
        body.theme-glass.dark-mode #memoryModal .note-item,
        body.theme-glass.dark-mode #memoryModal .album-item,
        body.theme-glass.dark-mode #memoryModal .fab,
        body.theme-glass.dark-mode #memoryModal .editor-btn,
        body.theme-glass.dark-mode #memoryModal #note-editor-view,
        body.theme-glass.dark-mode .management-controls,
        body.theme-glass.dark-mode #returnConfirmationToast {
            background: rgba(20, 20, 20, 0.25);
            border-color: rgba(255, 255, 255, 0.1);
        }

        body.theme-glass .modal-input,
        body.theme-glass .modal-select,
        body.theme-glass .modal-textarea,
        body.theme-glass .segmented-control,
        body.theme-glass .toggle-section,
        body.theme-glass #file-list-container,
        body.theme-glass .color-input-wrapper {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: none;
        }
        body.theme-glass.dark-mode .modal-input,
        body.theme-glass.dark-mode .modal-select,
        body.theme-glass.dark-mode .modal-textarea,
        body.theme-glass.dark-mode .segmented-control,
        body.theme-glass.dark-mode .toggle-section,
        body.theme-glass.dark-mode #file-list-container,
        body.theme-glass.dark-mode .color-input-wrapper {
            background: rgba(10, 10, 10, 0.2);
            border-color: rgba(255, 255, 255, 0.1);
        }

        body.theme-glass .modal-button {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        body.theme-glass.dark-mode .modal-button {
             background: rgba(30, 30, 30, 0.4);
        }

                body.theme-glass .nav-btn:active,
        body.theme-glass .modal-button:active,
        body.theme-glass .fab-main:active,
        body.theme-glass .fab-drawer-item:active {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transform: translateY(1px);
        }

        body.theme-glass .segmented-control .slider-indicator {
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        body.theme-glass.dark-mode .segmented-control .slider-indicator {
             background: rgba(200, 200, 200, 0.25);
             border-color: rgba(255, 255, 255, 0.15);
        }
        /* ===== [END] FROSTED GLASS THEME ===== */

        /* ===== [START] FLOATING JELLYFISH BALL STYLES (MODIFIED) ===== */
        .jelly-ball-wrapper { /* MODIFICATION: New wrapper for custom CSS support */
            position: fixed;
            z-index: 2005;
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease, transform 0.3s ease, left 0.2s ease-out, top 0.2s ease-out;
            pointer-events: none; /* MODIFICATION: Wrapper is non-interactive */
        }
        .jelly-ball-wrapper .jelly-ball-glow { /* MODIFICATION: New glow element */
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            animation: jelly-glow 2.5s infinite ease-in-out;
            filter: drop-shadow(0 0 2px rgba(91, 153, 226, 0.7));
        }

        @keyframes jelly-glow {
            0% { filter: drop-shadow(0 0 2px var(--hold-border, rgba(91, 153, 226, 0.7))); }
            50% { filter: drop-shadow(0 0 8px var(--hold-border, rgba(91, 153, 226, 1))); }
            100% { filter: drop-shadow(0 0 2px var(--hold-border, rgba(91, 153, 226, 0.7))); }
        }
        #floating-jellyfish-ball {
            position: relative; /* MODIFICATION: Changed from fixed */
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: grab;
            user-select: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: transform 0.3s ease; /* MODIFICATION: Removed other transitions */
            pointer-events: auto; /* MODIFICATION: Ball itself is interactive */
        }
        body.dark-mode #floating-jellyfish-ball {
            background: rgba(30, 30, 30, 0.6);
            border-color: rgba(255, 255, 255, 0.15);
        }
        .jelly-ball-wrapper.dragging { /* MODIFICATION: Dragging class on wrapper */
            transition: none;
        }
        #floating-jellyfish-ball.dragging {
            cursor: grabbing;
            transform: scale(1.1);
        }
        .jelly-ball-wrapper.idle { /* MODIFICATION: Idle class on wrapper */
            opacity: 0.5;
        }
        .jelly-ball-wrapper.idle.snap-right {
            transform: translateX(66.67%); /* MODIFICATION: Hide 2/3 of the ball */
        }
        .jelly-ball-wrapper.idle.snap-left {
            transform: translateX(-66.67%); /* MODIFICATION: Hide 2/3 of the ball */
        }
        .jelly-menu {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .jelly-menu-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 38px;
            height: 38px;
            margin: -19px 0 0 -19px;
            background: inherit;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            box-shadow: inherit;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
        }
        #floating-jellyfish-ball.menu-open .jelly-menu-btn {
            transform: var(--transform-end);
            opacity: 1;
            pointer-events: auto;
        }
        .jelly-menu-btn.hovered {
            transform: var(--transform-end) scale(1.15) !important;
            filter: brightness(1.1);
        }
        /* ===== [END] FLOATING JELLYFISH BALL STYLES ===== */

        /* ===== [START] FLOATING PROJECT WINDOW STYLES ===== */
        .floating-project-window {
            position: fixed;
            z-index: 2010;
            width: 350px;
            height: 500px;
            background: var(--bg-day-element);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* resize: both;  */ /* Using custom resizer */
            min-width: 250px;
            min-height: 300px;
            transition: opacity 0.3s ease, transform 0.3s ease;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            opacity: 0;
        }
        .floating-project-window.visible {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        body.dark-mode .floating-project-window {
            background: var(--bg-night-element);
        }
        body.theme-glass .floating-project-window {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }
        body.theme-glass.dark-mode .floating-project-window {
            background: rgba(20, 20, 20, 0.25);
            border-color: rgba(255, 255, 255, 0.1);
        }
        .fpw-header {
            flex-shrink: 0;
            padding: 8px 12px;
            background: rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: grab;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }
        body.dark-mode .fpw-header { background: rgba(255,255,255,0.05); }
        .fpw-header:active { cursor: grabbing; }
        .fpw-title {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .fpw-controls { display: flex; align-items: center; gap: 4px; }
        .fpw-controls button {
            background: transparent;
            border: none;
            color: inherit;
            font-size: 18px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s;
            line-height: 28px;
        }
        .fpw-controls button:hover { background: rgba(0,0,0,0.1); }
        .fpw-content {
            flex-grow: 1;
            overflow: hidden;
            position: relative;
        }
        .fpw-content iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .fpw-resizer {
            position: absolute;
            width: 20px;
            height: 20px;
            right: 0;
            bottom: 0;
            cursor: se-resize;
            z-index: 10;
        }
        
                .fpw-hide-handle {
            position: fixed;
            z-index: 2009;
            padding: 10px 8px;
            background: var(--bg-day-element);
            color: var(--text-day);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: opacity 0.3s ease, top 0.3s ease; /*  top  */
            font-size: 12px;
            font-weight: 600;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
        }

        .fpw-hide-handle.visible {
            opacity: 1;
            pointer-events: auto;
        }
        body.dark-mode .fpw-hide-handle { background: var(--bg-night-element); color: var(--text-night); }
        /* ===== [END] FLOATING PROJECT WINDOW STYLES ===== */

        /* ===== [START] CSS HELP MODAL STYLES ===== */
        #jelly-css-help-modal .modal-content { max-width: 600px; }
        #jelly-css-help-modal .modal-body { gap: 10px; }
        .css-help-section { padding: 12px 15px; border-radius: 10px; background: rgba(0,0,0,0.03); }
        body.dark-mode .css-help-section { background: rgba(255,255,255,0.03); }
        .css-help-section h3 { font-size: 1.25em; margin-bottom: 10px; color: var(--hold-border); text-align: center; border-bottom: 1px solid rgba(128,128,128,0.2); padding-bottom: 8px;}
        .css-help-section h4 { font-size: 1.1em; margin-top: 15px; margin-bottom: 5px; }
        .css-help-section p, .css-help-section li { line-height: 1.6; font-size: 0.95em; }
        .css-help-text-block { background-color: rgba(128,128,128,0.1); padding: 12px; border-radius: 8px; margin-top: 5px; font-family: monospace; white-space: pre-wrap; word-break: break-all; font-size: 13px; position:relative;}
        .css-help-text-block .copy-btn { position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: inherit; padding: 4px 8px; border-radius: 5px; font-size: 12px; cursor: pointer; transition: background 0.2s; }
        .css-help-text-block .copy-btn:hover { background: rgba(255,255,255,0.4); }

/*  CSS  <style>  */
#iosPwaWarningModal .modal-header {
    justify-content: center; /*  */
}
#iosPwaWarningModal .important-note {
    border-left-color: #e53e3e; /*  */
    background-color: rgba(229, 62, 62, 0.1);
}

        /* ===== [END] CSS HELP MODAL STYLES ===== */

/* =============================================================== */
/* ============= []  V1.0 ============= */
/* =============================================================== */

/*  body  */
body.dragging-active {
    user-select: none;
    -webkit-user-select: none;
    cursor: grabbing !important;
}

/*  */
.nav-btn.dragging,
.category-pill.dragging {
    opacity: 0.4;
    animation: none !important; /*  */
    transform: none !important;
}

/*  */
.drag-ghost {
    position: fixed; /*  fixed  */
    pointer-events: none; /*  */
    z-index: 9999;
    opacity: 0.8;
    transform: scale(1.08); /*  */
    transition: transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

/*  */
.nav-btn.drag-over,
.category-pill.drag-over {
    transform: scale(1.05) !important; /*  */
    animation: none !important; /*  */
    box-shadow: 0 0 18px 4px var(--hold-border, #63b3ed) !important; /*  */
    transition: all 0.2s ease-in-out;
}
/* =============================================================== */
/* ========================= [] ========================== */
/* =============================================================== */


    </style>
    <style id="custom-jelly-ball-styles"></style>
</head>
<body>
    <div class="page-overlay" id="pageOverlay"></div>
    <div class="title-card" id="titleCard">
        <h1 class="editable-title" id="title">JellyfishCenter</h1>
        <div class="editable-subtitle" id="subtitle"> | By</div>
    </div>
    
    <div class="category-nav-container" id="categoryNavContainer">
        <div class="category-nav" id="categoryNav"></div>
    </div>

    <div class="nav-container" id="navContainer">
        <p id="loading-status" style="text-align: center; color: #889;">...</p>
    </div>

    <div class="fab-container" id="fabContainer">
        <div class="fab-drawer" id="fabDrawer">
            <button class="fab-drawer-item" id="helpBtn" title=""></button>
            <button class="fab-drawer-item" id="dataSyncBtn" title=""><span id="sync-status-indicator" title=""></span></button>
            <button class="fab-drawer-item" id="addNavBtn" title=""></button>
            <button class="fab-drawer-item" id="colorBtn" title=""></button>
            <button class="fab-drawer-item" id="memoryBtn" title=""></button>
        </div>
        <button class="fab-main theme-toggle" id="themeBtn" title=""></button>
    </div>
    
    <!-- Modals -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-group"><span></span></div>
                <button class="close-btn" data-modal-id="helpModal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="radio" id="help-tab-0" name="help-tab" value="setup" checked hidden>
                <input type="radio" id="help-tab-1" name="help-tab" value="features" hidden>
                <input type="radio" id="help-tab-2" name="help-tab" value="updates" hidden>
                <input type="radio" id="help-tab-3" name="help-tab" value="disclaimer" hidden>

                <div class="segmented-control four-segments">
                    <label for="help-tab-0"></label>
                    <label for="help-tab-1"></label>
                    <label for="help-tab-2"></label>
                    <label for="help-tab-3"></label>
                    <div class="slider-indicator"></div>
                </div>
                <div class="help-content-wrapper">
                    <div id="help-page-0" class="help-page-content">
                        <h3> ()</h3><p>(PAT)</p><ol><li><strong></strong><a href="https://github.com/settings/tokens/new" target="_blank" rel="noopener noreferrer"> GitHub Token </a></li><li><strong></strong>(Note) <code>JellyfishCenterToken</code>(Expiration) <code>No expiration</code> ()</li><li><strong> ()</strong> <strong> <code>repo</code></strong> </li><li><strong></strong> <strong><code>Generate token</code></strong> <strong></strong> GitHub  Token <strong></strong>  <code>ghp_</code> </li></ol>
                        <h4> 2</h4><p></p><ol><li><strong></strong><a href="https://github.com/new" target="_blank" rel="noopener noreferrer"> GitHub </a></li><li><strong></strong><ul><li><strong>Repository name ()</strong> <code>My-Jellyfish-Data</code></li><li><strong> <code>Private</code> ()</strong></li><li><strong> <code>Add a README file</code></strong></li></ul></li><li><strong> <code>Create repository</code></strong> </li></ol>
                        <h4> 3 JellyfishCenter </h4><p></p><ol><li><strong></strong> /    <strong> ()</strong></li><li><strong></strong><ul><li><strong></strong> <strong>2</strong> **** <code>GitHub/My-Jellyfish-Data</code></li><li><strong>Personal Access Token</strong> <strong>1</strong>  Token</li></ul></li><li><strong></strong> <strong><code></code></strong> </li></ol><p><strong></strong>  JellyfishCenter </p>
                    </div>
              
<div id="help-page-1" class="help-page-content">
    <details>
        <summary></summary>
        <div class="details-content">
            <p><strong>/</strong>: </p>
            <p><strong></strong>: <strong> ()</strong>  / </p>
            <p><strong></strong>: <strong></strong>  / </p>
            <p><strong></strong>: ****</p>
            <div class="important-note">
                <p><strong></strong><br></p>
            </div>
        </div>
    </details>
    <details>
        <summary> </summary>
        <div class="details-content">
            <p><strong></strong>: GitHub</p>
            <div class="important-note"><p><strong></strong></p></div>
            <p><strong></strong> </p>
            <ul><li><strong> </strong>: <code></code> - </li><li><strong>  ()</strong>: <code></code> - </li><li><strong> </strong>: <code></code> - </li></ul>
            <p><strong></strong>: </p>
        </div>
    </details>
    <details>
        <summary> </summary>
        <div class="details-content">
            <p><strong></strong>: </p>
            <p><strong>/</strong>: ""</p>
            <p><strong></strong>: </p>
            <ul>
                <li><strong></strong>: </li>
                <li><strong></strong>: </li>
            </ul>
        </div>
    </details>
    <details>
        <summary> </summary>
        <div class="details-content">
            <p><strong></strong></p>
            <p><strong></strong>/</p>
            <p><strong></strong></p>
            <div class="important-note" style="margin-top: 15px;">
                <h4> </h4>
                <p> <code>  </code></p>
                <p><strong></strong>:</p>
                <ul>
                    <li><strong></strong>: </li>
                    <li><strong></strong>: 3</li>
                    <li><strong></strong>: <strong></strong></li>
                </ul>
                <p><strong></strong>:</p>
                <p></p>
                <ul>
                    <li><strong></strong>: </li>
                    <li><strong>/</strong>:  <strong></strong>  <strong></strong> </li>
                    <li><strong></strong>: </li>
                </ul>
            </div>
        </div>
    </details>
    <details>
        <summary> </summary>
        <div class="details-content">
            <p>GitHub</p>
            <h4> </h4>
            <ul>
                <li><strong></strong>: </li>
                <li><strong></strong>: </li>
            </ul>
        </div>
    </details>

    <div class="warning"><p><strong></strong> <code></code> ()  <strong></strong>  GitHub <strong></strong></p></div>
                    </div>
                    <div id="help-page-2" class="help-page-content">
                        <div class="update-header-info">
                            <p><strong>ID:</strong> </p>
                            <p><strong>QQ:</strong> 563191005</p>
                        </div>
                        <div class="update-log-entry">
                            <h4>v3.9.0 <span class="update-date">- 2025.10.03</span></h4>
                            <ul>
                                <li><span class="tag new"></span> </li>
                            </ul>
                        </div>
                        <div class="update-log-entry">
                            <h4>v3.7.0 <span class="update-date">- 2025.10.02</span></h4>
                            <ul>
                                <li><span class="tag opt"></span> </li>
                                <li><span class="tag fix"></span> </li>
                                <li><span class="tag fix"></span> Bug</li>
                                <li><span class="tag fix"></span> Bug</li>
                                <li><span class="tag fix"></span> </li>
                                <li><span class="tag fix"></span> </li>
                                <li><span class="tag fix"></span> </li>
                                <li><span class="tag opt"></span> </li>
                                <li><span class="tag opt"></span> </li>
                            </ul>
                        </div>
                        <div class="update-log-entry">
                            <h4>v3.6.0 <span class="update-date">- 2025.10.01</span></h4>
                            <ul>
                                <li><span class="tag fix"></span>  `config.json` </li>
                                <li><span class="tag new"></span>  ****</li>
                                <li><span class="tag opt"></span> </li>
                            </ul>
                        </div>
                        <div class="update-log-entry">
                            <h4>v3.5.0 <span class="update-date">- 2025.10.01</span></h4>
                            <ul>
                                <li><span class="tag new"></span> </li>
                                <li><span class="tag new"></span>   </li>
                                <li><span class="tag new"></span>   </li>
                                <li><span class="tag fix"></span> HTML</li>
                                <li><span class="tag fix"></span> Bug</li>
                                <li><span class="tag opt"></span> </li>
                                <li><span class="tag opt"></span> GitHubVPN</li>
                            </ul>
                        </div>
                        <div class="update-log-entry">
                            <h4>v2.0.0 <span class="update-date">- 2025.09.30</span></h4>
                            <ul>
                                <li><span class="tag new"></span> </li>
                                <li><span class="tag new"></span> </li>
                                <li><span class="tag new"></span>   </li>
                                <li><span class="tag new"></span>  </li>
                                <li><span class="tag new"></span> </li>
                                <li><span class="tag fix"></span> iOS</li>
                            </ul>
                        </div>
                        <div class="update-log-entry">
                            <h4>v1.0.0 <span class="update-date">- 2025.09.24</span></h4>
                            <ul>
                                <li><span class="tag release"></span> JellyfishCenter </li>
                                <li><span class="tag new"></span> /</li>
                                <li><span class="tag new"></span> </li>
                            </ul>
                        </div>
                        
                        <footer class="update-footer">
                            : v3.9.0
                        </footer>
                    </div>
                    <div id="help-page-3" class="help-page-content">
                        <h3></h3><h4>1. </h4><p> (JellyfishCenter) </p><h4>2. </h4><p>GitHub (PAT) PAT (<code>repo</code>) PAT</p><h4>3. </h4><div class="important-note"><p><strong></strong></p></div><h4>4. </h4><div class="warning"><p> (JellyfishCenter) </p><ul><li></li><li></li></ul></div><p></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="syncErrorModal"><div class="modal-content"><div class="modal-header"><div class="modal-title-group"><span> </span></div><button class="close-btn" data-modal-id="syncErrorModal">&times;</button></div><div class="modal-body"><p>GitHub</p><p><strong>:</strong></p><div id="sync-error-message"></div></div></div></div>
    <div class="modal-overlay" id="addNavModal"><div class="modal-content"><div class="modal-header"><div class="modal-title-group"><span id="addNavModalTitle"></span></div><div class="header-toggle-group"><span></span><label class="toggle-switch"><input type="checkbox" id="stayOpenToggle"><span class="slider"></span></label></div><button class="close-btn" data-modal-id="addNavModal">&times;</button></div><div class="modal-body"><button id="enterManageModeBtn" class="modal-button" style="color:#5a6778;"></button><div class="toggle-section" style="margin-top: 10px;"><span></span><label class="toggle-switch"><input type="checkbox" id="paginationToggle"><span class="slider"></span></label></div><div class="segmented-control two-segments"><input type="radio" id="type-link" name="nav-type" value="link" checked hidden><label for="type-link"></label><input type="radio" id="type-upload" name="nav-type" value="upload" hidden><label for="type-upload"></label><div class="slider-indicator"></div></div><div class="form-section"><label for="newButtonCategoryInput"></label><input type="text" id="newButtonCategoryInput" class="modal-input" placeholder="" list="category-datalist"><datalist id="category-datalist"></datalist></div><div id="category-management-section" style="display: none;"><button id="deleteCategoryBtn" class="modal-button" style="color:#e53e3e;"></button></div><div class="form-section"><label for="newButtonNameInput"></label><input type="text" id="newButtonNameInput" class="modal-input" placeholder=": "></div><div id="link-section"><div class="form-section"><label for="newButtonUrlInput"></label><input type="text" id="newButtonUrlInput" class="modal-input" placeholder="https://example.com"></div><div class="toggle-section" style="margin-top: 10px;"><span></span><label class="toggle-switch"><input type="checkbox" id="openExternallyToggle"><span class="slider"></span></label></div></div><div id="upload-section" class="form-section" style="display: none;"><label>HTML</label><div class="file-select-wrapper"><input type="file" id="projectHtmlPicker" accept=".html,.htm" style="display: none;"><button id="filePickerBtn" class="modal-button"></button><span id="file-picker-status" class="status-text"></span></div><div class="important-note" style="font-size: 13px; padding: 8px 12px; margin-top: 5px;"><p></p></div></div><button id="createNavBtn" class="modal-button"></button><div class="status-text" id="upload-status"></div></div></div></div>
    <div class="modal-overlay" id="settingsModal"><div class="modal-content"><div class="modal-header"><div class="modal-title-group"><span></span></div><button class="close-btn" data-modal-id="settingsModal">&times;</button></div><div class="modal-body"><div class="form-section"><label for="githubRepoInput"> (: /)</label><input type="text" id="githubRepoInput" class="modal-input" placeholder=": my-username/JellyfishPhones"></div><div class="form-section"><label for="githubTokenInput">Personal Access Token</label><input type="password" id="githubTokenInput" class="modal-input" placeholder="ghp_xxxxxxxxxx"></div><button id="saveSettingsBtn" class="modal-button"></button><button id="manualSyncBtn" class="modal-button" style="color:#5a6778; margin-top: 10px;"></button><div class="nuke-section"><button id="nukeDataBtn" class="modal-button"></button></div></div></div></div>
    <div class="modal-overlay" id="colorPaletteModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-group"><span></span></div>
                <button class="close-btn" data-modal-id="colorPaletteModal">&times;</button>
            </div>
            <div class="modal-body">
                
                <div class="toggle-section" style="flex-wrap: wrap; gap: 10px;">
                    <span style="flex-basis: 100%; font-weight: 600;"></span>
                    <div style="width: 100%; display: flex; justify-content: space-between; align-items: center;">
                        <span></span>
                        <label class="toggle-switch"><input type="checkbox" id="jellyBallToggle"><span class="slider"></span></label>
                    </div>
                </div>

                <div id="jelly-ball-options-container" style="display: none; width: 100%; flex-direction: column; gap: 15px;">
                    <div class="toggle-section">
                        <span> ()</span>
                        <label class="toggle-switch"><input type="checkbox" id="jellySwipeBackToggle"><span class="slider"></span></label>
                    </div>

                    <div class="toggle-section" style="flex-direction: column; align-items: flex-start; gap: 12px; padding: 12px;">
                        <label style="font-size: 14px; color: #5a6778; font-weight: 600;"></label>
                        <div id="jelly-function-checkboxes" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px 15px; width: 100%;"></div>
                    </div>
                    
                                        <div class="toggle-section" style="flex-direction: column; align-items: flex-start; gap: 10px;">
                        <label for="jellyBallCssTextarea" style="font-size: 14px; color: #5a6778; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <span>CSS ()</span>
                            <button id="show-jelly-css-help" style="background:none; border:none; font-size: 20px; cursor:pointer; padding:0; line-height: 1;" title="CSS"></button>
                        </label>
                        <div style="display: flex; gap: 10px; width:100%; align-items: flex-start;">
                            <textarea id="jellyBallCssTextarea" class="modal-textarea" rows="4" placeholder=".jelly-ball-wrapper {&#10;  /*  */&#10;}&#10;#floating-jellyfish-ball {&#10;  /*  */&#10;  background: #ff0000 !important;&#10;}" style="flex-grow: 1;"></textarea>
                            <div id="jellyCssPreview" style="width: 52px; height: 52px; border: 1px solid rgba(128,128,128,0.2); border-radius: 8px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background:var(--bg-day-element); box-shadow: inset 2px 2px 4px var(--shadow-dark-day), inset -2px -2px 4px var(--shadow-light-day);"><div id="jellyCssPreviewBall" style="width: 42px; height: 42px; border-radius: 50%; font-size: 22px; display:flex; align-items:center; justify-content:center;"></div></div>
                        </div>
                        <button id="applyJellyBallCssBtn" class="modal-button" style="width: 100%;"></button>
                    </div>

                </div>

                <div class="theme-style-selector">
                    <label style="font-weight: 600;"></label>
                    <div class="segmented-control two-segments">
                        <input type="radio" id="theme-style-neumorphism" name="theme-style" value="neumorphism" checked hidden>
                        <label for="theme-style-neumorphism"></label>
                        <input type="radio" id="theme-style-glass" name="theme-style" value="glass" hidden>
                        <label for="theme-style-glass"></label>
                        <div class="slider-indicator"></div>
                    </div>
                </div>
                <div id="pneumorphism-settings">
                    <div class="color-picker-grid"><div class="color-picker-group"><label> - </label><div class="color-input-wrapper"><input type="color" id="dayColor1Picker"><span class="hex-display" id="dayColor1Hex"></span></div></div><div class="color-picker-group"><label> - </label><div class="color-input-wrapper"><input type="color" id="dayColor2Picker"><span class="hex-display" id="dayColor2Hex"></span></div></div><div class="color-picker-group"><label> - </label><div class="color-input-wrapper"><input type="color" id="nightColor1Picker"><span class="hex-display" id="nightColor1Hex"></span></div></div><div class="color-picker-group"><label> - </label><div class="color-input-wrapper"><input type="color" id="nightColor2Picker"><span class="hex-display" id="nightColor2Hex"></span></div></div></div>
                    <div class="preview-container"><div class="preview-box" id="dayPreview" data-label="Day"></div><div class="preview-box" id="nightPreview" data-label="Night"></div></div>
                    <div class="preset-manager"><div class="preset-row"><input type="text" id="presetNameInput" class="modal-input" placeholder=""><button id="savePresetBtn" class="modal-button save"></button><button id="updatePresetBtn" class="modal-button"></button></div><div class="preset-row"><select id="presetSelector" class="modal-select"></select><button id="deletePresetBtn" class="modal-button delete"></button></div></div>
                    <div class="toggle-section"><span></span><label class="toggle-switch"><input type="checkbox" id="randomPaletteToggle"><span class="slider"></span></label></div>
                </div>
                <div class="background-image-manager">
                    <div class="background-image-row">
                        <input type="file" id="dayBgImagePicker" accept="image/*" hidden>
                        <button id="uploadDayBgBtn" class="modal-button"></button>
                        <span id="dayBgStatus" class="status"></span>
                        <button id="clearDayBgBtn" class="modal-button delete"></button>
                    </div>
                    <div class="background-image-row">
                        <input type="file" id="nightBgImagePicker" accept="image/*" hidden>
                        <button id="uploadNightBgBtn" class="modal-button"></button>
                        <span id="nightBgStatus" class="status"></span>
                        <button id="clearNightBgBtn" class="modal-button delete"></button>
                    </div>
                    <div class="background-image-row">
                        <input type="file" id="dayTitleCardBgImagePicker" accept="image/*" hidden>
                        <button id="uploadDayTitleCardBgBtn" class="modal-button"></button>
                        <span id="dayTitleCardBgStatus" class="status"></span>
                        <button id="clearDayTitleCardBgBtn" class="modal-button delete"></button>
                    </div>
                    <div class="background-image-row">
                        <input type="file" id="nightTitleCardBgImagePicker" accept="image/*" hidden>
                        <button id="uploadNightTitleCardBgBtn" class="modal-button"></button>
                        <span id="nightTitleCardBgStatus" class="status"></span>
                        <button id="clearNightTitleCardBgBtn" class="modal-button delete"></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ===== [START] CSS HELP MODAL ===== -->
    <div class="modal-overlay" id="jelly-css-help-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-group"><span> CSS </span></div>
                <button class="close-btn" data-modal-id="jelly-css-help-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="css-help-section">
                    <h3></h3>
                    <p>CSS</p>
                    <p>AI</p>
                </div>
                <div class="css-help-section">
                    <h4></h4>
                    <ol>
                        <li><strong></strong>AI</li>
                        <li> <code>[ ]</code> AI</li>
                        <li>AIChatGPT, Kimi, Claude, </li>
                        <li>AICSS</li>
                    </ol>
                </div>
                                <div class="css-help-section">
                    <h4>AI ()</h4>
                    <div class="css-help-text-block" id="css-prompt-template">
                        <button class="copy-btn"></button>
CSS
1.  (Class Name): .[: cool-blue-theme]
2. : [macOS]
3. :
: []
 (): []
: []
4. :
: []
: [1]
: []
5. :
 (.fp-window-title): []
 (.fp-window-body): []
 (.fp-window-body button): []
 .[] 
                    </div>
                </div>
                 <div class="css-help-section">
                    <h4></h4>
                    <p>AI</p>
                    <h4>1</h4>
                    <div class="css-help-text-block" id="css-prompt-example1">
                        <button class="copy-btn"></button>
CSS
1.  (Class Name): .cyberpunk-neon
2. : 
3. :
: #1a1a2e ()
 (): #f0a500 ()  #e4007f ()
: #ffffff ()
4. :
:  ( 4px)
: 1
:  (box-shadow)
5. :
 (.fp-window-title):  #1a1a2e1
 (.fp-window-body): 
 (.fp-window-body button): 
 .cyberpunk-neon 
                    </div>
                    <h4>2 & </h4>
                     <div class="css-help-text-block" id="css-prompt-example2">
                         <button class="copy-btn"></button>
CSS
1.  (Class Name): .glassmorphism-light
2. : macOS
3. :
:  (rgba(255, 255, 255, 0.7))
 (): 
: 
4. :
:  ( 12px)
: 1 (rgba(200, 200, 200, 0.5))
: 
5. :
 (.fp-window-title): 
 (.fp-window-body): 
 (.fp-window-body button): 
 .glassmorphism-light  backdrop-filter: blur(15px);  -webkit-backdrop-filter: blur(15px); 
 .glassmorphism-light 
                    </div>
                </div>

            </div>
        </div>
    </div>
    <!-- ===== [END] CSS HELP MODAL ===== -->

    <!-- ...  modal ... -->
    <div class="modal-overlay" id="jelly-css-help-modal">
        <!-- ... CSS  ... -->
    </div>
    <!-- ===== [END] CSS HELP MODAL ===== -->

    <!-- =============================================================== -->
    <!-- ================ [] iOS  ================ -->
    <!-- =============================================================== -->
    <div class="modal-overlay" id="iosWarningModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <div class="modal-title-group"><span> iOS </span></div>
            </div>
            <div class="modal-body">
                <p> iOS  Web Sandbox <strong>iframe </strong></p>
                <p></p>
                <ol style="margin-left: 20px; line-height: 1.7;">
                    <li><strong></strong></li>
                    <li><strong></strong> Safari </li>
                </ol>
                <p style="margin-top: 15px;"><strong></strong></p>
                <button id="iosWarningConfirmBtn" class="modal-button" style="margin-top: 15px;"></button>
            </div>
        </div>
    </div>
    <!-- =============================================================== -->
    <!-- ========================= [] ========================== -->
    <!-- =============================================================== -->

    <!-- ===== [START] MEMORY MODAL ===== -->
    <div class="modal-overlay" id="memoryModal">
        <!-- ...  ... -->
    </div>

    <!-- ===== [START] MEMORY MODAL ===== -->
    <div class="modal-overlay" id="memoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-group">
                    <span id="memory-modal-title"></span>
                    <span id="memory-sync-status" style="font-size: 12px; font-weight: normal; margin-left: 8px;"></span>
                </div>
                <button class="close-btn" data-modal-id="memoryModal">&times;</button>
            </div>
            <div class="app-container" id="memoryAppContainer">
                <!-- HUB /  -->
                <div id="hub-view" class="page active">
                    <div id="hub-view-content">
                        <button data-action="goto-memo" class="hub-btn"></button>
                        <button data-action="goto-album" class="hub-btn"></button>
                        <button data-action="goto-cloud" class="hub-btn"></button>
                    </div>
                </div>
                <!-- MEMO /  -->
                <div id="memo-section" class="page">
                    <div id="folder-view" class="page active">
                        <div class="page-header">
                            <button data-action="back-to-hub" class="header-btn back-btn">&#10094;</button>
                            <h1 class="title"></h1>
                            <button data-action="toggle-memo-manage" class="header-btn manage-btn"></button>
                        </div>
                        <div id="folder-list-container" class="list-container"></div>
                        <button data-action="add-memo-folder" class="fab">+</button>
                        <div id="memo-management-controls" class="management-controls">
                             <button data-action="select-all-memo" class="modal-button"></button>
                             <button data-action="delete-selected-memo" class="modal-button" style="color:#f56565;"></button>
                        </div>
                    </div>
                    <div id="notes-view" class="page">
                        <div class="page-header">
                            <button data-action="back-to-memo-folders" class="header-btn back-btn">&#10094;</button>
                            <h1 id="notes-view-title" class="title"></h1>
                        </div>
                        <div id="notes-list-container" class="list-container"></div>
                        <button data-action="add-note" class="fab">+</button>
                    </div>
                    <div id="note-editor-view" class="page">
                        <div class="editor-header">
                            <button data-action="cancel-note" class="editor-btn"></button>
                            <div>
                                <button data-action="delete-note" class="editor-btn" style="display: none;"></button>
                                <button data-action="save-note" class="editor-btn"></button>
                            </div>
                        </div>
                        <div class="editor-content">
                            <input type="text" id="note-title-input" placeholder="">
                            <textarea id="note-content-textarea" placeholder="..."></textarea>
                        </div>
                    </div>
                </div>
                <!-- ALBUM /  -->
                <div id="album-section" class="page">
                    <div id="album-folder-view" class="page active">
                        <div class="page-header">
                            <button data-action="back-to-hub" class="header-btn back-btn">&#10094;</button>
                            <h1 class="title"></h1>
                            <div class="header-controls">
                                <button data-action="wander-global" class="header-btn wander-btn"></button>
                                <button data-action="toggle-album-manage" class="header-btn manage-btn"></button>
                            </div>
                        </div>
                        <div id="album-list-container" class="list-container"></div>
                        <button data-action="add-album-folder" class="fab">+</button>
                        <div id="album-management-controls" class="management-controls">
                             <button data-action="select-all-album" class="modal-button"></button>
                             <button data-action="delete-selected-album" class="modal-button" style="color:#f56565;"></button>
                        </div>
                    </div>
                    <div id="photo-grid-view" class="page">
                         <div class="page-header">
                            <button data-action="back-to-album-folders" class="header-btn back-btn">&#10094;</button>
                            <h1 id="photo-grid-title" class="title"></h1>
                            <div class="header-controls">
                                <button data-action="wander-local" class="header-btn wander-btn"></button>
                                <button data-action="toggle-photo-manage" class="header-btn manage-btn"></button>
                            </div>
                        </div>
                        <div id="photo-list-container" class="list-container"></div>
                        <label for="photo-uploader" data-action="add-photo" class="fab">+</label>
                        <input type="file" id="photo-uploader" multiple accept="image/*" style="display: none;">
                        <div id="photo-management-controls" class="management-controls">
                             <button data-action="select-all-photos" class="modal-button"></button>
                             <button data-action="delete-selected-photos" class="modal-button" style="color:#f56565;"></button>
                        </div>
                    </div>
                </div>
                <!-- CLOUD DRIVE /  -->
                <div id="cloud-drive-section" class="page">
                    <div class="page-header">
                        <button data-action="back-to-hub" class="header-btn back-btn">&#10094;</button>
                        <h1 class="title"></h1>
                    </div>
                    <div class="list-container">
                        <select id="categorySelector" class="modal-select"></select>
                        <select id="projectSelector" class="modal-select hidden"></select>
                        <div class="file-upload-section">
                            <input type="file" id="fileUploader"/>
                            <div class="file-select-wrapper">
                                <button id="selectFileBtn" class="modal-button"></button>
                                <span id="selectedFileName" class="status-text"></span>
                            </div>
                            <input type="text" id="fileNameInput" class="modal-input" placeholder=""/>
                            <button id="uploadBtn" class="modal-button"></button>
                            <div id="progressContainer" class="progress-container">
                                <div id="uploadProgressBar" class="progress-bar"></div>
                            </div>
                        </div>
                        <div id="file-list-container">
                            <ul id="fileList"></ul>
                            <div id="fileListStatus" class="file-list-status"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- (/) -->
    <div id="memoryFolderModal" class="modal-overlay">
        <div class="modal-content">
            <div id="folder-modal-title" class="modal-header"></div>
            <div class="modal-body"> <input type="text" id="folder-name-input" class="modal-input" placeholder=""> </div>
            <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button data-action="close-folder-modal" class="modal-button"></button>
                <button data-action="save-folder" class="modal-button" style="color:var(--hold-border)"></button>
            </div>
        </div>
    </div>
    <!--  -->
    <div id="memoryPhotoDetailsModal" class="modal-overlay">
        <div class="modal-content">
            <div id="photo-details-modal-title" class="modal-header"></div>
            <div class="modal-body">
                <div id="photoset-toggle-container">
                    <label class="header-toggle-group">
                        <input type="checkbox" id="create-photoset-toggle">
                        <span></span>
                    </label>
                </div>
                <img id="upload-thumbnail" src="" alt="upload thumbnail">
                <input type="text" id="photo-title-input" class="modal-input" placeholder=" ()">
                <textarea id="photo-desc-input" class="modal-textarea" placeholder=" ()"></textarea>
            </div>
            <div class="modal-footer">
                <button data-action="skip-photo-details" class="modal-button"></button>
                <button data-action="save-photo-details" class="modal-button primary"></button>
            </div>
        </div>
    </div>
    <!-- ===== [END] MEMORY MODAL ===== -->

    <!--  -->
    <div id="memoryPhotoViewerOverlay">
        <div class="viewer-header"> 
            <span class="counter" id="viewer-counter"></span>
            <button data-action="close-viewer" class="viewer-btn"></button> 
        </div>
        <div class="viewer-content">
            <button data-action="prev-photo" id="prev-photo-btn" class="viewer-btn nav-arrow">&#10094;</button>
            <div id="viewer-img-container"><img id="viewer-img" src="" alt="..."></div>
            <button data-action="next-photo" id="next-photo-btn" class="viewer-btn nav-arrow">&#10095;</button>
        </div>
        <div class="viewer-footer">
            <h3 id="viewer-title"></h3>
            <p id="viewer-description"></p>
            <p id="viewer-timestamp"></p>
        </div>
    </div>

    <!-- Wander View -->
    <div id="wanderViewOverlay">
        <div class="wander-header">
           <button class="close-btn" data-action="close-wander-view">&times;</button>
        </div>
        <div class="wander-main-content">
            <div class="wander-photo-container" id="wander-photo-container">
                <img id="wander-img" src="" alt="...">
                <div class="wander-info-container">
                    <h3 id="wander-title"></h3>
                    <p id="wander-description"></p>
                </div>
            </div>
        </div>
        <div class="wander-music-player" id="wander-music-player">
            <div class="player-handle-container" data-action="toggle-player-collapse"><div class="player-handle"></div></div>
            <div class="player-content">
                <div class="player-display" id="player-display-area"></div>
                <div class="player-progress-track">
                    <div class="player-progress-bar-bg"></div>
                    <div id="player-progress-bar"></div>
                    <div id="player-progress-handle"></div>
                </div>
                <div class="player-controls">
                    <button class="player-btn" id="playlist-btn" title=""></button>
                    <button class="player-btn" id="prev-song-btn" title=""></button>
                    <button class="player-btn" id="play-pause-btn" title=""></button>
                    <button class="player-btn" id="next-song-btn" title=""></button>
                    <button class="player-btn" id="loop-mode-btn" title=""></button>
                </div>
            </div>
            <div class="player-popover" id="playlist-popover">
                <div class="popover-header">
                    <h4></h4>
                    <button id="open-music-settings-btn" class="player-btn settings-btn"></button>
                </div>
                <ul id="popover-playlist-ul"></ul>
            </div>
        </div>
        <audio id="audio-player"></audio>
    </div>

    <!-- Music Settings Modal -->
    <div class="modal-overlay" id="musicSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-group"><span></span></div>
                <button class="close-btn" data-modal-id="musicSettingsModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="toggle-section">
                    <span></span>
                    <label class="toggle-switch"><input type="checkbox" id="autoplay-toggle"><span class="slider"></span></label>
                </div>
                <div class="music-upload-section">
                    <h4></h4>
                    <div class="file-select-wrapper">
                        <button id="upload-music-btn" class="modal-button"> (.mp3)</button>
                        <span id="upload-music-status" class="status-text"></span>
                    </div>
                     <input type="text" id="music-rename-input" class="modal-input" placeholder=" ()">
                    <div class="file-select-wrapper">
                        <button id="upload-lrc-btn" class="modal-button"> (.lrc)</button>
                        <span id="upload-lrc-status" class="status-text"></span>
                    </div>
                    <div class="confirm-upload-wrapper">
                        <button id="confirm-upload-btn" class="modal-button"></button>
                    </div>
                    <input type="file" id="music-file-picker" accept=".mp3" hidden>
                    <input type="file" id="lrc-file-picker" accept=".lrc" hidden>
                </div>
                <div class="music-playlist-section">
                    <h4></h4>
                    <ul id="music-playlist-container"></ul>
                </div>
            </div>
        </div>
    </div>


    <!-- == Iframe Modal & Confirmation Toast == -->
    <div class="iframe-modal-overlay" id="iframeModal">
        <div id="returnConfirmationToast" class="return-toast">
            <span> JellyfishCenter?</span>
            <div>
                <button id="cancelReturnBtn" class="toast-btn toast-btn-cancel"></button>
                <button id="confirmReturnBtn" class="toast-btn toast-btn-confirm"></button>
            </div>
        </div>
        <div class="iframe-modal-content">
            <iframe id="iframeContent" src="about:blank" frameborder="0" allow="fullscreen" sandbox="allow-forms allow-modals allow-pointer-lock allow-popups allow-popups-to-escape-sandbox allow-presentation allow-same-origin allow-scripts allow-downloads"></iframe>
        </div>
        <div id="gestureCaptureZone"></div>
        <div class="swipe-hint" id="swipeHint"><div class="arrow"></div><span></span></div>
    </div>
    
    <!-- Floating Project Windows Container -->
    <div id="floating-projects-container"></div>
    
       <script>
    // [JS - V12.5.0 "Cascade Select"]
    const CURRENT_APP_VERSION = '3.7.0';
    let GITHUB_CONFIG = {}, configSha = null, isManagementMode = false, isEditingButton = false, editingButtonData = null;
    const navContainer = document.getElementById('navContainer'), pageOverlay = document.getElementById('pageOverlay');
    const syncStatusIndicator = document.getElementById('sync-status-indicator');
    const syncErrorModal = document.getElementById('syncErrorModal');
    const iframeModal = document.getElementById('iframeModal'), iframeModalContent = iframeModal.querySelector('.iframe-modal-content'), iframeEl = document.getElementById('iframeContent'), swipeHint = document.getElementById('swipeHint'), returnConfirmationToast = document.getElementById('returnConfirmationToast');
    let activeUploadXHR = null;
    const secureFileCache = new Map();
    let currentCategory = '';
    let photoObserver;

    const getDefaultConfig = () => ({ title: 'JellyfishCenter', subtitle: ' | By', categories: [{ name: '', buttons: [] }], settings: { paginationEnabled: true, jellyBall: { enabled: false, swipeBack: true, functions: {}, customCSS: '' } }, themePresets: [] });
    let currentConfig = getDefaultConfig();
    
    // ===== [START] FLOATING PROJECT WINDOW MANAGER =====
    const FloatingProjectWindowManager = (() => {
        const container = document.getElementById('floating-projects-container');
        let windows = {};
        const Z_INDEX_BASE = 2010;

        function create(id, title, url) {
            if (windows[id]) {
                const win = windows[id].element;
                win.style.transition = 'transform 0.2s ease, opacity 0.2s ease';
                win.style.transform = `${win.style.transform.replace(/scale$[^)]+$/, '')} scale(1.05)`;
                setTimeout(() => win.style.transform = win.style.transform.replace(/scale\([^)]+\)/, 'scale(1)'), 200);
                focus(id);
                return;
            }

            const winEl = document.createElement('div');
            winEl.className = 'floating-project-window';
            winEl.id = `fpw-${id}`;
            winEl.style.zIndex = Z_INDEX_BASE + Object.keys(windows).length;
            winEl.innerHTML = `
                <div class="fpw-header">
                    <span class="fpw-title">${title}</span>
                    <div class="fpw-controls">
                        <button class="fpw-hide" title=""></button>
                        <button class="fpw-close" title=""></button>
                    </div>
                </div>
                <div class="fpw-content">
                    <div class="fpw-resizer"></div>
                    <iframe src="${url}" frameborder="0" sandbox="allow-forms allow-modals allow-pointer-lock allow-popups allow-popups-to-escape-sandbox allow-presentation allow-same-origin allow-scripts allow-downloads"></iframe>
                </div>
            `;
            container.appendChild(winEl);

            const handleEl = document.createElement('div');
            handleEl.className = 'fpw-hide-handle';
            handleEl.id = `fpw-handle-${id}`;
            handleEl.textContent = title;
            container.appendChild(handleEl);

            windows[id] = {id, title, url, element: winEl, handle: handleEl };
            
            setTimeout(() => winEl.classList.add('visible'), 50);

            _attachEventListeners(winEl, handleEl, id);
            focus(id);
        }

        function focus(id) {
            let maxZ = Z_INDEX_BASE;
            Object.values(windows).forEach(win => {
                const currentZ = parseInt(win.element.style.zIndex);
                if (currentZ > maxZ) maxZ = currentZ;
            });

            const targetWindow = windows[id].element;
            if (parseInt(targetWindow.style.zIndex) <= maxZ) {
                targetWindow.style.zIndex = maxZ + 1;
            }
        }

// <--  -->

        function _attachEventListeners(winEl, handleEl, id) {
            const header = winEl.querySelector('.fpw-header');
            const resizer = winEl.querySelector('.fpw-resizer');

            // --- Drag Logic ---
 const startDrag = (e) => {
                // Prevent drag if a button was clicked
                if (e.target.closest('button')) return;
                e.preventDefault();
                focus(id);
                const isTouchEvent = e.type === 'touchstart';
                const startClientX = isTouchEvent ? e.touches[0].clientX : e.clientX;
                const startClientY = isTouchEvent ? e.touches[0].clientY : e.clientY;
                // ---  getComputedStyle  ---
                // getComputedStyle CSS style.left 
                const computedStyle = window.getComputedStyle(winEl);
                const initialLeft = parseFloat(computedStyle.left) || 0;
                const initialTop = parseFloat(computedStyle.top) || 0;
                
                // 
                const offsetX = startClientX - initialLeft;
                const offsetY = startClientY - initialTop;
                const onDragMove = (moveEvent) => {
                    const moveClientX = isTouchEvent ? moveEvent.touches[0].clientX : moveEvent.clientX;
                    const moveClientY = isTouchEvent ? moveEvent.touches[0].clientY : moveEvent.clientY;
                    
                    //  =  - 
                    let newX = moveClientX - offsetX;
                    let newY = moveClientY - offsetY;
                    winEl.style.left = `${newX}px`;
                    winEl.style.top = `${newY}px`;
                };
                const onDragEnd = () => {
                    if (isTouchEvent) {
                        document.removeEventListener('touchmove', onDragMove);
                        document.removeEventListener('touchend', onDragEnd);
                    } else {
                        document.removeEventListener('mousemove', onDragMove);
                        document.removeEventListener('mouseup', onDragEnd);
                    }
                };
                if (isTouchEvent) {
                    document.addEventListener('touchmove', onDragMove, { passive: false });
                    document.addEventListener('touchend', onDragEnd);
                } else {
                    document.addEventListener('mousemove', onDragMove);
                    document.addEventListener('mouseup', onDragEnd);
                }
            };
            header.addEventListener('mousedown', startDrag);
            header.addEventListener('touchstart', startDrag, { passive: false });

            // --- Resize Logic ---
            const startResize = (e) => {
                e.preventDefault();
                const isTouchEvent = e.type === 'touchstart';
                let startX = isTouchEvent ? e.touches[0].clientX : e.clientX;
                let startWidth = winEl.offsetWidth;
                let startHeight = winEl.offsetHeight;
                const aspectRatio = startWidth / startHeight;

                const onResizeMove = (moveEvent) => {
                    const moveClientX = isTouchEvent ? moveEvent.touches[0].clientX : moveEvent.clientX;
                    const dx = moveClientX - startX;
                    const newWidth = startWidth + dx;
                    if (newWidth >= parseFloat(winEl.style.minWidth || 250)) {
                        winEl.style.width = newWidth + 'px';
                        winEl.style.height = (newWidth / aspectRatio) + 'px';
                    }
                };

                const onResizeEnd = () => {
                     if (isTouchEvent) {
                        document.removeEventListener('touchmove', onResizeMove);
                        document.removeEventListener('touchend', onResizeEnd);
                    } else {
                        document.removeEventListener('mousemove', onResizeMove);
                        document.removeEventListener('mouseup', onResizeEnd);
                    }
                };

                if (isTouchEvent) {
                    document.addEventListener('touchmove', onResizeMove, { passive: false });
                    document.addEventListener('touchend', onResizeEnd);
                } else {
                    document.addEventListener('mousemove', onResizeMove);
                    document.addEventListener('mouseup', onResizeEnd);
                }
            };
            
            resizer.addEventListener('mousedown', startResize);
            resizer.addEventListener('touchstart', startResize, { passive: false });

            // --- Controls & Focus ---
            winEl.querySelector('.fpw-close').addEventListener('click', () => close(id));
            winEl.querySelector('.fpw-hide').addEventListener('click', () => hide(id));
            handleEl.addEventListener('click', () => show(id));
            winEl.addEventListener('mousedown', () => focus(id));
            winEl.addEventListener('touchstart', () => focus(id), { passive: true });
        }

// <--  -->


                const BASE_TOP_OFFSET = 20; // 
        const HANDLE_SPACING = 25;  // 

        /**
         * 
         */
        function _restackHandles() {
            const visibleHandles = Array.from(container.querySelectorAll('.fpw-hide-handle.visible'));
            visibleHandles.forEach((handle, index) => {
                handle.style.top = `${BASE_TOP_OFFSET + (index * HANDLE_SPACING)}px`;
            });
        }

        function hide(id) {
            const win = windows[id];
            if (!win) return;
            win.element.classList.remove('visible');
            
            setTimeout(() => {
                win.element.style.display = 'none';
                // 
                win.handle.style.left = '0px';
                win.handle.style.borderRadius = '0 8px 8px 0';
                win.handle.classList.add('visible');
                
                // 
                _restackHandles();
            }, 300);
        }

        function show(id) {
            const win = windows[id];
            if (!win) return;

            // 
            win.handle.classList.remove('visible');
            _restackHandles();

            win.element.style.display = 'flex';
            setTimeout(() => {
                win.element.classList.add('visible');
                focus(id);
            }, 50);
        }

        function close(id) {
            const win = windows[id];
            if (!win) return;
            
            // 
            const wasVisible = win.handle.classList.contains('visible');
            if(wasVisible) {
                win.handle.classList.remove('visible');
            }

            win.element.classList.remove('visible');
            
            setTimeout(() => {
                win.element.remove();
                win.handle.remove();
                delete windows[id];
                
                // 
                if (wasVisible) {
                    _restackHandles();
                }
            }, 300);
        }

        function closeAll() {
            for (const id in windows) {
                close(id);
            }
        }

        
        return { create, closeAll };
    })();
    // ===== [END] FLOATING PROJECT WINDOW MANAGER =====

    // ===== [START] FLOATING JELLYFISH BALL LOGIC (MODIFIED) =====
    const FloatingBallManager = (() => {
        let wrapper = null;
        let ball = null;
        let isDragging = false;
        let isLongPressActive = false;
        let startPos = { x: 0, y: 0 };
        let offset = { x: 0, y: 0 };
        let idleTimer = null;
        let longPressTimer = null;
        let activeMenuBtn = null;
        const LONG_PRESS_DURATION = 400; /* MODIFICATION: Shortened long-press time */
        const DRAG_THRESHOLD = 10;
        const ALL_FUNCTIONS = [
            { id: 'album', icon: '', title: '' },
            { id: 'folder', icon: '', title: '' },
            { id: 'return', icon: '', title: '' },
            { id: 'memo', icon: '', title: '' },
            { id: 'quick_switch', icon: '', title: '' }
        ];

        function _create() {
            if (currentConfig.settings.jellyBall?.enabled !== true) return;
            if (document.getElementById('floating-jellyfish-ball')) return;
            
            wrapper = document.createElement('div');
            wrapper.className = 'jelly-ball-wrapper';
            wrapper.innerHTML = `
                <div class="jelly-ball-glow"></div>
                <div id="floating-jellyfish-ball">
                   <span></span>
                   <div class="jelly-menu"></div>
                </div>
            `;
            document.body.appendChild(wrapper);
            ball = document.getElementById('floating-jellyfish-ball');
            
            _renderMenuButtons();
             
            let startPos = localStorage.getItem('jellyBallPosition');
            if (startPos) {
                startPos = JSON.parse(startPos);
                wrapper.style.top = `${startPos.y}px`;
                wrapper.style.left = `${startPos.x}px`;
            } else {
                wrapper.style.top = '80%';
                wrapper.style.left = '90%';
            }
            
            _addEventListeners();
            _resetIdleTimer();
        }

        function _renderMenuButtons() {
            if (!ball) return;
            const menu = ball.querySelector('.jelly-menu');
            menu.innerHTML = '';
            const enabledFunctions = _getEnabledFunctions();

            enabledFunctions.forEach(func => {
                const btnEl = document.createElement('button');
                btnEl.className = 'jelly-menu-btn';
                btnEl.innerHTML = func.icon;
                btnEl.title = func.title;
                btnEl.dataset.actionId = func.id;
                menu.appendChild(btnEl);
            });
        }
        
        function _destroy() { if (ball) { ball.parentElement.remove(); ball = null; wrapper = null; } clearTimeout(idleTimer); clearTimeout(longPressTimer); document.removeEventListener('mousemove', _onDragMove); document.removeEventListener('touchmove', _onDragMove); document.removeEventListener('mouseup', _onDragEnd); document.removeEventListener('touchend', _onDragEnd); }
        function _addEventListeners() { ball.addEventListener('mousedown', _onDragStart); ball.addEventListener('touchstart', _onDragStart, { passive: false }); document.addEventListener('click', (e) => { if (ball && !ball.contains(e.target)) _closeMenu(); }, true); }

        function _onDragStart(e) {
            if (ball.classList.contains('menu-open') && e.target.closest('.jelly-menu-btn')) return;
            e.preventDefault();
            
            clearTimeout(idleTimer);
            wrapper.classList.remove('idle', 'snap-left', 'snap-right');
            isDragging = false;
            isLongPressActive = false;
            activeMenuBtn = null;
            
            const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
            const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
            startPos = { x: clientX, y: clientY };
            const rect = wrapper.getBoundingClientRect();
            offset.x = clientX - rect.left;
            offset.y = clientY - rect.top;

            longPressTimer = setTimeout(() => { isLongPressActive = true; _toggleMenu(); longPressTimer = null; }, LONG_PRESS_DURATION);
            
            document.addEventListener('mousemove', _onDragMove);
            document.addEventListener('touchmove', _onDragMove, { passive: false });
            document.addEventListener('mouseup', _onDragEnd);
            document.addEventListener('touchend', _onDragEnd);
        }

        function _onDragMove(e) {
            const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
            const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

            if (isLongPressActive) { _handleMenuInteraction(clientX, clientY); return; }
            const dx = clientX - startPos.x;
            const dy = clientY - startPos.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (!isDragging && distance > DRAG_THRESHOLD) {
                e.preventDefault();
                isDragging = true;
                if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; }
                ball.classList.add('dragging');
                wrapper.classList.add('dragging');
                _closeMenu();
            }

            if (isDragging) {
                e.preventDefault();
                let newX = clientX - offset.x;
                let newY = clientY - offset.y;
                const ballSize = wrapper.offsetWidth;
                newX = Math.max(0, Math.min(newX, window.innerWidth - ballSize));
                newY = Math.max(0, Math.min(newY, window.innerHeight - ballSize));
                wrapper.style.left = `${newX}px`;
                wrapper.style.top = `${newY}px`;
            }
        }
        
        function _handleMenuInteraction(clientX, clientY) { const menuBtn=document.elementFromPoint(clientX,clientY)?.closest('.jelly-menu-btn'); if(activeMenuBtn&&activeMenuBtn!==menuBtn){activeMenuBtn.classList.remove('hovered');} if(menuBtn){menuBtn.classList.add('hovered'); activeMenuBtn=menuBtn;}else{activeMenuBtn=null;} }
        
        function _onDragEnd(e) {
            clearTimeout(longPressTimer);
            if (isLongPressActive) { if (activeMenuBtn) { _onMenuClick(activeMenuBtn); } _closeMenu(); } 
            else if (!isDragging) { /* Short click, do nothing for now */ } 
            else { _snapToEdge(); }
            
            ball.classList.remove('dragging');
            wrapper.classList.remove('dragging');
            if (activeMenuBtn) activeMenuBtn.classList.remove('hovered');

            isDragging = isLongPressActive = false; activeMenuBtn = null;
            _resetIdleTimer();

            document.removeEventListener('mousemove', _onDragMove);
            document.removeEventListener('touchmove', _onDragMove);
            document.removeEventListener('mouseup', _onDragEnd);
            document.removeEventListener('touchend', _onDragEnd);
        }
        
        function _snapToEdge() { const rect=wrapper.getBoundingClientRect(); const isRight=rect.left+rect.width/2>window.innerWidth/2; wrapper.style.left=`${isRight?window.innerWidth-rect.width:0}px`; localStorage.setItem('jellyBallPosition',JSON.stringify({x:wrapper.offsetLeft,y:wrapper.offsetTop})); }
        function _resetIdleTimer() { clearTimeout(idleTimer); wrapper.classList.remove('idle','snap-left','snap-right'); idleTimer=setTimeout(()=>{const rect=wrapper.getBoundingClientRect(); wrapper.classList.add((rect.left+rect.width/2)>window.innerWidth/2?'snap-right':'snap-left','idle'); _closeMenu(); },3000); }
        function _toggleMenu() { const isOpen=ball.classList.toggle('menu-open'); const menuBtns=ball.querySelectorAll('.jelly-menu-btn'); if(isOpen){const rect=wrapper.getBoundingClientRect();const n=menuBtns.length,r=65,m=10;let s,e;const c={x:rect.left+rect.width/2,y:rect.top+rect.height/2};if(c.x<r+m){s=-Math.PI/2;e=Math.PI/2;}else if(c.x>window.innerWidth-r-m){s=Math.PI/2;e=3*Math.PI/2;}else if(c.y<r+m){s=0;e=Math.PI;}else if(c.y>window.innerHeight-r-m){s=Math.PI;e=2*Math.PI;}else{s=-Math.PI/2;e=3*Math.PI/2;} const a=n>1?(e-s)/(n-1):0; menuBtns.forEach((b,i)=>{const t=s+i*a;b.style.setProperty('--transform-end',`translate(${Math.cos(t)*r}px, ${Math.sin(t)*r}px)`);});}}
        function _closeMenu(){ if(ball&&ball.classList.contains('menu-open')) ball.classList.remove('menu-open'); }
        
        function _onMenuClick(button){
            if(!button) return;
            const actionId = button.dataset.actionId;
            const memoryModal = document.getElementById('memoryModal');
            
            function openMemoryAndSwitch(viewName) {
                MemoryApp.open();
                memoryModal.style.zIndex = '2015'; // Ensure it's above floating windows
                const closeHandler=()=>{memoryModal.style.zIndex='';memoryModal.querySelector('.close-btn').removeEventListener('click',closeHandler);};
                memoryModal.querySelector('.close-btn').addEventListener('click',closeHandler,{once:true});
                memoryModal.querySelector(`[data-action="goto-${viewName}"]`)?.click();
            }

            switch(actionId) {
                case 'album': openMemoryAndSwitch('album'); break;
                case 'memo': openMemoryAndSwitch('memo'); break;
                case 'folder': openMemoryAndSwitch('cloud'); break;
                case 'return': if (iframeModal.classList.contains('active')) { closeIframeModal(); } break;
                case 'quick_switch': _showQuickSwitchMenu(); break;
            }
            _closeMenu();
        }

        function _showQuickSwitchMenu() {
            let existingMenu = document.getElementById('quick-switch-menu-overlay');
            if(existingMenu) existingMenu.remove();

            const overlay = document.createElement('div');
            overlay.id = 'quick-switch-menu-overlay';
            overlay.className = 'page-overlay show';
            overlay.style.zIndex = '9997';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            
            const menuContainer = document.createElement('div');
            menuContainer.id = 'quick-switch-menu';
            menuContainer.className = 'modal-content';
            menuContainer.style.maxWidth = '320px';
            menuContainer.style.maxHeight = '400px';

            menuContainer.innerHTML = `
                <div class="modal-header" style="padding-bottom: 10px; margin-bottom: 10px;">
                    <div class="modal-title-group"></div>
                    <button class="close-btn" style="width:30px; height:30px; font-size:20px;">&times;</button>
                </div>
                <div class="modal-body" style="gap: 12px; padding-bottom: 10px;">
                    <select id="qs-category-select" class="modal-select">
                        <option value="">--  --</option>
                    </select>
                    <select id="qs-project-select" class="modal-select" disabled>
                        <option value="">--  --</option>
                    </select>
                    <div id="qs-actions" style="display:none; justify-content: space-around; gap: 10px; margin-top: 10px;">
                        <button id="qs-open-float" class="modal-button" style="flex:1;"></button>
                        <button id="qs-open-full" class="modal-button" style="flex:1;"></button>
                    </div>
                </div>
            `;
            
            overlay.appendChild(menuContainer);
            document.body.appendChild(overlay);

            const categorySelect = menuContainer.querySelector('#qs-category-select');
            const projectSelect = menuContainer.querySelector('#qs-project-select');
            const actionsDiv = menuContainer.querySelector('#qs-actions');
            
            currentConfig.categories.forEach(cat => {
                categorySelect.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
            });

            categorySelect.onchange = () => {
                projectSelect.innerHTML = '<option value="">--  --</option>';
                projectSelect.disabled = true;
                actionsDiv.style.display = 'none';
                const catName = categorySelect.value;
                if (!catName) return;

                const category = currentConfig.categories.find(c => c.name === catName);
                if (category && category.buttons.length > 0) {
                     category.buttons.forEach(btn => {
                        projectSelect.innerHTML += `<option value="${btn.href}" data-text="${btn.text}">${btn.text}</option>`;
                     });
                     projectSelect.disabled = false;
                }
            };
            
            let selectedProject = null;
            projectSelect.onchange = () => {
                const selectedOption = projectSelect.options[projectSelect.selectedIndex];
                if (projectSelect.value) {
                    selectedProject = { url: selectedOption.value, title: selectedOption.dataset.text };
                    actionsDiv.style.display = 'flex';
                } else {
                    selectedProject = null;
                    actionsDiv.style.display = 'none';
                }
            };
            
            const closeMenu = () => { document.body.removeChild(overlay); };
            overlay.onclick = (e) => { if (e.target === overlay) closeMenu(); };
            menuContainer.querySelector('.close-btn').onclick = closeMenu;
            
            menuContainer.querySelector('#qs-open-float').onclick = () => {
                if(selectedProject) FloatingProjectWindowManager.create(Date.now(), selectedProject.title, selectedProject.url);
                closeMenu();
            };
            menuContainer.querySelector('#qs-open-full').onclick = () => {
                if(selectedProject) openIframeModal(selectedProject.url);
                closeMenu();
            };
        }


        function _getEnabledFunctions() { const settings=currentConfig.settings.jellyBall?.functions||{}; return ALL_FUNCTIONS.filter(func=>settings[func.id]!==false); }

        function initSettings() {
            const toggle = document.getElementById('jellyBallToggle');
            const swipeBackToggle = document.getElementById('jellySwipeBackToggle');
            const optionsContainer = document.getElementById('jelly-ball-options-container');
            const cssTextarea = document.getElementById('jellyBallCssTextarea');
            const applyCssBtn = document.getElementById('applyJellyBallCssBtn');
            const customStyleTag = document.getElementById('custom-jelly-ball-styles');
            const cssPreview = document.getElementById('jellyCssPreview');
            const previewBall = document.getElementById('jellyCssPreviewBall');
                        const checkboxContainer = document.getElementById('jelly-function-checkboxes');
            let previewStyleTag = document.getElementById('jelly-preview-style');
            if (!previewStyleTag) {
                previewStyleTag = document.createElement('style');
                previewStyleTag.id = 'jelly-preview-style';
                document.head.appendChild(previewStyleTag);
            }
            
            if (!currentConfig.settings.jellyBall) {
                currentConfig.settings.jellyBall = { enabled: false, swipeBack: true, functions: {}, customCSS: ''};
            }


            const settings = currentConfig.settings.jellyBall;
            toggle.checked = settings.enabled || false;
            swipeBackToggle.checked = settings.swipeBack !== false;
            
            checkboxContainer.innerHTML = '';
            ALL_FUNCTIONS.forEach(func => {
                const isChecked = settings.functions?.[func.id] !== false;
                const checkboxHtml = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                       <label for="jelly_func_${func.id}" style="cursor:pointer; display:flex; align-items:center; gap: 5px;">${func.icon} ${func.title}</label>
                       <label class="toggle-switch"><input type="checkbox" id="jelly_func_${func.id}" data-function-id="${func.id}" ${isChecked ? 'checked' : ''}><span class="slider"></span></label>
                    </div>`;
                checkboxContainer.innerHTML += checkboxHtml;
            });
            
            function updateUIVisibility() { optionsContainer.style.display = toggle.checked ? 'flex' : 'none'; }
            
            toggle.addEventListener('change', () => { settings.enabled = toggle.checked; updateUIVisibility(); if (settings.enabled) _create(); else _destroy(); saveGlobalConfig('Update Jellyfish Ball settings'); });
            swipeBackToggle.addEventListener('change', () => { settings.swipeBack = swipeBackToggle.checked; saveGlobalConfig('Update Jellyfish Ball settings'); });
            
            checkboxContainer.addEventListener('change', (e) => {
                const checkbox = e.target;
                if (checkbox.dataset.functionId) {
                    if (!settings.functions) settings.functions = {};
                    settings.functions[checkbox.dataset.functionId] = checkbox.checked;
                    _renderMenuButtons(); 
                    saveGlobalConfig('Update Jellyfish Ball settings');
                }
            });

            cssTextarea.value = settings.customCSS || '';
            customStyleTag.innerHTML = settings.customCSS || '';
            
                                    const updatePreview = () => {
                const previewCss = cssTextarea.value
                    .replace(/\.jelly-ball-wrapper/g, `#${cssPreview.id}`)
                    .replace(/#floating-jellyfish-ball/g, `#${previewBall.id}`)
                    .replace(/\.jelly-ball-glow/g, 'display:none');
                
                const styleTag = document.getElementById('jelly-preview-style');
                if (styleTag) {
                    styleTag.textContent = previewCss; //  textContent 
                    // 
                    void previewBall.offsetWidth; 
                }
            };



            cssTextarea.addEventListener('input', updatePreview);
            applyCssBtn.addEventListener('click', () => {
               settings.customCSS = cssTextarea.value;
               customStyleTag.innerHTML = settings.customCSS;
               if(ball) { _destroy(); _create(); } // Re-create to apply styles
               saveGlobalConfig('Update Jellyfish Ball settings');
               alert('');
            });
            
            updateUIVisibility();
            setTimeout(updatePreview, 100);

            // New: CSS help modal logic
            document.getElementById('show-jelly-css-help').addEventListener('click', () => {
                document.getElementById('jelly-css-help-modal').classList.add('show');
            });
        }

        return { init: initSettings, create: _create, destroy: _destroy };
    })();
    // ===== [END] FLOATING JELLYFISH BALL LOGIC =====

    const utf8_to_b64 = (str) => btoa(unescape(encodeURIComponent(str)));
    const b64_to_utf8 = (str) => decodeURIComponent(escape(atob(str)));

    function b64toBlob(b64Data, contentType = '', sliceSize = 512) {
        contentType = contentType || 'application/octet-stream';
        const byteCharacters = atob(b64Data);
        const byteArrays = [];
        for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
            const slice = byteCharacters.slice(offset, offset + sliceSize);
            const byteNumbers = new Array(slice.length);
            for (let i = 0; i < slice.length; i++) {
                byteNumbers[i] = slice.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            byteArrays.push(byteArray);
        }
        return new Blob(byteArrays, { type: contentType });
    }

    async function handleApiError(context, error) {
        let userMessage = `${context}`;
        const errorString = error.message || String(error);

        try {
            const errorJson = JSON.parse(errorString.substring(errorString.indexOf('{')));
            if (errorJson.message) {
                if (errorJson.message.includes("Not Found")) {
                    userMessage = `${context}`;
                } else if (errorJson.message.includes("Bad credentials")) {
                    userMessage = ` Personal Access Token `;
                } else if (errorJson.message.includes("requires authentication")) {
                    userMessage = ` Personal Access Token`;
                } else if (errorJson.message.includes("sha doesn't match")) {
                    userMessage = ``;
                } else if (errorJson.message.includes("path exists")) {
                    userMessage = `${context}`;
                } else {
                     userMessage = `${context}${errorJson.message}`;
                }
            }
        } catch (e) {
            if (errorString.includes('401') || errorString.includes('403')) {
                userMessage = ` Personal Access Token  'repo' `;
            } else if (errorString.includes('404')) {
                userMessage = `${context}`;
            } else if (errorString.toLowerCase().includes('failed to fetch') || errorString.toLowerCase().includes('networkerror')) {
                userMessage = '';
            } else if (errorString.includes('rate limit exceeded')) {
                userMessage = 'API';
            }
        }
        
        console.error(`API Error in context "${context}":`, error);
        return userMessage;
    }

    let syncStatusTimeout;
    function updateSyncStatus(status, message = '') {
        syncStatusIndicator.className = status;
        syncStatusIndicator.title = message || `: ${status}`;
        clearTimeout(syncStatusTimeout);
        if (status === 'synced') {
            syncStatusTimeout = setTimeout(() => {
                syncStatusIndicator.className = '';
                syncStatusIndicator.title = '';
            }, 3000);
            syncErrorModal.classList.remove('show');
        } else if (status === 'error') {
            document.getElementById('sync-error-message').textContent = message;
            syncErrorModal.classList.add('show');
        }
    }
    
    async function fetchFromGithub(path, endpoint = 'contents') {
        if (!checkConfig(false)) return { data: null, error: "GitHub" };
        if (endpoint === 'contents') updateSyncStatus('syncing', `...`);
        
        const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${endpoint}/${path}`;
        try {
            const response = await fetch(url, { headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` }, cache: 'no-cache' });
            if (response.status === 404) return { data: null, error: null, response };
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`${response.status}: ${JSON.stringify(errorData)}`);
            }
            const data = await response.json();
            if (endpoint === 'contents') updateSyncStatus('synced', '');
            return { data, response };
        } catch (error) {
            const userMessage = await handleApiError(` ${path}`, error);
            if (endpoint === 'contents') updateSyncStatus('error', userMessage);
            return { data: null, error: userMessage, response: null };
        }
    }

    async function saveToGithub(path, content, commitMessage, sha = null) {
        if (!checkConfig(true)) {
            updateSyncStatus('error', '');
            return { sha: null, error: "" };
        }
        updateSyncStatus('syncing', `: ${commitMessage}`);
        const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`;
        const body = { message: commitMessage, content: content, branch: 'main' };
        if (sha) { body.sha = sha; }

        try {
            const response = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` },
                body: JSON.stringify(body),
                cache: 'no-cache'
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                if (response.status === 409 || (errorData.message && errorData.message.includes("sha doesn't match"))) {
                    const conflictMessage = ``;
                    updateSyncStatus('error', conflictMessage);
                    return { sha: null, error: conflictMessage };
                }
                throw new Error(`${response.status}: ${JSON.stringify(errorData)}`);
            }

            const data = await response.json();
            updateSyncStatus('synced', '');
            return { sha: data.content.sha, error: null };
        } catch (error) {
            const userMessage = await handleApiError(` ${path}`, error);
            updateSyncStatus('error', userMessage);
            return { sha: null, error: userMessage };
        }
    }

    
    async function uploadFileViaGitData({ file, path, commitMessage, onProgress }) {
        if (!checkConfig(true)) throw new Error("GitHub");
        const { owner, repo, token, branch = 'main' } = GITHUB_CONFIG;

        const content = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });

        const blobUrl = `https://api.github.com/repos/${owner}/${repo}/git/blobs`;
        const blobResponse = await new Promise((resolve, reject) => {
            activeUploadXHR = new XMLHttpRequest();
            activeUploadXHR.open("POST", blobUrl, true);
            activeUploadXHR.setRequestHeader("Authorization", `token ${token}`);
            activeUploadXHR.setRequestHeader("Content-Type", "application/json");
            activeUploadXHR.upload.onprogress = (event) => { if (event.lengthComputable) onProgress((event.loaded / event.total) * 90); };
            activeUploadXHR.onload = () => {
                if (activeUploadXHR.status === 201) resolve(JSON.parse(activeUploadXHR.responseText));
                else reject(new Error(`${activeUploadXHR.status}: ${activeUploadXHR.responseText}`));
            };
            activeUploadXHR.onerror = () => reject(new Error("Blob"));
            activeUploadXHR.onabort = () => reject(new Error(""));
            activeUploadXHR.send(JSON.stringify({ content, encoding: "base64" }));
        });
        const blobSha = blobResponse.sha;
        activeUploadXHR = null;
        onProgress(95);

        const refUrl = `https://api.github.com/repos/${owner}/${repo}/git/refs/heads/${branch}`;
        const refData = await (await fetch(refUrl, { headers: { 'Authorization': `token ${token}` } })).json();
        const parentCommitSha = refData.object.sha;

        const treeUrl = `https://api.github.com/repos/${owner}/${repo}/git/trees`;
        const treeBody = { base_tree: parentCommitSha, tree: [{ path, mode: "100644", type: "blob", sha: blobSha }] };
        const treeData = await (await fetch(treeUrl, { method: 'POST', headers: { 'Authorization': `token ${token}` }, body: JSON.stringify(treeBody) })).json();
        const newTreeSha = treeData.sha;

        const commitUrl = `https://api.github.com/repos/${owner}/${repo}/git/commits`;
        const commitBody = { message: commitMessage, tree: newTreeSha, parents: [parentCommitSha] };
        const commitData = await (await fetch(commitUrl, { method: 'POST', headers: { 'Authorization': `token ${token}` }, body: JSON.stringify(commitBody) })).json();
        const newCommitSha = commitData.sha;

        await fetch(refUrl, { method: 'PATCH', headers: { 'Authorization': `token ${token}` }, body: JSON.stringify({ sha: newCommitSha }) });
        onProgress(100);
        return { sha: blobSha, path };
    }

    async function deleteFromGithub(path, commitMessage, sha, ignoreNotFound = false) {
        if (!checkConfig(true)) return false;
        const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents}/${path}`;
        try {
            const response = await fetch(url, {
                method: 'DELETE',
                headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` },
                body: JSON.stringify({ message: commitMessage, sha: sha, branch: 'main' }),
                cache: 'no-cache'
            });
            if (response.status === 404 && ignoreNotFound) {
                console.log(`File ${path} not found during deletion, which is acceptable.`);
                return true;
            }
            if (!response.ok) {
                 const errorData = await response.json().catch(() => ({}));
                 throw new Error(`${response.status}: ${JSON.stringify(errorData)}`);
            }
            return true;
        } catch (error) {
            const userMessage = await handleApiError(` ${path.split('/').pop()}`, error);
            console.error(userMessage);
            return false;
        }
    }

    async function fetchConfigFromGithub() {
        const { data, error } = await fetchFromGithub('config.json');
        if (error && error !== "GitHub") {
             navContainer.innerHTML = `<p id="loading-status" style="text-align: center; color: #e53e3e;">${error}</p>`;
             return null;
        }
        if (data) {
            configSha = data.sha;
            try {
                return JSON.parse(b64_to_utf8(data.content));
            } catch (e) {
                alert(' config.json ');
                return null;
            }
        }
        return null;
    }
    
    async function saveGlobalConfig(commitMessage) {
        const content = utf8_to_b64(JSON.stringify(currentConfig, null, 2));
        const result = await saveToGithub('config.json', content, commitMessage, configSha);
        if (result.sha) {
            configSha = result.sha;
            console.log('Global configuration saved successfully.');
        } else {
            // Error handling is managed inside saveToGithub
        }
    }
    
    function toggleManagementMode(forceState) {
        isManagementMode = forceState !== undefined ? forceState : !isManagementMode;
        pageOverlay.classList.toggle('show', isManagementMode);
        pageOverlay.classList.toggle('management-overlay', isManagementMode);
        document.body.classList.toggle('management-active', isManagementMode);
        document.querySelectorAll('.nav-btn').forEach(btn => {
            const deleteIcon = btn.querySelector('.delete-icon');
            if (isManagementMode) {
                 btn.title = '  ';
                if (!deleteIcon) {
                    const icon = document.createElement('span');
                    icon.className = 'delete-icon';
                    icon.innerHTML = '&times;';
                    icon.title = '';
                    btn.appendChild(icon);
                }
            } else {
                btn.title = '';
                if (deleteIcon) {
                    deleteIcon.remove();
                }
            }
        });
    }

    pageOverlay.addEventListener('click', (e) => { if (isManagementMode && !e.target.closest('.nav-btn')) { toggleManagementMode(false); } if (fabContainer.classList.contains('active')) { toggleFabMenu(false); } });
    const fabContainer = document.getElementById('fabContainer'), fabMainBtn = document.getElementById('themeBtn');
    let fabPressTimer = null, isFabLongPress = false;
    function toggleFabMenu(forceState) { const isActive = forceState !== undefined ? forceState : !fabContainer.classList.contains('active'); fabContainer.classList.toggle('active', isActive); if (!isManagementMode) pageOverlay.classList.toggle('show', isActive); }
    fabMainBtn.addEventListener('mousedown', (e) => { e.preventDefault(); isFabLongPress = false; fabPressTimer = setTimeout(() => { isFabLongPress = true; toggleFabMenu(true); }, 300); });
    fabMainBtn.addEventListener('mouseup', () => { clearTimeout(fabPressTimer); if (!isFabLongPress) { fabContainer.classList.contains('active') ? toggleFabMenu(false) : toggleTheme(); } });
    fabMainBtn.addEventListener('contextmenu', e => e.preventDefault());
    fabMainBtn.addEventListener('touchstart', e => { e.preventDefault(); fabMainBtn.dispatchEvent(new MouseEvent('mousedown')); }, { passive: false });
    fabMainBtn.addEventListener('touchend', e => { e.preventDefault(); fabMainBtn.dispatchEvent(new MouseEvent('mouseup')); }, { passive: false });
    
    function attachButtonListeners(btn) {
        btn.addEventListener('click', async function(e) {
            if (isManagementMode) {
                const href = this.dataset.href;
                if (!e.target.classList.contains('delete-icon')) {
                    e.preventDefault();
                    const buttonData = findButtonConfigByHref(href);
                    if (buttonData) {
                        openEditModal(buttonData);
                    }
                }
                return;
            }
            const href = this.dataset.href;
            if (!href) return;

            const buttonConfig = findButtonConfigByHref(href);

            if (buttonConfig && buttonConfig.openExternally) {
                window.open(href, '_blank', 'noopener,noreferrer');
                return;
            }

            if (href.startsWith('projects/')) {
                e.preventDefault();
                const secureUrl = await getSecureFileUrl(href);
                if(secureUrl) {
                    openIframeModal(secureUrl);
                } else {
                     alert('GitHub');
                }
            } else if (href.startsWith('http')) {
                e.preventDefault();
                const isGithubLink = ['github.com', 'raw.githack.com', 'github.io'].some(domain => href.includes(domain));
                if (isGithubLink) {
                    if (!confirm(" GitHub  VPN \n\n")) {
                        return;
                    }
                }
                openIframeModal(href);
            } else {
                window.location.href = href;
            }
        });
    }

    function findButtonConfigByHref(href) {
        for (const category of currentConfig.categories) {
            const button = category.buttons.find(b => b.href === href);
            if (button) return { ...button, categoryName: category.name };
        }
        return null;
    }

    document.getElementById('enterManageModeBtn').addEventListener('click', () => { document.getElementById('addNavModal').classList.remove('show'); setTimeout(() => toggleManagementMode(true), 150); });
    navContainer.addEventListener('click', async (e) => { 
        if (!e.target.classList.contains('delete-icon')) return; 
        e.stopPropagation();
        const btnToDelete = e.target.closest('.nav-btn'); 
        const buttonName = btnToDelete.firstChild.textContent.trim(); 
        if (!confirm(` "${buttonName}" \nGitHub`)) return; 
        btnToDelete.style.cssText = 'transition: all 0.3s ease; transform: scale(0.8); opacity: 0;'; 
        setTimeout(async () => { 
            btnToDelete.remove(); 
            const href = btnToDelete.dataset.href; 
            let categoryModified = false;
            currentConfig.categories.forEach(cat => {
                const initialLength = cat.buttons.length;
                cat.buttons = cat.buttons.filter(b => b.href !== href);
                if (cat.buttons.length < initialLength) categoryModified = true;
            });

            currentConfig.categories = currentConfig.categories.filter(cat => cat.name === '' || cat.buttons.length > 0);

            if (href.startsWith('projects/')) {
                const folderPath = href.substring(0, href.lastIndexOf('/'));
                const success = await deleteGithubFolder(folderPath);
                if (!success) { alert('!'); location.reload(); return; }
            }
            if (categoryModified) {
                await saveGlobalConfig(`Delete button: ${buttonName}`);
                renderCategories();
                renderButtonsForCategory(currentCategory);
            }
        }, 300); 
    });
    document.getElementById('title').addEventListener('click', () => { if(isManagementMode) return; const newTitle = prompt('', currentConfig.title); if (newTitle?.trim() && newTitle.trim() !== currentConfig.title) { document.getElementById('title').textContent = newTitle.trim(); currentConfig.title = newTitle.trim(); saveGlobalConfig('Update main title'); } });
    document.getElementById('subtitle').addEventListener('click', () => { if(isManagementMode) return; const newSubtitle = prompt('', currentConfig.subtitle); if (newSubtitle !== null && newSubtitle.trim() !== currentConfig.subtitle) { document.getElementById('subtitle').textContent = newSubtitle.trim(); currentConfig.subtitle = newSubtitle.trim(); saveGlobalConfig('Update subtitle'); } });
    
    function applyAllBackgrounds() {
        const isDark = document.body.classList.contains('dark-mode');
        const bodyBgKey = isDark ? 'nightBgImage' : 'dayBgImage';
        const bodyBgImage = localStorage.getItem(bodyBgKey);
        
        if (bodyBgImage) {
            document.body.style.backgroundImage = `url(${bodyBgImage})`;
        } else {
            const color1 = getComputedStyle(document.documentElement).getPropertyValue(isDark ? '--night-color1' : '--day-color1').trim();
            const color2 = getComputedStyle(document.documentElement).getPropertyValue(isDark ? '--night-color2' : '--day-color2').trim();
            document.body.style.backgroundImage = `linear-gradient(135deg, ${color1} 0%, ${color2} 100%)`;
        }

        const titleCardBgKey = isDark ? 'nightTitleCardBgImage' : 'dayTitleCardBgImage';
        const titleCardBgImage = localStorage.getItem(titleCardBgKey);
        const titleCard = document.getElementById('titleCard');
        if (titleCardBgImage) {
            titleCard.style.backgroundImage = `url(${titleCardBgImage})`;
            titleCard.style.backgroundSize = 'cover';
            titleCard.style.backgroundPosition = 'center';
        } else {
            titleCard.style.backgroundImage = isDark ? 'var(--bg-night-element)' : 'var(--bg-day-element)';
        }
    }
    
    function initTheme() { 
        const t=localStorage.getItem('theme'); 
        if (t==='dark' || (!t && window.matchMedia('(prefers-color-scheme: dark)').matches)) { 
            document.body.classList.add('dark-mode'); 
            fabMainBtn.textContent = ''; 
        } else { 
            fabMainBtn.textContent = ''; 
        }
        applyAllBackgrounds();
        const savedThemeStyle = localStorage.getItem('themeStyle') || 'neumorphism';
        setThemeStyle(savedThemeStyle);
    }
    function toggleTheme() { 
        document.body.classList.toggle('dark-mode'); 
        const i=document.body.classList.contains('dark-mode'); 
        fabMainBtn.textContent=i?'':''; 
        localStorage.setItem('theme', i?'dark':'light');
        applyAllBackgrounds();
        WanderView.updateTheme();
    };

    function setThemeStyle(styleName) {
        const pneumorphismSettings = document.getElementById('pneumorphism-settings');
        if (styleName === 'glass') {
            document.body.classList.add('theme-glass');
            document.documentElement.style.setProperty('--shadow-dark-night', 'rgba(0, 0, 0, 0.1)');
            document.documentElement.style.setProperty('--shadow-dark-day', 'rgba(0, 0, 0, 0.1)');

            pneumorphismSettings.classList.add('hidden');
            document.getElementById('theme-style-glass').checked = true;
        } else {
            document.body.classList.remove('theme-glass');
            document.documentElement.style.setProperty('--shadow-dark-day', 'rgba(174, 190, 212, 0.4)');
             document.documentElement.style.setProperty('--shadow-dark-night', 'rgba(0, 0, 0, 0.3)');
            pneumorphismSettings.classList.remove('hidden');
            document.getElementById('theme-style-neumorphism').checked = true;
        }
        localStorage.setItem('themeStyle', styleName);
    }
    document.querySelectorAll('input[name="theme-style"]').forEach(radio => {
        radio.addEventListener('change', (e) => setThemeStyle(e.target.value));
    });

    const colorModal = { pickerD1: document.getElementById('dayColor1Picker'), hexD1: document.getElementById('dayColor1Hex'), pickerD2: document.getElementById('dayColor2Picker'), hexD2: document.getElementById('dayColor2Hex'), pickerN1: document.getElementById('nightColor1Picker'), hexN1: document.getElementById('nightColor1Hex'), pickerN2: document.getElementById('nightColor2Picker'), hexN2: document.getElementById('nightColor2Hex'), presetName: document.getElementById('presetNameInput'), presetSelector: document.getElementById('presetSelector'), saveBtn: document.getElementById('savePresetBtn'), updateBtn: document.getElementById('updatePresetBtn'), deleteBtn: document.getElementById('deletePresetBtn'), randomToggle: document.getElementById('randomPaletteToggle'), dayPreview: document.getElementById('dayPreview'), nightPreview: document.getElementById('nightPreview') };
    const root = document.documentElement; function applyColors(colors, saveToLocal = true) { Object.entries(colors).forEach(([key, value]) => { const cssVar = `--${key.replace('Color', '-color')}`; root.style.setProperty(cssVar, value); if (saveToLocal) localStorage.setItem(key, value); }); updateColorUI(colors); applyAllBackgrounds(); WanderView.updateTheme(); }
    function updateColorUI(colors) { colorModal.pickerD1.value = colors.dayColor1; colorModal.hexD1.textContent = colors.dayColor1; colorModal.pickerD2.value = colors.dayColor2; colorModal.hexD2.textContent = colors.dayColor2; colorModal.pickerN1.value = colors.nightColor1; colorModal.hexN1.textContent = colors.nightColor1; colorModal.pickerN2.value = colors.nightColor2; colorModal.hexN2.textContent = colors.nightColor2; colorModal.dayPreview.style.background = `linear-gradient(135deg, ${colors.dayColor2}, ${colors.dayColor1})`; colorModal.nightPreview.style.background = `linear-gradient(135deg, ${colors.nightColor2}, ${colors.nightColor1})`; }
    function getCurrentColors(fromLocalStorage = true) { const source = fromLocalStorage ? localStorage : { getItem: (key) => getComputedStyle(root).getPropertyValue(`--${key.replace('Color', '-color')}`).trim() }; return { dayColor1: source.getItem('dayColor1') || '#f5f7fa', dayColor2: source.getItem('dayColor2') || '#e4eaf5', nightColor1: source.getItem('nightColor1') || '#1f2a40', nightColor2: source.getItem('nightColor2') || '#16213e', }; }
    function setupColorSync(picker, hexDisplay, key) { picker.addEventListener('input', () => { hexDisplay.textContent = picker.value; applyColors({ ...getCurrentColors(), [key]: picker.value }); }); }
    function loadColorState() { populatePresetDropdown(); const randomPaletteEnabled = localStorage.getItem('randomPaletteEnabled') === 'true'; colorModal.randomToggle.checked = randomPaletteEnabled; if (randomPaletteEnabled && currentConfig.themePresets && currentConfig.themePresets.length > 0) { const randomPreset = currentConfig.themePresets[Math.floor(Math.random() * currentConfig.themePresets.length)]; applyColors(randomPreset.colors, false); } else { applyColors(getCurrentColors()); } }
    function populatePresetDropdown() { colorModal.presetSelector.innerHTML = '<option value="">...</option>'; (currentConfig.themePresets || []).forEach((p, i) => { const opt = document.createElement('option'); opt.value = i; opt.textContent = p.name; colorModal.presetSelector.appendChild(opt); }); }
    colorModal.saveBtn.addEventListener('click', () => { const name = colorModal.presetName.value.trim(); if (!name) return alert(''); if ((currentConfig.themePresets || []).some(p => p.name === name)) return alert(''); if (!currentConfig.themePresets) currentConfig.themePresets = []; currentConfig.themePresets.push({ name, colors: getCurrentColors(false) }); saveGlobalConfig(`Save theme preset: ${name}`); populatePresetDropdown(); colorModal.presetSelector.value = currentConfig.themePresets.length - 1; colorModal.presetName.value = ''; });
    colorModal.updateBtn.addEventListener('click', () => { const index = colorModal.presetSelector.value; if (index === '' || !currentConfig.themePresets) return alert(''); const name = colorModal.presetName.value.trim() || currentConfig.themePresets[index].name; currentConfig.themePresets[index] = { name, colors: getCurrentColors(false) }; saveGlobalConfig(`Update theme preset: ${name}`); populatePresetDropdown(); colorModal.presetSelector.value = index; });
    colorModal.deleteBtn.addEventListener('click', () => { const index = colorModal.presetSelector.value; if (index === '' || !currentConfig.themePresets) return alert(''); const presetName = currentConfig.themePresets[index].name; if (!confirm(` "${presetName}"?`)) return; currentConfig.themePresets.splice(index, 1); saveGlobalConfig(`Delete theme preset: ${presetName}`); populatePresetDropdown(); });
    colorModal.presetSelector.addEventListener('change', () => { const index = colorModal.presetSelector.value; if (index === '' || !currentConfig.themePresets) return; applyColors(currentConfig.themePresets[index].colors); colorModal.presetName.value = currentConfig.themePresets[index].name; });
    colorModal.randomToggle.addEventListener('change', () => { localStorage.setItem('randomPaletteEnabled', colorModal.randomToggle.checked); });
    
    function setupBgImageManager() {
        const setupPicker = (pickerId, uploadBtnId, clearBtnId, statusId, storageKey, storageNameKey) => {
            const picker = document.getElementById(pickerId);
            document.getElementById(uploadBtnId).addEventListener('click', () => picker.click());
            document.getElementById(clearBtnId).addEventListener('click', () => {
                localStorage.removeItem(storageKey);
                localStorage.removeItem(storageNameKey);
                applyAllBackgrounds();
                updateBgStatus();
            });
            picker.addEventListener('change', e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    localStorage.setItem(storageKey, event.target.result);
                    localStorage.setItem(storageNameKey, file.name);
                    applyAllBackgrounds();
                    updateBgStatus();
                };
                reader.readAsDataURL(file);
            });
        };
        setupPicker('dayBgImagePicker', 'uploadDayBgBtn', 'clearDayBgBtn', 'dayBgStatus', 'dayBgImage', 'dayBgImageName');
        setupPicker('nightBgImagePicker', 'uploadNightBgBtn', 'clearNightBgBtn', 'nightBgStatus', 'nightBgImage', 'nightBgImageName');
        setupPicker('dayTitleCardBgImagePicker', 'uploadDayTitleCardBgBtn', 'clearDayTitleCardBgBtn', 'dayTitleCardBgStatus', 'dayTitleCardBgImage', 'dayTitleCardBgImageName');
        setupPicker('nightTitleCardBgImagePicker', 'uploadNightTitleCardBgBtn', 'clearNightTitleCardBgBtn', 'nightTitleCardBgStatus', 'nightTitleCardBgImage', 'nightTitleCardBgImageName');
    }
    
    function updateBgStatus() {
        document.getElementById('dayBgStatus').textContent = localStorage.getItem('dayBgImageName') || '';
        document.getElementById('nightBgStatus').textContent = localStorage.getItem('nightBgImageName') || '';
        document.getElementById('dayTitleCardBgStatus').textContent = localStorage.getItem('dayTitleCardBgImageName') || '';
        document.getElementById('nightTitleCardBgStatus').textContent = localStorage.getItem('nightTitleCardBgImageName') || '';
    }
    
    const settingsModalElements = { githubRepoInput: document.getElementById("githubRepoInput"), githubTokenInput: document.getElementById("githubTokenInput"), saveSettingsBtn: document.getElementById("saveSettingsBtn"), manualSyncBtn: document.getElementById('manualSyncBtn') };
    function setupModals(){document.querySelectorAll(".close-btn").forEach(e=>e.addEventListener("click",()=>{document.getElementById(e.dataset.modalId).classList.remove("show")})),document.querySelectorAll(".modal-overlay").forEach(e=>e.addEventListener("click",t=>e===t.target&&e.classList.remove("show"))),document.getElementById("helpBtn").addEventListener("click",()=>{document.getElementById("helpModal").classList.add("show"),toggleFabMenu(!1);localStorage.setItem('lastSeenVersion', CURRENT_APP_VERSION);document.getElementById('helpBtn').classList.remove('has-update');}),document.getElementById("dataSyncBtn").addEventListener("click",()=>{GITHUB_CONFIG.owner&&GITHUB_CONFIG.repo&&(settingsModalElements.githubRepoInput.value=`${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}`),settingsModalElements.githubTokenInput.value=GITHUB_CONFIG.token||"",document.getElementById("settingsModal").classList.add("show"),toggleFabMenu(!1)}),document.getElementById("addNavBtn").addEventListener("click",()=>{openAddModal(); toggleFabMenu(false);}),document.getElementById("colorBtn").addEventListener("click", ()=>{document.getElementById("colorPaletteModal").classList.add("show"); updateColorUI(getCurrentColors()); updateBgStatus(); toggleFabMenu(false);}),document.getElementById("memoryBtn").addEventListener('click', () => { MemoryApp.open(); toggleFabMenu(false); }), document.getElementById('jelly-css-help-modal').querySelectorAll('.copy-btn').forEach(btn => { btn.addEventListener('click', async (e) => { const textBlock = e.target.parentElement; const textToCopy = textBlock.innerText.replace(e.target.innerText, '').trim(); try { await navigator.clipboard.writeText(textToCopy); const originalText = e.target.textContent; e.target.textContent = '!'; setTimeout(() => { e.target.textContent = originalText; }, 1500); } catch (err) { alert(''); } }); });}
    function saveGithubConfig(e){localStorage.setItem("githubConfig",JSON.stringify(e)),GITHUB_CONFIG=e}function loadGithubConfig(){const e=localStorage.getItem("githubConfig");e&&(GITHUB_CONFIG=JSON.parse(e))}function checkConfig(e=!0){return!GITHUB_CONFIG.owner||!GITHUB_CONFIG.repo||!GITHUB_CONFIG.token?(e&&alert("GitHub\n( -> )"),!1):!0}
    
    function isObject(item) { return (item && typeof item === 'object' && !Array.isArray(item)); }
    function mergeDeep(target, ...sources) {
        if (!sources.length) return target;
        const source = sources.shift();
        if (isObject(target) && isObject(source)) {
            for (const key in source) {
                if (isObject(source[key])) {
                    if (!target[key]) Object.assign(target, { [key]: {} });
                    mergeDeep(target[key], source[key]);
                } else {
                    Object.assign(target, { [key]: source[key] });
                }
            }
        }
        return mergeDeep(target, ...sources);
    }
    
    function migrateLegacyConfig(config) {
        if (!config) return { migratedConfig: config, wasMigrated: false };

        let wasModified = false;

        if (!Array.isArray(config.categories)) {
            config.categories = [];
            wasModified = true;
            console.log("Migration: 'categories' array not found, created a new one.");
        }

        let allCategory = config.categories.find(c => c.name === '');
        if (!allCategory) {
            allCategory = { name: '', buttons: [] };
            config.categories.unshift(allCategory);
            wasModified = true;
            console.log("Migration: Default '' category not found, created a new one.");
        }

        if (Array.isArray(config.buttons) && config.buttons.length > 0) {
            console.log(`Migration: Found ${config.buttons.length} orphaned buttons at the root level. Merging...`);
            const allCategoryButtonHrefs = new Set(allCategory.buttons.map(b => b.href));

            config.buttons.forEach(orphanButton => {
                if (!allCategoryButtonHrefs.has(orphanButton.href)) {
                    allCategory.buttons.push(orphanButton);
                    console.log(`  -> Merged button: "${orphanButton.text}"`);
                } else {
                    console.log(`  -> Skipped duplicate button: "${orphanButton.text}"`);
                }
            });
            
            wasModified = true;
        }

        if (config.hasOwnProperty('buttons')) {
            delete config.buttons;
            console.log("Migration: Cleaned up legacy root 'buttons' array.");
        }

        return { migratedConfig: config, wasMigrated: wasModified };
    }


    settingsModalElements.manualSyncBtn.addEventListener("click", async () => {
        if (!checkConfig(true)) return;
        const btn = settingsModalElements.manualSyncBtn;
        const originalText = btn.textContent;
        btn.disabled = true;

        try {
            btn.textContent = '...';
            let fetchedConfig = await fetchConfigFromGithub();
            
            const defaultConfig = getDefaultConfig();
            let needsSave = false;
            let wasMigrated = false;
            
            if (fetchedConfig) {
                 btn.textContent = '...';
                 const migrationResult = migrateLegacyConfig(fetchedConfig);
                 fetchedConfig = migrationResult.migratedConfig;
                 wasMigrated = migrationResult.wasMigrated;
                 if (wasMigrated) btn.textContent = '...';

                 const mergedConfig = mergeDeep({}, defaultConfig, fetchedConfig);
                 if (JSON.stringify(mergedConfig) !== JSON.stringify(fetchedConfig) || wasMigrated) {
                     currentConfig = mergedConfig;
                     needsSave = true;
                 }
            } else {
                 btn.textContent = '...';
                 currentConfig = defaultConfig;
                 configSha = null;
                 needsSave = true;
            }
            
            if (needsSave) {
                 btn.textContent = '...';
                 await saveGlobalConfig(wasMigrated ? 'Manual sync: Migrated legacy config' : 'Manual sync and repair');
                 btn.textContent = '';
                 alert("");
                 location.reload();
            } else {
                 btn.textContent = '';
                 alert("");
            }
        } catch (e) {
            btn.textContent = '';
            alert(`: ${e.message}`);
        } finally {
            setTimeout(() => {
                btn.disabled = false;
                btn.textContent = originalText;
            }, 3000);
        }
    });

    async function loadInitialData() { 
        navContainer.innerHTML = '<p id="loading-status" style="text-align: center; color: #889;">...</p>'; 
        let fetchedConfig = await fetchConfigFromGithub(); 
        
        let needsSave = false;
        let wasMigrated = false;

        if (fetchedConfig) {
            const migrationResult = migrateLegacyConfig(fetchedConfig);
            fetchedConfig = migrationResult.migratedConfig;
            if (migrationResult.wasMigrated) {
                needsSave = true;
                wasMigrated = true;
                console.log("Config was migrated, scheduling an auto-save.");
            }
        }

        let mergedConfig = getDefaultConfig();
        if (fetchedConfig) {
            currentConfig = mergeDeep({}, mergedConfig, fetchedConfig);
            if (JSON.stringify(currentConfig) !== JSON.stringify(fetchedConfig)) {
                needsSave = true;
                console.log("Config updated with new fields from default template.");
            }
        } else {
            console.log('Config.json not found or invalid. Using default and attempting to create.');
            currentConfig = mergedConfig;
            configSha = null;
            needsSave = true;
        }

        if (needsSave) {
            await saveGlobalConfig(wasMigrated ? 'Auto-migrate legacy config format' : 'Auto-create or repair config.json');
        }

        document.getElementById('title').textContent = currentConfig.title; 
        document.getElementById('subtitle').textContent = currentConfig.subtitle; 
        document.querySelector('.editable-title').style.opacity = 1; 
        document.querySelector('.editable-subtitle').style.opacity = 1; 
        
        currentCategory = localStorage.getItem('lastSelectedCategory') || '';
        if (!currentConfig.categories.some(c => c.name === currentCategory)) {
            currentCategory = '';
        }
        
        renderCategories();
        loadColorState(); 
    }
    
    function renderCategories() {
        const navContainerEl = document.getElementById('categoryNavContainer');
        if (!currentConfig.settings) {
            currentConfig.settings = { paginationEnabled: true };
        }
        const paginationEnabled = currentConfig.settings.paginationEnabled !== false; // Default to true
        navContainerEl.style.display = paginationEnabled ? 'block' : 'none';
        
        const categoryNav = document.getElementById('categoryNav');
        categoryNav.innerHTML = '';

        if(paginationEnabled) {
            currentConfig.categories.forEach(cat => {
                const pill = document.createElement('button');
                pill.className = 'category-pill';
                pill.textContent = cat.name;
                pill.dataset.category = cat.name;
                if (cat.name === currentCategory) {
                    pill.classList.add('active');
                }
                categoryNav.appendChild(pill);
            });
        }
        
        const categoryToRender = paginationEnabled ? currentCategory : '';
        renderButtonsForCategory(categoryToRender);
    }

    document.getElementById('categoryNav').addEventListener('click', (e) => {
        if (e.target.classList.contains('category-pill')) {
            const categoryName = e.target.dataset.category;
            currentCategory = categoryName;
            localStorage.setItem('lastSelectedCategory', categoryName);
            document.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active'));
            e.target.classList.add('active');
            renderButtonsForCategory(categoryName);
        }
    });

    function renderButtonsForCategory(categoryName) {
        navContainer.innerHTML = '';
        let buttons = [];

        if (currentConfig.settings.paginationEnabled === false) {
             categoryName = '';
        }
        
        if (categoryName === '') {
            const allButtons = new Map();
            currentConfig.categories.forEach(cat => {
                cat.buttons.forEach(btn => {
                    if (!allButtons.has(btn.href)) {
                        allButtons.set(btn.href, btn);
                    }
                });
            });
            buttons = Array.from(allButtons.values());
        } else {
            const category = currentConfig.categories.find(c => c.name === categoryName);
            buttons = category ? category.buttons : [];
        }

        if (buttons.length === 0) {
            navContainer.innerHTML = '<p id="loading-status" style="text-align: center; color: #889;"></p>';
        } else {
            buttons.forEach(item => addNewButtonToDOM(item.text, item.href, false));
        }
    }

    async function deleteGithubFolder(folderPath) { if (!checkConfig(true)) return false; const contentsUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${folderPath}`; try { const contentsResponse = await fetch(contentsUrl, { headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` }, cache: 'no-cache' }); if (contentsResponse.status === 404) { console.log(`Folder "${folderPath}" not found, nothing to delete.`); return true; } if (!contentsResponse.ok) throw new Error(`Could not list folder: ${contentsResponse.statusText}`); const files = await contentsResponse.json(); for (const file of files) { await deleteFromGithub(file.path, `Recursive delete: ${file.path}`, file.sha); } return true; } catch (error) { console.error(`Failed to delete folder "${folderPath}":`, error); return false; } }
    
    settingsModalElements.saveSettingsBtn.addEventListener("click",async()=>{const[e,t]=settingsModalElements.githubRepoInput.value.trim().split("/").map(e=>e.trim()),n=settingsModalElements.githubTokenInput.value.trim();if(e&&t&&n){saveGithubConfig({owner:e,repo:t,token:n,branch:"main"}),alert("..."),document.getElementById("settingsModal").classList.remove("show"), location.reload() }else{alert("")}});

    const addNavModalElements={modal: document.getElementById('addNavModal'), title: document.getElementById('addNavModalTitle'), typeLinkRadio:document.getElementById("type-link"),typeUploadRadio:document.getElementById("type-upload"),linkSection:document.getElementById("link-section"),uploadSection:document.getElementById("upload-section"),categoryInput:document.getElementById("newButtonCategoryInput"),nameInput:document.getElementById("newButtonNameInput"),urlInput:document.getElementById("newButtonUrlInput"),openExternallyToggle:document.getElementById("openExternallyToggle"),filePickerBtn:document.getElementById("filePickerBtn"),projectHtmlPicker:document.getElementById("projectHtmlPicker"),fileStatus:document.getElementById("file-picker-status"),createBtn:document.getElementById("createNavBtn"),uploadStatus:document.getElementById("upload-status"),stayOpenToggle:document.getElementById("stayOpenToggle"), paginationToggle: document.getElementById('paginationToggle'), categoryMgmtSection: document.getElementById('category-management-section'), deleteCategoryBtn: document.getElementById('deleteCategoryBtn')};
    
    function updateAddNavModalUI() {
        const paginationEnabled = currentConfig.settings.paginationEnabled !== false;
        addNavModalElements.paginationToggle.checked = paginationEnabled;
        const selectedCategory = addNavModalElements.categoryInput.value.trim();
        const showDeleteBtn = selectedCategory && selectedCategory !== '' && currentConfig.categories.some(c => c.name === selectedCategory);
        addNavModalElements.categoryMgmtSection.style.display = showDeleteBtn ? 'block' : 'none';
    }
    
    addNavModalElements.paginationToggle.addEventListener('change', () => {
        currentConfig.settings.paginationEnabled = addNavModalElements.paginationToggle.checked;
        saveGlobalConfig('Toggle pagination setting');
        renderCategories();
    });

    addNavModalElements.categoryInput.addEventListener('input', updateAddNavModalUI);
    addNavModalElements.deleteCategoryBtn.addEventListener('click', async () => {
        const categoryNameToDelete = addNavModalElements.categoryInput.value.trim();
        if (!categoryNameToDelete || categoryNameToDelete === '') return;

        const choice = prompt(` "${categoryNameToDelete}" \n\n1:  ("")\n2:  ()\n\n 1  2`);

        if (choice === '1') {
            const categoryObj = currentConfig.categories.find(c => c.name === categoryNameToDelete);
            currentConfig.categories = currentConfig.categories.filter(c => c.name !== categoryNameToDelete);
            await saveGlobalConfig(`Delete category (keep items): ${categoryNameToDelete}`);
            alert(` "${categoryNameToDelete}" `);
        } else if (choice === '2') {
            if (confirm(` \n "${categoryNameToDelete}" `)) {
                currentConfig.categories = currentConfig.categories.filter(c => c.name !== categoryNameToDelete);
                await saveGlobalConfig(`Delete category and items: ${categoryNameToDelete}`);
                alert(` "${categoryNameToDelete}" `);
            }
        } else {
            alert("");
            return;
        }
        
        addNavModalElements.categoryInput.value = '';
        currentCategory = '';
        localStorage.setItem('lastSelectedCategory', '');
        renderCategories();
        populateCategoryDatalist();
        updateAddNavModalUI();
    });

    function addNewButtonToDOM(text, href) { 
        navContainer.querySelector("#loading-status")?.remove(); 
        const btn = document.createElement("button"); 
        btn.className = "nav-btn"; 
        btn.dataset.href = href; 
        const textNode = document.createTextNode(text); 
        btn.appendChild(textNode); 
        navContainer.appendChild(btn); 
        attachButtonListeners(btn); 
        if (isManagementMode) { 
            btn.title = '  ';
            const icon = document.createElement('span'); 
            icon.className = 'delete-icon'; 
            icon.innerHTML = '&times;'; 
            icon.title = ''; 
            btn.appendChild(icon); 
        } 
    }
    function resetAddNavForm() { addNavModalElements.nameInput.value = ""; addNavModalElements.urlInput.value = ""; addNavModalElements.openExternallyToggle.checked = false; addNavModalElements.fileStatus.textContent = ""; addNavModalElements.uploadStatus.textContent = ""; addNavModalElements.projectHtmlPicker.value = ""; isEditingButton = false; editingButtonData = null; }
    
    function populateCategoryDatalist() {
        const datalist = document.getElementById('category-datalist');
        datalist.innerHTML = '';
        currentConfig.categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.name;
            datalist.appendChild(option);
        });
    }

    document.querySelectorAll('input[name="nav-type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            addNavModalElements.linkSection.style.display = this.value === 'link' ? 'block' : 'none';
            addNavModalElements.uploadSection.style.display = this.value === 'upload' ? 'flex' : 'none';
        });
    });

    addNavModalElements.filePickerBtn.addEventListener("click", () => addNavModalElements.projectHtmlPicker.click()); addNavModalElements.projectHtmlPicker.addEventListener("change", () => { if (addNavModalElements.projectHtmlPicker.files.length > 0) { const projectFile = addNavModalElements.projectHtmlPicker.files[0]; addNavModalElements.fileStatus.textContent = `: ${projectFile.name}`; } else { addNavModalElements.fileStatus.textContent = ''; }});
    addNavModalElements.createBtn.addEventListener("click",async()=>{
        const categoryName = addNavModalElements.categoryInput.value.trim() || '';
        const name = addNavModalElements.nameInput.value.trim();
        if(!name) return alert("");
        const type=document.querySelector('input[name="nav-type"]:checked').value;
        addNavModalElements.createBtn.disabled = true;
        addNavModalElements.createBtn.textContent="...";

        try {
            let newButtonData;
            if (type === "link") {
                const url = addNavModalElements.urlInput.value.trim();
                let finalUrl = url;
                 try {
                    new URL(url);
                } catch (_) {
                    if (!url.startsWith('https://') && !url.startsWith('http://') && url.includes('.')) {
                        finalUrl = 'https://' + url;
                    } else if (!url) {
                        alert(""); throw new Error("URL is required.");
                    }
                }
                 newButtonData = { text: name, href: finalUrl, openExternally: addNavModalElements.openExternallyToggle.checked };
            } else if (type === "upload") {
                 if (isEditingButton) {
                    alert(""); return;
                 }
                 if (!checkConfig()) return;
                 const projectFile = addNavModalElements.projectHtmlPicker.files[0]; 
                 if(!projectFile) { alert("HTML"); throw new Error("File is required."); }
                 addNavModalElements.uploadStatus.textContent="...";
                 const path=`projects/${name.toLowerCase().replace(/[^a-z0-9\u4e00-\u9fa5]/g,"").replace(/\s+/g,"-")||`project-${Date.now()}`}/index.html`;
                 await uploadFileViaGitData({ file: projectFile, path, commitMessage: `Create project: ${name}`, onProgress: (p) => { addNavModalElements.uploadStatus.textContent = `: ${Math.round(p)}%`; } });
                 addNavModalElements.uploadStatus.textContent="...";
                 newButtonData= { text:name, href: path, openExternally: false }; // **FIX**: Store the path, not the githack URL
                 alert("");
            }
            
            let commitMsg;
            if (isEditingButton && editingButtonData) {
                const oldCategory = currentConfig.categories.find(c => c.name === editingButtonData.categoryName);
                if (oldCategory) {
                    oldCategory.buttons = oldCategory.buttons.filter(b => b.href !== editingButtonData.href);
                     if (oldCategory.buttons.length === 0 && oldCategory.name !== '') {
                        currentConfig.categories = currentConfig.categories.filter(c => c.name !== oldCategory.name);
                    }
                }
                commitMsg = `Edit button: ${name}`;
            } else {
                commitMsg = `Add button: ${name} to ${categoryName}`;
            }
            
            let categoryObj = currentConfig.categories.find(c => c.name === categoryName);
            if (!categoryObj) {
                categoryObj = { name: categoryName, buttons: [] };
                currentConfig.categories.push(categoryObj);
            }
            categoryObj.buttons.push(newButtonData);

            await saveGlobalConfig(commitMsg); 
            
            resetAddNavForm(); 
            populateCategoryDatalist();
            renderCategories();
            
            if(!addNavModalElements.stayOpenToggle.checked || isEditingButton) { 
                addNavModalElements.modal.classList.remove("show");
            } 
        } catch(o) {
            addNavModalElements.uploadStatus.textContent="!";
            if(o.message !== "URL is required." && o.message !== "File is required.") {
                 alert(await handleApiError("/", o));
            }
        } finally {
            addNavModalElements.createBtn.disabled = false;
            addNavModalElements.createBtn.textContent = isEditingButton ? "" : "";
        }
    });

    function openAddModal() {
        isEditingButton = false;
        editingButtonData = null;
        const els = addNavModalElements;
        els.modal.classList.add('show');
        els.title.textContent = '';
        els.createBtn.textContent = '';
        
        els.uploadSection.style.pointerEvents = 'auto';
        els.uploadSection.style.opacity = '1';
        document.querySelector('label[for="type-upload"]').style.display = 'block';

        resetAddNavForm();
        populateCategoryDatalist();
        updateAddNavModalUI();
    }

    function openEditModal(buttonData) {
        isEditingButton = true;
        editingButtonData = buttonData;
        const els = addNavModalElements;
        
        els.modal.classList.add('show');
        els.title.textContent = '';
        els.createBtn.textContent = '';
        
        els.categoryInput.value = buttonData.categoryName;
        els.nameInput.value = buttonData.text;
        
        const isUploadedProject = buttonData.href.startsWith('projects/');
        
        if (isUploadedProject) {
            els.urlInput.value = "";
            els.typeUploadRadio.checked = true;
            els.linkSection.style.display = 'none';
            els.uploadSection.style.display = 'flex';
            els.uploadSection.style.pointerEvents = 'none';
            els.uploadSection.style.opacity = '0.5';
            document.querySelector('label[for="type-upload"]').style.display = 'none';
        } else {
            els.urlInput.value = buttonData.href;
            els.typeLinkRadio.checked = true;
            els.linkSection.style.display = 'block';
            els.uploadSection.style.display = 'none';
        }
        
        els.openExternallyToggle.checked = buttonData.openExternally || false;
        
        populateCategoryDatalist();
        updateAddNavModalUI();
    }
    
 function openIframeModal(url) { 
        if (!localStorage.getItem('swipeHintShown')) { swipeHint.classList.add('show'); setTimeout(() => { swipeHint.classList.remove('show'); localStorage.setItem('swipeHintShown', 'true'); }, 4000); } 
        iframeEl.src = url; 
        iframeModal.classList.add('active'); 
        FloatingBallManager.create();
    }
    function closeIframeModal() { 
        FloatingProjectWindowManager.closeAll();
        FloatingBallManager.destroy();
        hideReturnConfirmation(); 
        iframeModal.classList.remove('active'); 
        // setTimeout(() => { iframeEl.src = 'about:blank'; }, 400); // <-- 
    }
    function showReturnConfirmation() { returnConfirmationToast.classList.add('show'); }
    function hideReturnConfirmation() { returnConfirmationToast.classList.remove('show'); }
    document.getElementById('confirmReturnBtn').addEventListener('click', closeIframeModal);
    document.getElementById('cancelReturnBtn').addEventListener('click', hideReturnConfirmation);
    
    const gestureCaptureZone = document.getElementById('gestureCaptureZone');
    let startX = 0, startY = 0, currentX = 0, isIframeDragging = false, isSwipeIntent = false;
    gestureCaptureZone.addEventListener('touchstart', (e) => {
        if(currentConfig.settings?.jellyBall?.swipeBack === false) return;
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        currentX = startX;
        isIframeDragging = true;
        isSwipeIntent = false;
        iframeModalContent.classList.add('dragging');
    }, { passive: true });
    window.addEventListener('touchmove', (e) => {
        if (!isIframeDragging || returnConfirmationToast.classList.contains('show')) return;
        currentX = e.touches[0].clientX;
        const diffX = currentX - startX;
        if (diffX > 0) {
            if (!isSwipeIntent) {
                const diffY = Math.abs(e.touches[0].clientY - startY);
                if (diffX > 10 && diffX > diffY) {
                    isSwipeIntent = true;
                } else if (diffY > 10) {
                    isIframeDragging = false;
                    return;
                }
            }
            if (isSwipeIntent) {
                e.preventDefault();
                iframeModalContent.style.transform = `translateX(${diffX}px)`;
            }
        }
    }, { passive: false });
    window.addEventListener('touchend', (e) => {
        if (!isIframeDragging) return;
        isIframeDragging = false;
        iframeModalContent.classList.remove('dragging');
        iframeModalContent.style.transform = '';
        const diffX = currentX - startX;
        const closeThreshold = window.innerWidth / 3.5;
        if (isSwipeIntent && diffX > closeThreshold && !returnConfirmationToast.classList.contains('show')) {
            showReturnConfirmation();
        }
        startX = 0; currentX = 0; startY = 0; isSwipeIntent = false;
    });

    async function nukeAllData() {
        if (!checkConfig(true)) return;
        const btn = document.getElementById('nukeDataBtn');
        const originalText = btn.textContent;

        const confirmation = confirm(" \n\n\n\n-  (GitHub)\n- GitHub `config.json` ()\n- GitHub\n\n");
        if (!confirmation) return;
        
        btn.disabled = true;
        
        try {
            btn.textContent = '...';
            updateSyncStatus('syncing', '...');
            
            const rootContentsUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/`;
            const rootContentsRes = await fetch(rootContentsUrl, { headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` } });
            
            if (!rootContentsRes.ok) {
                let errorMsg = '';
                try {
                    const errorData = await rootContentsRes.json();
                    errorMsg = errorData.message || errorMsg;
                } catch (e) { /* ignore json parsing error */ }
                throw new Error(errorMsg);
            }

            const items = await rootContentsRes.json();
            const foldersToNuke = ['projects', 'memory', 'data_sync'];
            
            let i = 0;
            for (const item of items) {
                i++;
                btn.textContent = ` (${i}/${items.length})...`;
                if (item.path === 'config.json') {
                    await deleteFromGithub(item.path, 'NUKE: Deleting config file', item.sha, true);
                } else if (item.type === 'dir' && foldersToNuke.includes(item.name)) {
                    await deleteGithubFolder(item.path);
                }
            }
            btn.textContent = '...';
            localStorage.clear();
            
            alert('');
            location.reload();

        } catch (error) {
            const userMessage = await handleApiError("", error);
            updateSyncStatus('error', userMessage);
            alert(`: ${userMessage}`);
            btn.textContent = '';
        } finally {
            setTimeout(() => {
                btn.disabled = false;
                btn.textContent = originalText;
            }, 3000);
        }
    }
    document.getElementById('nukeDataBtn').addEventListener('click', nukeAllData);
    
    // ===== [START] MEMORY APP LOGIC =====
    const MemoryApp = (() => {
        const MEMORY_DATA_PATH = 'memory/data.json';
        const MEMORY_PHOTOS_PATH = 'memory/photos/';
        let memoryCache = null;
        let memoryDataSha = null;
        let isSaving = false;
        let saveTimeout = null;
        
        const ui = {
            modal: document.getElementById('memoryModal'),
            appContainer: document.getElementById('memoryAppContainer'),
            status: document.getElementById('memory-sync-status'),
            folderList: document.getElementById('folder-list-container'),
            notesList: document.getElementById('notes-list-container'),
            albumList: document.getElementById('album-list-container'),
            photoList: document.getElementById('photo-list-container'),
            photoUploader: document.getElementById('photo-uploader'),
            memoManageControls: document.getElementById('memo-management-controls'),
            albumManageControls: document.getElementById('album-management-controls'),
            photoManageControls: document.getElementById('photo-management-controls'),
            folderModal: document.getElementById('memoryFolderModal'),
            photoDetailsModal: document.getElementById('memoryPhotoDetailsModal'),
            photoViewer: document.getElementById('memoryPhotoViewerOverlay'),
            photosetToggleContainer: document.getElementById('photoset-toggle-container'),
            photosetToggle: document.getElementById('create-photoset-toggle'),
            categorySelector: document.getElementById("categorySelector"),
            projectSelector: document.getElementById("projectSelector"),
            fileList: document.getElementById("fileList"), 
            fileListStatus: document.getElementById("fileListStatus"), 
            fileUploader: document.getElementById("fileUploader"), 
            selectFileBtn: document.getElementById("selectFileBtn"), 
            selectedFileName: document.getElementById("selectedFileName"), 
            fileNameInput: document.getElementById("fileNameInput"), 
            uploadBtn: document.getElementById("uploadBtn"), 
            progressContainer: document.getElementById("progressContainer"), 
            progressBar: document.getElementById("uploadProgressBar")
        };

        const state = {
            currentSection: null,
            isMemoManageMode: false, memoFoldersToDelete: [],
            isAlbumManageMode: false, albumFoldersToDelete: [],
            isPhotoManageMode: false, photosToDelete: [],
            currentMemoFolderId: null, currentNoteId: null, currentAlbumId: null,
            folderModalContext: null,
            viewerContext: { items: [], index: -1 },
            photoUploadQueue: [],
            isSavingPhoto: false,
        };

        function getInitialData() {
            return {
                memo: { folders: [{ id: Date.now(), name: "" }], notes: [] },
                album: { folders: [{ id: Date.now() + 1, name: "" }], items: [] }
            };
        }

        function updateStatus(text, isError = false, reason = '') { ui.status.textContent = isError && reason ? `${text}: ${reason}` : text; ui.status.style.color = isError ? '#e53e3e' : 'inherit'; }

        async function syncWithGithub() {
                        if (!checkConfig(false)) return;
            updateStatus('...');
            const { data, error } = await fetchFromGithub(MEMORY_DATA_PATH);
            if (error) { updateStatus('', true, error); return; }
            memoryCache = data ? JSON.parse(b64_to_utf8(data.content)) : getInitialData();
            memoryDataSha = data ? data.sha : null;
            updateStatus('');
            if (!memoryCache.memo) memoryCache.memo = { folders: [], notes: [] };
            if (!memoryCache.album) memoryCache.album = { folders: [], items: [] };
            if (memoryCache.album.photos && !memoryCache.album.items) {
                    memoryCache.album.items = memoryCache.album.photos.map(p => ({...p, type: 'photo'}));
                    delete memoryCache.album.photos;
                }
        }
        
        function scheduleSave() {
            if (isSaving) return;
            clearTimeout(saveTimeout);
            updateStatus('');
            saveTimeout = setTimeout(async () => {
                isSaving = true;
                updateStatus('...');
                const content = utf8_to_b64(JSON.stringify(memoryCache, null, 2));
                const result = await saveToGithub(MEMORY_DATA_PATH, content, 'Update memory data', memoryDataSha);
                if (result.sha) { 
                    memoryDataSha = result.sha; 
                    updateStatus(''); 
                } else { 
                    updateStatus('', true, result.error); 
                }
                isSaving = false;
            }, 1500);
        }
        
        function showPage(pageId) { ui.appContainer.querySelectorAll(':scope > .page').forEach(p => p.classList.remove('active')); ui.appContainer.querySelector(`#${pageId}`).classList.add('active'); }
        function showView(viewId, sectionId) { const section = ui.appContainer.querySelector(`#${sectionId}`); section.querySelectorAll(':scope > .page').forEach(p => p.classList.remove('active')); section.querySelector(`#${viewId}`).classList.add('active'); showPage(sectionId); }

        function renderMemoFolders() {
            ui.folderList.innerHTML = '';
            memoryCache.memo.folders.forEach(folder => {
                const isSelected = state.memoFoldersToDelete.includes(folder.id);
                const el = document.createElement('div');
                el.className = `folder-item ${state.isMemoManageMode ? 'manage-mode' : ''} ${isSelected ? 'manage-selected' : ''}`;
                el.dataset.folderId = folder.id;
                el.dataset.action = "open-memo-folder";
                el.innerHTML = `<input type="checkbox" class="manage-checkbox" ${isSelected ? 'checked' : ''}><div class="folder-icon"></div><div class="folder-name">${folder.name}</div>`;
                ui.folderList.appendChild(el);
            });
            if (memoryCache.memo.folders.length === 0) ui.folderList.innerHTML = `<p class="empty-list-placeholder"></p>`;
        }
        function renderNotes() {
            ui.notesList.innerHTML = '';
            const notesInFolder = memoryCache.memo.notes.filter(n => n.folderId === state.currentMemoFolderId).sort((a, b) => (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0) || b.timestamp - a.timestamp);
            notesInFolder.forEach(note => {
                const el = document.createElement('div');
                el.className = `note-item ${note.isPinned ? 'pinned' : ''}`; 
                el.dataset.noteId = note.id;
                el.dataset.action = "open-note";
                const preview = (note.content || '').substring(0, 100).replace(/</g, "&lt;").replace(/>/g, "&gt;");
                const date = new Date(note.timestamp).toLocaleDateString('zh-CN');
                el.innerHTML = `<div class="note-content-area"><div class="note-title">${note.title || ''}</div><div class="note-preview">${preview || ''}</div><div class="note-timestamp">${date}</div></div><button class="pin-btn" data-action="pin-note" data-note-id="${note.id}" title=""></button>`;
                ui.notesList.appendChild(el);
            });
            if (notesInFolder.length === 0) ui.notesList.innerHTML = `<p class="empty-list-placeholder"></p>`;
        }
        function renderAlbumFolders() {
            ui.albumList.innerHTML = '';
            memoryCache.album.folders.forEach(folder => {
                const itemCount = memoryCache.album.items.filter(p => p.albumId === folder.id).length;
                const isSelected = state.albumFoldersToDelete.includes(folder.id);
                const el = document.createElement('div');
                el.className = `album-item ${state.isAlbumManageMode ? 'manage-mode' : ''} ${isSelected ? 'manage-selected' : ''}`;
                el.dataset.albumId = folder.id;
                el.dataset.action = "open-album-folder";
                el.innerHTML = `<input type="checkbox" class="manage-checkbox" ${isSelected ? 'checked' : ''}><div><div class="folder-icon"></div><div class="folder-name">${folder.name}</div></div><div class="album-info">${itemCount} </div>`;
                ui.albumList.appendChild(el);
            });
                        if (memoryCache.album.folders.length === 0) ui.albumList.innerHTML = `<p class="empty-list-placeholder"></p>`;
        }
        function renderPhotos() {
            if (photoObserver) photoObserver.disconnect();
            ui.photoList.innerHTML = '';
            
            const itemsInAlbum = memoryCache.album.items
                .filter(p => p.albumId === state.currentAlbumId)
                .sort((a, b) => b.timestamp - a.timestamp);
            
            if (itemsInAlbum.length === 0) {
                ui.photoList.innerHTML = `<p class="empty-list-placeholder"></p>`;
                return;
            }

            const fragment = document.createDocumentFragment();
            itemsInAlbum.forEach(item => {
                const isSelected = state.photosToDelete.includes(item.id);
                const el = document.createElement('div');
                el.dataset.itemId = item.id;
                
                let imgSrc = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='; // Placeholder
                let firstPhotoPath = '';
                
                if (item.type === 'photoset') {
                    el.className = `photo-item-set ${state.isPhotoManageMode ? 'manage-mode' : ''} ${isSelected ? 'manage-selected' : ''}`;
                    el.dataset.action = "open-item";
                    let stackHtml = '';
                    const photosToDisplay = item.photos.slice(0, 3);
                    firstPhotoPath = photosToDisplay.length > 0 ? photosToDisplay[photosToDisplay.length - 1].path : '';
                     
                    for (let i = photosToDisplay.length - 1; i >= 0; i--) {
                        stackHtml += `<img data-src="${photosToDisplay[i].path}" class="photo-stack-img lazyload" loading="lazy" src="${imgSrc}">`;
                    }
                    const title = (item.title || '');
                    el.innerHTML = `<input type="checkbox" class="manage-checkbox" ${isSelected ? 'checked' : ''}>${stackHtml}<div class="photo-title-overlay">${title}</div><div class="count-overlay">${item.photos.length} </div>`;
                } else {
                    el.className = `photo-item ${state.isPhotoManageMode ? 'manage-mode' : ''} ${isSelected ? 'manage-selected' : ''}`;
                    el.dataset.action = "open-item";
                    firstPhotoPath = item.path;
                    const title = (item.title || '');
                    el.innerHTML = `<input type="checkbox" class="manage-checkbox" ${isSelected ? 'checked' : ''}><img data-src="${firstPhotoPath}" class="lazyload" alt="${title}" loading="lazy" src="${imgSrc}"><div class="photo-title-overlay">${title}</div>`;
                }
                fragment.appendChild(el);
            });

            ui.photoList.appendChild(fragment);

            const lazyImages = ui.photoList.querySelectorAll('.lazyload');
            lazyImages.forEach(img => photoObserver.observe(img));
        }
        
        async function openPhotoViewer(items, initialIndex) {
            if (!items || items.length === 0) return;
            state.viewerContext = { items, index: initialIndex };
            ui.photoViewer.classList.add('active');
            await updatePhotoViewerContent();
        }

        async function updatePhotoViewerContent() {
            const { items, index } = state.viewerContext;
            if (!items || items.length === 0 || index < 0) { closePhotoViewer(); return; }
            
            const currentItem = items[index];
            let photo, title, description, timestamp, isSet, setIndex = 0, setLength = 0;

            if (currentItem.type === 'photoset') {
                isSet = true;
                setIndex = currentItem.internalIndex || 0;
                setLength = currentItem.photos.length;
                photo = currentItem.photos[setIndex];
                title = currentItem.title;
                description = currentItem.description;
                timestamp = currentItem.timestamp;
            } else {
                isSet = false;
                photo = currentItem;
                title = photo.title;
                description = photo.description;
                timestamp = photo.timestamp;
            }

            const viewerImg = ui.photoViewer.querySelector('#viewer-img');
            viewerImg.src = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='; // Placeholder
            
            const photoUrl = await getSecureFileUrl(photo.path);
            viewerImg.src = photoUrl;
            ui.photoViewer.querySelector('#viewer-title').textContent = title || '';
            ui.photoViewer.querySelector('#viewer-description').textContent = description || '';
            ui.photoViewer.querySelector('#viewer-timestamp').textContent = new Date(timestamp).toLocaleString('zh-CN');
            
            const prevBtn = document.getElementById('prev-photo-btn');
            const nextBtn = document.getElementById('next-photo-btn');
            const counter = document.getElementById('viewer-counter');

            const canGoPrev = (isSet && setIndex > 0) || index > 0;
            const canGoNext = (isSet && setIndex < setLength - 1) || index < items.length - 1;

            prevBtn.style.display = canGoPrev ? 'flex' : 'none';
            nextBtn.style.display = canGoNext ? 'flex' : 'none';

            if (isSet) {
                counter.textContent = `${setIndex + 1} / ${setLength}`;
                counter.style.display = 'block';
            } else {
                counter.style.display = 'none';
            }
        }
        function closePhotoViewer() { 
            state.viewerContext.items.forEach(item => { if(item.type === 'photoset') delete item.internalIndex; });
            ui.photoViewer.classList.remove('active'); 
        }
        async function changePhotoInViewer(direction) {
            const { items, index } = state.viewerContext;
            const currentItem = items[index];
            
            if (currentItem.type === 'photoset') {
                const newSetIndex = (currentItem.internalIndex || 0) + direction;
                if (newSetIndex >= 0 && newSetIndex < currentItem.photos.length) {
                    currentItem.internalIndex = newSetIndex;
                } else {
                    changeViewerItem(direction);
                }
            } else {
                changeViewerItem(direction);
            }
            await updatePhotoViewerContent();
        }

        function changeViewerItem(direction) {
            let newIndex = state.viewerContext.index + direction;
            if (newIndex >= 0 && newIndex < state.viewerContext.items.length) {
                state.viewerContext.index = newIndex;
                    const newItem = state.viewerContext.items[newIndex];
                if (newItem.type === 'photoset') {
                    newItem.internalIndex = direction > 0 ? 0 : newItem.photos.length - 1;
                }
            }
        }
        
        const actions = {
            'goto-memo': () => { showPage('memo-section'); state.currentSection = 'memo'; document.getElementById('memory-modal-title').textContent = ''; renderMemoFolders(); },
            'goto-album': () => { showPage('album-section'); state.currentSection = 'album'; document.getElementById('memory-modal-title').textContent = ''; renderAlbumFolders(); },
            'goto-cloud': () => { 
    showPage('cloud-drive-section'); 
    state.currentSection = 'cloud'; 
    document.getElementById('memory-modal-title').textContent = ''; 
    populateDriveCategorySelector(); 
    populateDriveProjectSelector(); // 
    fetchFilesForSelectedProject(); 
},

            'back-to-hub': () => { showPage('hub-view'); state.currentSection = null; document.getElementById('memory-modal-title').textContent = ''; },
            'add-memo-folder': () => { state.folderModalContext = { type: 'memo', id: null }; document.getElementById('folder-modal-title').textContent = ''; ui.folderModal.querySelector('#folder-name-input').value = ''; ui.folderModal.classList.add('show'); },
            'add-album-folder': () => {
                if (memoryCache.album.folders.length >= 100) { alert('100'); return; }
                state.folderModalContext = { type: 'album', id: null }; document.getElementById('folder-modal-title').textContent = ''; ui.folderModal.querySelector('#folder-name-input').value = ''; ui.folderModal.classList.add('show'); },
            'close-folder-modal': () => ui.folderModal.classList.remove('show'),
            'save-folder': () => {
                const { type, id } = state.folderModalContext;
                const name = ui.folderModal.querySelector('#folder-name-input').value.trim();
                if (!name) return alert('');
                const list = memoryCache[type].folders;
                if (id) {
                    const item = list.find(f => f.id === id);
                    if (item) item.name = name;
                } else {
                    list.push({ id: Date.now(), name });
                }
                ui.folderModal.classList.remove('show');
                if (type === 'memo') renderMemoFolders(); else renderAlbumFolders();
                scheduleSave();
            },
            'open-memo-folder': (target) => {
                const folderId = parseInt(target.closest('[data-folder-id]').dataset.folderId, 10);
                if (state.isMemoManageMode) {
                    const index = state.memoFoldersToDelete.indexOf(folderId);
                    if (index > -1) state.memoFoldersToDelete.splice(index, 1);
                    else state.memoFoldersToDelete.push(folderId);
                    renderMemoFolders();
                    return;
                }
                state.currentMemoFolderId = folderId;
                const folder = memoryCache.memo.folders.find(f => f.id === folderId);
                if (folder) document.getElementById('notes-view-title').textContent = folder.name;
                showView('notes-view', 'memo-section');
                renderNotes();
            },
            'open-album-folder': (target) => {
                const albumId = parseInt(target.closest('[data-album-id]').dataset.albumId, 10);
                if (state.isAlbumManageMode) {
                    const index = state.albumFoldersToDelete.indexOf(albumId);
                    if (index > -1) state.albumFoldersToDelete.splice(index, 1);
                    else state.albumFoldersToDelete.push(albumId);
                    renderAlbumFolders();
                    return;
                }
                state.currentAlbumId = albumId;
                const folder = memoryCache.album.folders.find(f => f.id === albumId);
                if (folder) document.getElementById('photo-grid-title').textContent = folder.name;
                showView('photo-grid-view', 'album-section');
                renderPhotos();
            },
            'back-to-memo-folders': () => {
                if (document.getElementById('note-editor-view').classList.contains('active')) {
                   actions['cancel-note']();
                } else {
                   showView('folder-view', 'memo-section'); state.currentMemoFolderId = null;
                }
            },
            'back-to-album-folders': () => { showView('album-folder-view', 'album-section'); state.currentAlbumId = null; },
            'add-note': () => { state.currentNoteId = null; document.getElementById('note-title-input').value = ''; document.getElementById('note-content-textarea').value = ''; document.getElementById('delete-note-btn').style.display = 'none'; showView('note-editor-view', 'memo-section'); },
            'open-note': (target) => {
                const noteId = parseInt(target.closest('[data-note-id]').dataset.noteId, 10);
                const note = memoryCache.memo.notes.find(n => n.id === noteId);
                if (note) {
                    state.currentNoteId = note.id;
                    document.getElementById('note-title-input').value = note.title;
                    document.getElementById('note-content-textarea').value = note.content;
                    document.getElementById('delete-note-btn').style.display = 'inline-block';
                    showView('note-editor-view', 'memo-section');
                }
            },
            'save-note': () => {
                const title = document.getElementById('note-title-input').value.trim();
                const content = document.getElementById('note-content-textarea').value.trim();
                const now = Date.now();
                if (state.currentNoteId) {
                    const note = memoryCache.memo.notes.find(n => n.id === state.currentNoteId);
                    if (note) {
                        note.title = title;
                        note.content = content;
                        note.timestamp = now;
                    }
                } else {
                    memoryCache.memo.notes.push({ id: now, folderId: state.currentMemoFolderId, title, content, timestamp: now, isPinned: false });
                }
                showView('notes-view', 'memo-section');
                renderNotes();
                scheduleSave();
            },
            'cancel-note': () => {
                showView('notes-view', 'memo-section');
            },
            'delete-note': () => {
                if (state.currentNoteId && confirm('')) {
                    memoryCache.memo.notes = memoryCache.memo.notes.filter(n => n.id !== state.currentNoteId);
                    showView('notes-view', 'memo-section');
                    renderNotes();
                    scheduleSave();
                }
            },
            'pin-note': (target) => {
                const noteId = parseInt(target.dataset.noteId, 10);
                const note = memoryCache.memo.notes.find(n => n.id === noteId);
                if(note) { note.isPinned = !note.isPinned; }
                renderNotes();
                scheduleSave();
            },

            'toggle-memo-manage': (target) => {
                state.isMemoManageMode = !state.isMemoManageMode;
                target.textContent = state.isMemoManageMode ? '' : '';
                ui.memoManageControls.classList.toggle('active', state.isMemoManageMode);
                if (!state.isMemoManageMode) state.memoFoldersToDelete = [];
                renderMemoFolders();
            },
            'select-all-memo': () => {
                if (state.memoFoldersToDelete.length === memoryCache.memo.folders.length) {
                    state.memoFoldersToDelete = [];
                } else {
                    state.memoFoldersToDelete = memoryCache.memo.folders.map(f => f.id);
                }
                renderMemoFolders();
            },
            'delete-selected-memo': () => {
                if (state.memoFoldersToDelete.length === 0) return;
                let notesToDeleteCount = 0;
                memoryCache.memo.notes.forEach(note => {
                    if (state.memoFoldersToDelete.includes(note.folderId)) {
                        notesToDeleteCount++;
                    }
                });
                if (confirm(` ${state.memoFoldersToDelete.length}  ${notesToDeleteCount} `)) {
                    memoryCache.memo.notes = memoryCache.memo.notes.filter(n => !state.memoFoldersToDelete.includes(n.folderId));
                    memoryCache.memo.folders = memoryCache.memo.folders.filter(f => !state.memoFoldersToDelete.includes(f.id));
                    state.memoFoldersToDelete = [];
                    renderMemoFolders();
                    scheduleSave();
                }
            },
            'toggle-album-manage': (target) => {
                state.isAlbumManageMode = !state.isAlbumManageMode;
                target.textContent = state.isAlbumManageMode ? '' : '';
                ui.albumManageControls.classList.toggle('active', state.isAlbumManageMode);
                if (!state.isAlbumManageMode) state.albumFoldersToDelete = [];
                renderAlbumFolders();
            },
            'select-all-album': () => {
                if (state.albumFoldersToDelete.length === memoryCache.album.folders.length) {
                    state.albumFoldersToDelete = [];
                } else {
                    state.albumFoldersToDelete = memoryCache.album.folders.map(f => f.id);
                }
                renderAlbumFolders();
            },
            'delete-selected-album': async () => {
                if (state.albumFoldersToDelete.length === 0) return;
                const itemsToDelete = memoryCache.album.items.filter(p => state.albumFoldersToDelete.includes(p.albumId));
                let photoCount = 0;
                itemsToDelete.forEach(item => { photoCount += item.type === 'photoset' ? item.photos.length : 1; });
                if (confirm(` ${state.albumFoldersToDelete.length}  ${photoCount} `)) {
                    await Promise.all(itemsToDelete.map(item => {
                        if (item.type === 'photoset') return Promise.all(item.photos.map(p => deleteFromGithub(p.path, `Delete photo from set`, p.sha, true)));
                        else return deleteFromGithub(item.path, `Delete photo`, item.sha, true);
                    }));
                    memoryCache.album.items = memoryCache.album.items.filter(p => !state.albumFoldersToDelete.includes(p.albumId));
                    memoryCache.album.folders = memoryCache.album.folders.filter(f => !state.albumFoldersToDelete.includes(f.id));
                    state.albumFoldersToDelete = [];
                    renderAlbumFolders();
                    scheduleSave();
                }
            },
            'toggle-photo-manage': (target) => {
                state.isPhotoManageMode = !state.isPhotoManageMode;
                target.textContent = state.isPhotoManageMode ? '' : '';
                ui.photoManageControls.classList.toggle('active', state.isPhotoManageMode);
                if (!state.isPhotoManageMode) state.photosToDelete = [];
                renderPhotos();
            },
             'select-all-photos': () => {
                const currentAlbumItems = memoryCache.album.items.filter(p => p.albumId === state.currentAlbumId);
                if (state.photosToDelete.length === currentAlbumItems.length) {
                    state.photosToDelete = [];
                } else {
                    state.photosToDelete = currentAlbumItems.map(p => p.id);
                }
                renderPhotos();
            },
            'delete-selected-photos': async () => {
                if (state.photosToDelete.length === 0) return;
                const itemsToDelete = memoryCache.album.items.filter(p => state.photosToDelete.includes(p.id));
                let photoCount = 0;
                itemsToDelete.forEach(item => { photoCount += item.type === 'photoset' ? item.photos.length : 1; });
                if (confirm(` ${itemsToDelete.length} ( ${photoCount} )`)) {
                    await Promise.all(itemsToDelete.map(item => {
                        if (item.type === 'photoset') return Promise.all(item.photos.map(p => deleteFromGithub(p.path, `Delete photo from set`, p.sha, true)));
                        else return deleteFromGithub(item.path, `Delete photo`, item.sha, true);
                    }));
                    memoryCache.album.items = memoryCache.album.items.filter(p => !state.photosToDelete.includes(p.id));
                    state.photosToDelete = [];
                    renderPhotos(); scheduleSave();
                }
            },
            'save-photo-details': () => { state.isSavingPhoto = true; },
            'skip-photo-details': () => { state.isSavingPhoto = false; document.getElementById('photo-title-input').value = ''; document.getElementById('photo-desc-input').value = ''; },
            'open-item': (target) => {
                const itemId = parseInt(target.closest('[data-item-id]').dataset.itemId, 10);
                 if (state.isPhotoManageMode) {
                    const index = state.photosToDelete.indexOf(itemId);
                    if (index > -1) state.photosToDelete.splice(index, 1);
                    else state.photosToDelete.push(itemId);
                    renderPhotos();
                    return;
                }
                const itemsInAlbum = memoryCache.album.items.filter(p => p.albumId === state.currentAlbumId).sort((a,b) => b.timestamp - a.timestamp);
                const itemIndex = itemsInAlbum.findIndex(p => p.id === itemId);
                openPhotoViewer(itemsInAlbum, itemIndex);
            },
            'close-viewer': () => closePhotoViewer(),
            'prev-photo': () => changePhotoInViewer(-1),
            'next-photo': () => changePhotoInViewer(1),
            'wander-global': () => WanderView.start(memoryCache.album.items),
            'wander-local': () => WanderView.start(memoryCache.album.items.filter(p => p.albumId === state.currentAlbumId)),
            'close-wander-view': () => WanderView.close(),
            'toggle-player-collapse': () => WanderView.togglePlayerCollapse(),
        };

        async function processPhotoUploadQueue() {
            if (state.photoUploadQueue.length === 0) return;
            const isSet = state.photoUploadQueue.length > 1;
            ui.photosetToggleContainer.style.display = isSet ? 'block' : 'none';
            ui.photosetToggle.checked = isSet;

            let photosetData = { id: Date.now(), albumId: state.currentAlbumId, type: 'photoset', title: '', description: '', timestamp: Date.now(), photos: [] };
        
            for (let i = 0; i < state.photoUploadQueue.length; i++) {
                const file = state.photoUploadQueue[i];
                ui.photoDetailsModal.querySelector('#upload-thumbnail').src = URL.createObjectURL(file);
                ui.photoDetailsModal.querySelector('#photo-details-modal-title').textContent = isSet ? ` (${i + 1}/${state.photoUploadQueue.length})` : '';
                ui.photoDetailsModal.classList.add('show');

                let savePromise = new Promise(resolve => {
                    const saveHandler = () => { ui.photoDetailsModal.querySelector('[data-action="save-photo-details"]').removeEventListener('click', saveHandler); resolve(); };
                     ui.photoDetailsModal.querySelector('[data-action="save-photo-details"]').addEventListener('click', saveHandler);
                    const skipHandler = (e) => { e.stopPropagation(); ui.photoDetailsModal.removeEventListener('click', skipDelegation); resolve(); };
                    const skipDelegation = (e) => { if (e.target.closest('[data-action="skip-photo-details"]')) skipHandler(e); };
                    ui.photoDetailsModal.addEventListener('click', skipDelegation);
                });
                await savePromise;

                const title = document.getElementById('photo-title-input').value.trim();
                const description = document.getElementById('photo-desc-input').value.trim();
                const createSet = document.getElementById('create-photoset-toggle').checked;
                
                ui.photoDetailsModal.classList.remove('show');
                const photoData = await uploadPhoto(file, title, description);
                if (photoData) {
                    if (isSet && createSet) {
                         photosetData.photos.push(photoData);
                         if (!photosetData.title) photosetData.title = title;
                         if (!photosetData.description) photosetData.description = description;
                    } else {
                        memoryCache.album.items.push({
                            id: Date.now() + i, albumId: state.currentAlbumId, type: 'photo',
                            title: title, description: description, timestamp: Date.now(),
                            ...photoData
                        });
                    }
                }
                document.getElementById('photo-title-input').value = '';
                document.getElementById('photo-desc-input').value = '';
            }
            if (photosetData.photos.length > 0) memoryCache.album.items.push(photosetData);

            state.photoUploadQueue = [];
            renderPhotos();
            scheduleSave();
        }

        async function uploadPhoto(file, title, description) {
            try {
                const path = `${MEMORY_PHOTOS_PATH}${Date.now()}_${file.name}`;
                const result = await uploadFileViaGitData({ file, path, commitMessage: `Upload photo: ${file.name}`, onProgress: () => {} });
                return { path: result.path, sha: result.sha };
            } catch (error) {
                alert(` ${file.name} : ${await handleApiError('', error)}`);
                return null;
            }
        }
       
              function populateDriveCategorySelector() {
    ui.categorySelector.innerHTML = '<option value="">--  --</option>';
    if (currentConfig.categories && currentConfig.categories.length > 0) {
        // 
        currentConfig.categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.name;
            option.textContent = cat.name;
            ui.categorySelector.appendChild(option);
        });
    }
}

         function populateDriveProjectSelector() {
            const selectedCategory = ui.categorySelector.value;
            ui.projectSelector.innerHTML = ''; // 

            if (!selectedCategory || selectedCategory === '') {
                ui.projectSelector.classList.add('hidden');
                return;
            }

            ui.projectSelector.classList.remove('hidden');

            const category = currentConfig.categories.find(c => c.name === selectedCategory);
            // /
            const allProjects = (category && category.buttons) ? category.buttons : [];

            if (allProjects.length > 0) {
                // 
                allProjects.forEach(btn => {
                    const option = document.createElement('option');
                    //  href 
                    option.value = btn.href; 
                    option.textContent = btn.text;
                    ui.projectSelector.appendChild(option);
                });
            } else {
                // 
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "";
                option.disabled = true;
                ui.projectSelector.appendChild(option);
            }
        }


        function fetchFilesForSelectedProject() {
            const categoryName = ui.categorySelector.value;
            const projectHref = ui.projectSelector.value;
            ui.fileList.innerHTML = '';
            ui.fileListStatus.style.display = 'block';

            if (!projectHref) {
                ui.fileListStatus.textContent = (categoryName && categoryName !== '') ? "" : '';
                return;
            }
            fetchFilesFromGithubProject(projectHref);
        }

                async function fetchFilesFromGithubProject(projectHref) {
            const projectConfig = findButtonConfigByHref(projectHref);

            // 
            if (!projectConfig) {
                ui.fileListStatus.textContent = "";
                return;
            }

            // 
            const projectName = projectConfig.text;
            const folderName = projectName.toLowerCase().replace(/[^a-z0-9\u4e00-\u9fa5]/g, "").replace(/\s+/g, "-") || `project-${Date.now()}`;
            
            //  'jellyfish_drive' 
            const projectPath = `jellyfish_drive/${folderName}`;
            ui.fileListStatus.textContent = "...";
            
            // fetchFromGithub  404 () 
            const { data: files, error } = await fetchFromGithub(projectPath);
            if (error) { 
                ui.fileListStatus.textContent = `: ${error}`; 
                return; 
            }

            //  files  null () 
            if (!files || files.length === 0) {
                ui.fileListStatus.textContent = "";
                return;
            }

            ui.fileListStatus.style.display = "none";
            files.forEach(async (file) => {
                const li = document.createElement("li");
                const sizeText = file.size ? `${(file.size / 1024).toFixed(1)} KB` : '...';
                li.innerHTML = `<div class="file-info"><span class="file-name">${file.name}</span><span class="file-meta" data-path="${file.path}">${sizeText}</span></div><button class="delete-btn" data-sha="${file.sha}">&times;</button>`;

                ui.fileList.appendChild(li);
                
                if (!file.size) { getLatestCommitDate(file.path).then(date => { const metaSpan = li.querySelector('.file-meta'); if (metaSpan) metaSpan.textContent = date.split('T')[0]; }); }
                
                li.querySelector(".file-info").addEventListener("click", () => forceDownload(file.path, file.name, li));
                li.querySelector(".delete-btn").addEventListener("click", () => deleteFile(file.path, file.sha, li));
            });
        }

        async function getLatestCommitDate(e){const t=`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/commits?path=${encodeURIComponent(e)}&page=1&per_page=1`;try{const n=await fetch(t,{headers:{"Authorization":`token ${GITHUB_CONFIG.token}`},cache:"no-cache"});if(!n.ok)return(new Date(0)).toISOString().split('T')[0];const o=await n.json();return o[0]?.commit.committer.date.split('T')[0]||(new Date(0)).toISOString().split('T')[0]}catch(n){return console.error(`Error fetching commit date for ${e}:`,n),(new Date(0)).toISOString().split('T')[0]}}async function deleteFile(e,t,n){
    const originalFileName = n.querySelector(".file-name").textContent;
    if(!confirm(` "${originalFileName}" `))return;
    
    // --- [] ---
    const fileNameSpan = n.querySelector(".file-name");
    const deleteButton = n.querySelector(".delete-btn");
    fileNameSpan.textContent = "...";
    deleteButton.style.display = "none"; // 
    n.style.pointerEvents = "none"; // 
    n.style.opacity="0.7";
    // --- [] ---
    
    try{ 
        const success = await deleteFromGithub(e, `Delete file: ${e}`, t); 
        if (success) { 
            n.remove(); 
            if(ui.fileList.children.length === 0) { 
                ui.fileListStatus.textContent = ''; 
                ui.fileListStatus.style.display = 'block'; 
            } 
        } else { 
            // --- []  ---
            fileNameSpan.textContent = originalFileName;
            deleteButton.style.display = "flex";
            n.style.pointerEvents = "auto";
            n.style.opacity = "1";
            // --- [] ---
        } 
    } catch(err) { 
         // --- []  ---
         fileNameSpan.textContent = originalFileName;
         deleteButton.style.display = "flex";
         n.style.pointerEvents = "auto";
         n.style.opacity = "1";
         // --- [] ---
    }
}

        async function forceDownload(path, filename, el) {
            const fileNameSpan = el.querySelector(".file-name");
            const originalText = fileNameSpan.textContent;
            el.style.pointerEvents = "none";

            try {
                const xhr = new XMLHttpRequest();
                const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`;
                xhr.open('GET', url, true);
                xhr.setRequestHeader('Authorization', `token ${GITHUB_CONFIG.token}`);
                xhr.setRequestHeader('Accept', 'application/vnd.github.v3.raw');
                xhr.responseType = 'blob';

                let lastProgressText = '';
                xhr.onprogress = (event) => {
                    let newProgressText = '...';
                    if (event.lengthComputable) {
                        const percentComplete = Math.round((event.loaded / event.total) * 100);
                        newProgressText = `... ${percentComplete}%`;
                    }
                    if (newProgressText !== lastProgressText) {
                        fileNameSpan.textContent = newProgressText;
                        lastProgressText = newProgressText;
                    }
                };

                xhr.onload = () => {
                    if (xhr.status === 200) {
                        const blob = xhr.response;
                        const blobUrl = URL.createObjectURL(blob);
                        const link = document.createElement("a");
                        link.href = blobUrl;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(blobUrl);
                        fileNameSpan.textContent = "";
                    } else {
                        fileNameSpan.textContent = "";
                        alert(`: ${xhr.statusText}`);
                    }
                    
                    setTimeout(() => {
                        fileNameSpan.textContent = originalText;
                        el.style.pointerEvents = "auto";
                    }, 2000);
                };

                xhr.onerror = async () => {
                    fileNameSpan.textContent = "";
                    alert(await handleApiError("", new Error("")));
                    setTimeout(() => {
                        fileNameSpan.textContent = originalText;
                        el.style.pointerEvents = "auto";
                    }, 2000);
                };

                fileNameSpan.textContent = "...";
                xhr.send();

            } catch (error) {
                alert(await handleApiError("", error));
                fileNameSpan.textContent = originalText;
                el.style.pointerEvents = "auto";
            }
        }
                async function uploadFile() {
    if (activeUploadXHR) { activeUploadXHR.abort(); return; }
    if (!checkConfig()) return;

    const selectedProjectHref = ui.projectSelector.value;
    const file = ui.fileUploader.files[0];
    let fileName = ui.fileNameInput.value.trim() || (file && file.name);

    if (!selectedProjectHref || !file || !fileName) {
        return alert("");
    }

    const projectConfig = findButtonConfigByHref(selectedProjectHref);
    if (!projectConfig) {
        return alert("");
    }
    
    const projectName = projectConfig.text;
    const folderName = projectName.toLowerCase().replace(/[^a-z0-9\u4e00-\u9fa5]/g, "").replace(/\s+/g, "-") || `project-${Date.now()}`;
    const basePath = `jellyfish_drive/${folderName}`;
    const path = `${basePath}/${fileName}`;

    ui.uploadBtn.disabled = true;
    ui.uploadBtn.textContent = " (0%)...";
    ui.progressContainer.style.display = 'block';
    ui.progressBar.style.width = '0%';

    try {
        const result = await uploadFileViaGitData({ 
            file, 
            path, 
            commitMessage: `Upload ${fileName} to Drive/${projectName}`, 
            onProgress: (percent) => { 
                ui.progressBar.style.width = `${percent}%`; 
                if (percent < 100) { 
                    ui.uploadBtn.textContent = ` (${Math.round(percent)}%)...`; 
                } else { 
                    ui.uploadBtn.textContent = '...'; 
                } 
            } 
        });

        // --- [] ---
        // UI
        ui.fileListStatus.style.display = "none";
        const newFile = {
            name: fileName,
            path: path,
            sha: result.sha, // sha
            size: file.size
        };

        const li = document.createElement("li");
        const sizeText = `${(newFile.size / 1024).toFixed(1)} KB`;
        li.innerHTML = `<div class="file-info"><span class="file-name">${newFile.name}</span><span class="file-meta" data-path="${newFile.path}">${sizeText}</span></div><button class="delete-btn">&times;</button>`;
        ui.fileList.appendChild(li);

        li.querySelector(".file-info").addEventListener("click", () => forceDownload(newFile.path, newFile.name, li));
        li.querySelector(".delete-btn").addEventListener("click", () => deleteFile(newFile.path, newFile.sha, li));
        // --- [] ---

        alert("");
        ui.fileUploader.value = "";
        ui.fileNameInput.value = "";
        ui.selectedFileName.textContent = '';

    } catch (error) {
        if (error.message !== "") {
            alert(await handleApiError(` ${fileName}`, error));
        }
    } finally {
        ui.uploadBtn.disabled = false;
        ui.uploadBtn.textContent = "";
        ui.progressContainer.style.display = 'none';
    }
}



        return {
            open: () => {
                if (!checkConfig(true)) { document.getElementById('settingsModal').classList.add('show'); return; }
                ui.modal.classList.add('show');
                if (!memoryCache) { syncWithGithub(); }
            },
            init: () => {
                 photoObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            const src = img.dataset.src;
                            if (src) {
                                getSecureFileUrl(src).then(url => {
                                    if(url) img.src = url;
                                });
                            }
                            observer.unobserve(img);
                        }
                    });
                }, { root: ui.photoList, rootMargin: "0px 0px 200px 0px" });


                ui.appContainer.addEventListener('click', e => {
                    const target = e.target.closest('[data-action]');
                    if (target && actions[target.dataset.action]) {
                        actions[target.dataset.action](target);
                    }
                });
                ui.folderModal.addEventListener('click', e => { const target = e.target.closest('[data-action]'); if (target) actions[target.dataset.action]?.(); });
                ui.photoDetailsModal.addEventListener('click', e => { const target = e.target.closest('[data-action]'); if (target) actions[target.dataset.action]?.(); });
                ui.photoViewer.addEventListener('click', e => { const target = e.target.closest('[data-action]'); if (target) actions[target.dataset.action]?.(); });
                ui.photoUploader.addEventListener('change', e => {
                    if (!e.target.files.length) return;
                    state.photoUploadQueue = Array.from(e.target.files);
                    processPhotoUploadQueue();
                    e.target.value = '';
                });
                ui.photosetToggle.addEventListener('change', e => {
                    const isSet = e.target.checked;
                    const button = ui.photoDetailsModal.querySelector('[data-action="save-photo-details"]');
                    const skipBtn = ui.photoDetailsModal.querySelector('[data-action="skip-photo-details"]');
                    button.textContent = '';
                    skipBtn.style.display = isSet ? 'none' : 'inline-block';
                });
                document.querySelector('[data-action="close-wander-view"]').addEventListener('click', actions['close-wander-view']);
                document.querySelector('[data-action="toggle-player-collapse"]').addEventListener('click', actions['toggle-player-collapse']);
                ui.categorySelector.addEventListener("change", () => {
   populateDriveProjectSelector();
   fetchFilesForSelectedProject();
});

                ui.projectSelector.addEventListener("change", fetchFilesForSelectedProject);
                ui.selectFileBtn.addEventListener('click', () => ui.fileUploader.click());
                ui.fileUploader.addEventListener("change",()=>{ if(ui.fileUploader.files.length>0){ const file = ui.fileUploader.files[0]; ui.fileNameInput.value=file.name; ui.selectedFileName.textContent = file.name; } else { ui.selectedFileName.textContent = ""; }});
                ui.uploadBtn.addEventListener("click", uploadFile);
            },
            getAlbumItems: () => memoryCache ? memoryCache.album.items : [],
        };
    })();
    // ===== [END] MEMORY APP LOGIC =====

    // ===== [START] WANDER VIEW 4.0 LOGIC (Architecture) =====
    const WanderView = (() => {
        const MUSIC_DATA_PATH = 'memory/music_data.json';
        const MUSIC_FILES_PATH = 'memory/music/';
        let musicDataSha = null;

        const ui = {
            overlay: document.getElementById('wanderViewOverlay'),
            photoContainer: document.getElementById('wander-photo-container'),
            img: document.getElementById('wander-img'),
            title: document.getElementById('wander-title'),
            description: document.getElementById('wander-description'),
            player: {
                container: document.getElementById('wander-music-player'),
                audio: document.getElementById('audio-player'),
                playPauseBtn: document.getElementById('play-pause-btn'),
                prevBtn: document.getElementById('prev-song-btn'),
                nextBtn: document.getElementById('next-song-btn'),
                loopBtn: document.getElementById('loop-mode-btn'),
                playlistBtn: document.getElementById('playlist-btn'),
                displayArea: document.getElementById('player-display-area'),
                progressTrack: document.querySelector('.player-progress-track'),
                progressBar: document.getElementById('player-progress-bar'),
                progressHandle: document.getElementById('player-progress-handle'),
                popover: document.getElementById('playlist-popover'),
                popoverPlaylist: document.getElementById('popover-playlist-ul'),
                openSettingsBtn: document.getElementById('open-music-settings-btn'),
                handle: document.querySelector('.player-handle-container'),
                mainContent: document.querySelector('.wander-main-content'),
            },
            settingsModal: {
                modal: document.getElementById('musicSettingsModal'),
                uploadMusicBtn: document.getElementById('upload-music-btn'),
                uploadLrcBtn: document.getElementById('upload-lrc-btn'),
                musicStatus: document.getElementById('upload-music-status'),
                lrcStatus: document.getElementById('upload-lrc-status'),
                renameInput: document.getElementById('music-rename-input'),
                confirmUploadBtn: document.getElementById('confirm-upload-btn'),
                musicFilePicker: document.getElementById('music-file-picker'),
                lrcFilePicker: document.getElementById('lrc-file-picker'),
                playlistContainer: document.getElementById('music-playlist-container'),
                autoplayToggle: document.getElementById('autoplay-toggle'),
            }
        };

        const state = {
            items: [], currentIndex: -1,
            playlist: [], currentTrackIndex: -1, isPlaying: false,
            loopMode: 'all',
            lyrics: [],
            lastWanderedItemId: null,
            pendingMusicFile: null,
            pendingLrcFile: null,
            isSeeking: false,
        };
        
        const icons = {
            play: '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>',
            pause: '<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>',
            prev: '<svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"/></svg>',
            next: '<svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>',
            loopAll: '<svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>',
            loopOne: '<svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4zm-4-2V9h-1l-2 1v1h1.5v3H13z"/></svg>',
            shuffle: '<svg viewBox="0 0 24 24"><path d="M10.59 9.17 5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>',
            musicNote: '<svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>',
            delete: '<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>',
            list: '<svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>',
        };

        function start(items) {
            if (!items || items.length === 0) { alert(''); return; }
            let itemPool = [...items];
            if (itemPool.length > 1 && state.lastWanderedItemId) {
                itemPool = itemPool.filter(p => p.id !== state.lastWanderedItemId);
            }
             if (itemPool.length > 0) {
                for ( let i = itemPool.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [itemPool[i], itemPool[j]] = [itemPool[j], itemPool[i]];
                }
             } else {
                itemPool = [...items];
             }

            state.items = itemPool;
            state.currentIndex = 0;
            state.lastWanderedItemId = itemPool[0]?.id;
            
            ui.overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            updateContent();
            loadCloudPlaylist().then(() => {
                if (ui.settingsModal.autoplayToggle.checked && state.playlist.length > 0) {
                    playTrack(state.currentTrackIndex > -1 ? state.currentTrackIndex : 0);
                }
            });
        }

        function close() {
            ui.overlay.classList.remove('active');
            document.body.style.overflow = '';
            if (state.isPlaying) {
                ui.player.audio.pause();
                ui.player.audio.src = ''; // Force stop
            }
        }

        async function updateContent() {
            const item = state.items[state.currentIndex];
            if (!item) return;

            let photo, title, description;
            if (item.type === 'photoset') {
                item.internalIndex = item.internalIndex ?? 0;
                photo = item.photos[item.internalIndex];
                title = item.title;
                description = item.description;
            } else {
                photo = item;
                title = item.title;
                description = item.description;
            }
            
            ui.img.src = ""; 
            ui.img.alt = "...";

            const photoUrl = await getSecureFileUrl(photo.path);
            ui.img.src = photoUrl;
            ui.img.alt = title || description || "Wander view image";
            ui.photoContainer.style.setProperty('--blur-bg', `url(${photoUrl})`);
            ui.title.textContent = title || '';
            ui.description.textContent = description || '';
        }
        
        async function changePhoto(direction) {
            const item = state.items[state.currentIndex];
            if (item.type === 'photoset' && !ui.photoContainer.classList.contains('fullscreen')) {
                let nextIndex = (item.internalIndex || 0) + direction;
                if (nextIndex >= 0 && nextIndex < item.photos.length) {
                    item.internalIndex = nextIndex;
                } else {
                    changeItem(direction);
                }
            } else {
                changeItem(direction);
            }
            await updateContent();
         }

        function changeItem(direction) {
            let nextIndex = state.currentIndex + direction;
            if (nextIndex < 0) nextIndex = state.items.length - 1;
            if (nextIndex >= state.items.length) nextIndex = 0;
            
            state.currentIndex = nextIndex;
            const newItem = state.items[state.currentIndex];
            if (newItem.type === 'photoset') {
                newItem.internalIndex = direction > 0 ? 0 : newItem.photos.length - 1;
            }
        }
        
        function initGestures() {
            let startX = 0;
            ui.photoContainer.addEventListener('touchstart', e => { startX = e.touches[0].clientX; }, { passive: true });
            ui.photoContainer.addEventListener('touchend', e => {
                const endX = e.changedTouches[0].clientX;
                const swipeDiff = endX - startX;
                if (Math.abs(swipeDiff) < 50) return;
                
                if (ui.photoContainer.classList.contains('fullscreen') && state.items[state.currentIndex].type !== 'photoset') {
                    changePhoto(swipeDiff > 0 ? -1 : 1);
                } else {
                    changePhoto(swipeDiff > 0 ? -1 : 1);
                }
            }, { passive: true });
        }

        function initPlayer() {
            const p = ui.player;
            const sm = ui.settingsModal;

            p.playPauseBtn.innerHTML = icons.play; p.prevBtn.innerHTML = icons.prev; p.nextBtn.innerHTML = icons.next; p.loopBtn.innerHTML = icons.loopAll; p.playlistBtn.innerHTML = icons.list; p.openSettingsBtn.innerHTML = icons.musicNote;
            
            p.playlistBtn.addEventListener('click', (e) => { e.stopPropagation(); p.popover.classList.toggle('active'); });
            p.openSettingsBtn.addEventListener('click', () => { p.popover.classList.remove('active'); sm.modal.classList.add('show'); });
            document.addEventListener('click', (e) => { if (!p.container.contains(e.target)) p.popover.classList.remove('active'); });

            sm.uploadMusicBtn.addEventListener('click', () => sm.musicFilePicker.click());
            sm.uploadLrcBtn.addEventListener('click', () => sm.lrcFilePicker.click());
            sm.musicFilePicker.addEventListener('change', (e) => {
                if(e.target.files.length > 0) {
                    state.pendingMusicFile = e.target.files[0];
                    sm.musicStatus.textContent = state.pendingMusicFile.name;
                    sm.renameInput.value = state.pendingMusicFile.name.replace(/\.[^/.]+$/, "");
                }
            });
            sm.lrcFilePicker.addEventListener('change', (e) => {
                if(e.target.files.length > 0) {
                    state.pendingLrcFile = e.target.files[0];
                    sm.lrcStatus.textContent = state.pendingLrcFile.name;
                }
            });
            sm.confirmUploadBtn.addEventListener('click', () => {
                if (sm.confirmUploadBtn.textContent.startsWith("")) {
                    if(activeUploadXHR) activeUploadXHR.abort();
                } else {
                    uploadPendingFiles();
                }
            });

            p.playPauseBtn.addEventListener('click', () => {
                if (state.playlist.length === 0) { sm.modal.classList.add('show'); return; }
                if(state.currentTrackIndex === -1) playTrack(0);
                else if (state.isPlaying) p.audio.pause(); 
                else p.audio.play();
            });
            p.audio.onplay = () => { state.isPlaying = true; p.playPauseBtn.innerHTML = icons.pause; p.playPauseBtn.title = ""; p.progressHandle.classList.add('playing'); };
            p.audio.onpause = () => { state.isPlaying = false; p.playPauseBtn.innerHTML = icons.play; p.playPauseBtn.title = ""; p.progressHandle.classList.remove('playing'); };
            p.audio.onloadedmetadata = () => updateProgressUI();
            p.audio.ontimeupdate = () => {
                if (!state.isSeeking) updateProgressUI();
                updateLyrics(p.audio.currentTime);
            };
            p.audio.onended = () => nextTrack(false);
            p.nextBtn.addEventListener('click', () => nextTrack(true));
            p.prevBtn.addEventListener('click', () => {
                if (state.playlist.length === 0) return;
                let newIndex = state.currentTrackIndex - 1;
                if (newIndex < 0) newIndex = state.playlist.length - 1;
                playTrack(newIndex);
            });
             p.loopBtn.addEventListener('click', () => {
                if (state.loopMode === 'all') { state.loopMode = 'one'; p.loopBtn.innerHTML = icons.loopOne; p.loopBtn.title = ""; }
                else if (state.loopMode === 'one') { state.loopMode = 'shuffle'; p.loopBtn.innerHTML = icons.shuffle; p.loopBtn.title = ""; }
                else { state.loopMode = 'all'; p.loopBtn.innerHTML = icons.loopAll; p.loopBtn.title = ""; }
            });
            sm.autoplayToggle.checked = localStorage.getItem('wanderAutoplay') === 'true';
            sm.autoplayToggle.addEventListener('change', (e) => {
                localStorage.setItem('wanderAutoplay', e.target.checked);
            });
            
            const onSeek = (e) => {
                const trackRect = p.progressTrack.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                let percent = (clientX - trackRect.left) / trackRect.width;
                percent = Math.max(0, Math.min(1, percent));
                
                if (p.audio.duration) {
                    p.audio.currentTime = percent * p.audio.duration;
                    updateProgressUI();
                }
            };
            const startSeek = (e) => { state.isSeeking = true; onSeek(e); };
            const endSeek = () => { state.isSeeking = false; };
            p.progressTrack.addEventListener('pointerdown', startSeek);
            document.addEventListener('pointermove', (e) => { if(state.isSeeking) onSeek(e); });
            document.addEventListener('pointerup', endSeek);
        }
        
        function updateProgressUI() {
            const p = ui.player;
            if (!p.audio.duration) return;
            const percent = (p.audio.currentTime / p.audio.duration) * 100;
            p.progressBar.style.width = `${percent}%`;
            p.progressHandle.style.left = `${percent}%`;
        }

        function nextTrack(manual = false) {
            if (state.playlist.length === 0) return;
            if (state.playlist.length === 1 && state.loopMode !== 'none') { playTrack(0); return; }
            if (state.loopMode === 'one' && !manual) { playTrack(state.currentTrackIndex); return; }
            
            let newIndex;
            if (state.loopMode === 'shuffle') {
                do { newIndex = Math.floor(Math.random() * state.playlist.length); } while (state.playlist.length > 1 && newIndex === state.currentTrackIndex);
            } else {
                newIndex = state.currentTrackIndex + 1;
                if (newIndex >= state.playlist.length) {
                    if (state.loopMode === 'all') newIndex = 0;
                    else { ui.player.audio.pause(); return; }
                }
            }
            playTrack(newIndex);
        }

        async function playTrack(index) {
            if (index < 0 || index >= state.playlist.length) return;
            state.currentTrackIndex = index;
            const track = state.playlist[index];
            
            ui.player.displayArea.innerHTML = `<div class="music-loader"></div>`;
            const audioUrl = await getSecureFileUrl(track.musicPath);

            if (!audioUrl) {
                console.error(`Failed to get URL for track: ${track.displayName}`);
                alert(` "${track.displayName}"`);
                ui.player.displayArea.innerHTML = `<div class="song-title-display">${track.displayName} ()</div>`;
                nextTrack(true);
                return;
            }
            ui.player.audio.src = audioUrl;
            
            state.lyrics = [];

            const displaySongTitle = () => {
                ui.player.displayArea.innerHTML = `<div class="song-title-display">${track.displayName}</div>`;
            };

            if (track.lrcPath) {
                try {
                    const lrcUrl = await getSecureFileUrl(track.lrcPath);
                    const response = await fetch(lrcUrl);
                    if(response.ok) {
                        const lrcText = await response.text();
                        state.lyrics = parseLRC(lrcText);
                    }
                } catch (e) { 
                    console.error("Could not fetch lyrics", e); 
                    state.lyrics = [];
                }
            }
            
            if(state.lyrics && state.lyrics.length > 0) {
                 ui.player.displayArea.innerHTML = `<div id="lyrics-container"><ul id="lyrics-ul"></ul></div>`;
                 renderLyrics();
                 updateLyrics(0);
            } else {
                 displaySongTitle();
            }
            
            ui.player.audio.play().catch(e => console.error("Audio play failed:", e));
            renderPlaylists();
        }

        function renderPlaylists() {
            renderPlaylistInPopover();
            renderPlaylistInModal();
        }

        function renderPlaylistInPopover() {
            ui.player.popoverPlaylist.innerHTML = state.playlist.map((track, index) => 
                `<li data-index="${index}" class="${index === state.currentTrackIndex ? 'playing' : ''}">
                    <span class="playlist-item-name">${track.displayName}</span>
                 </li>`
            ).join('');
            ui.player.popoverPlaylist.querySelectorAll('li').forEach(el => {
                el.addEventListener('click', (e) => {
                    playTrack(parseInt(e.currentTarget.dataset.index, 10));
                    ui.player.popover.classList.remove('active');
                });
            });
        }

        function renderPlaylistInModal() {
            const sm = ui.settingsModal;
            sm.playlistContainer.innerHTML = state.playlist.map((track, index) => 
                `<li data-index="${index}" class="${index === state.currentTrackIndex ? 'playing' : ''}">
                    <span class="song-name">${track.displayName}</span>
                    <button class="player-btn delete-song-btn" data-index="${index}">${icons.delete}</button>
                 </li>`
            ).join('');

            sm.playlistContainer.querySelectorAll('.song-name').forEach(el => {
                el.addEventListener('click', (e) => {
                    const songIndex = parseInt(e.currentTarget.parentElement.dataset.index, 10);
                    sm.modal.classList.remove('show');
                    start(MemoryApp.getAlbumItems());
                    setTimeout(() => playTrack(songIndex), 500);
                });
            });
            sm.playlistContainer.querySelectorAll('.delete-song-btn').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteSong(parseInt(e.currentTarget.dataset.index, 10));
                });
            });
        }

        async function deleteSong(index) {
            const track = state.playlist[index];
            if (!confirm(` "${track.displayName}" `)) return;

            try {
                await deleteFromGithub(track.musicPath, `Delete music: ${track.musicPath}`, track.musicSha);
                if (track.lrcPath && track.lrcSha) {
                    await deleteFromGithub(track.lrcPath, `Delete lyric: ${track.lrcPath}`, track.lrcSha);
                }
                state.playlist.splice(index, 1);
                await saveCloudPlaylist();
                
                if (index === state.currentTrackIndex) {
                    ui.player.audio.pause();
                    ui.player.audio.src = '';
                    state.currentTrackIndex = -1;
                    if (state.playlist.length > 0) playTrack(0);
                } else if (index < state.currentTrackIndex) {
                    state.currentTrackIndex--;
                }
                renderPlaylists();

            } catch(e) { alert(await handleApiError("", e)); }
        }

        function parseLRC(lrc) {
            const lines = lrc.split('\n');
            const result = [];
            const timeRegex = /\[(\d{2}):(\d{2})[.:](\d{2,3})\]/g;
            for (const line of lines) {
                const matches = [...line.matchAll(timeRegex)];
                const text = line.substring(line.lastIndexOf(']') + 1).trim();
                
                if (text && matches.length > 0) {
                    for (const match of matches) {
                        const minutes = parseInt(match[1], 10);
                        const seconds = parseInt(match[2], 10);
                        const milliseconds = parseInt(match[3].padEnd(3, '0'), 10);
                        const time = minutes * 60 + seconds + milliseconds / 1000;
                        result.push({ time, text });
                    }
                }
            }
            return result.sort((a, b) => a.time - b.time);
        }

        function renderLyrics() {
            const lyricsUl = document.getElementById('lyrics-ul');
            if(!lyricsUl) return;
            lyricsUl.innerHTML = state.lyrics.map(line => `<li>${line.text}</li>`).join('');
        }

        function updateLyrics(currentTime) {
            if (state.lyrics.length === 0) return;
            const lyricsUl = document.getElementById('lyrics-ul');
            if(!lyricsUl) return;

            let currentLineIndex = -1;
            for (let i = 0; i < state.lyrics.length; i++) {
                if (currentTime >= state.lyrics[i].time) {
                    currentLineIndex = i;
                } else {
                    break;
                }
            }
            
            if (currentLineIndex > -1) {
                const allLi = lyricsUl.children;
                if (allLi[currentLineIndex] && !allLi[currentLineIndex].classList.contains('current-lyric')) {
                    const oldLi = lyricsUl.querySelector('.current-lyric');
                    if(oldLi) oldLi.classList.remove('current-lyric');
                    allLi[currentLineIndex].classList.add('current-lyric');
                    
                    const offset = allLi[currentLineIndex].offsetTop;
                    lyricsUl.style.transform = `translateY(-${offset}px)`;
                }
            }
        }
        
        async function loadCloudPlaylist() {
            const { data } = await fetchFromGithub(MUSIC_DATA_PATH);
            if (data && data.content) {
                state.playlist = JSON.parse(b64_to_utf8(data.content));
                musicDataSha = data.sha;
            } else {
                state.playlist = [];
                musicDataSha = null;
            }
            renderPlaylists();
        }

       async function saveCloudPlaylist() {
            const content = utf8_to_b64(JSON.stringify(state.playlist, null, 2));
            const result = await saveToGithub(MUSIC_DATA_PATH, content, 'Update music playlist', musicDataSha);
            if (result.sha) {
                musicDataSha = result.sha;
            }
        }

        async function uploadPendingFiles() {
            const sm = ui.settingsModal;
            if (!state.pendingMusicFile) { alert(""); return; }
            const displayName = sm.renameInput.value.trim();
            if (!displayName) { alert(""); return; }
            
            const finalMusicFilename = displayName + '.mp3';
            const finalLrcFilename = displayName + '.lrc';
            sm.confirmUploadBtn.textContent = " (0%)";
            sm.confirmUploadBtn.disabled = false;
            try {
                const musicPath = MUSIC_FILES_PATH + finalMusicFilename;
                const musicResult = await uploadFileViaGitData({ file: state.pendingMusicFile, path: musicPath, commitMessage: `Upload music: ${finalMusicFilename}`, onProgress: (percent) => { if (percent < 100) sm.confirmUploadBtn.textContent = ` (${Math.round(percent)}%)`; else sm.confirmUploadBtn.textContent = '...'; } });
                let lrcResult = { sha: null, path: null };
                if (state.pendingLrcFile) { try { const lrcPath = MUSIC_FILES_PATH + finalLrcFilename; lrcResult = await uploadFileViaGitData({ file: state.pendingLrcFile, path: lrcPath, commitMessage: `Upload lyric: ${finalLrcFilename}`, onProgress: () => {} }); } catch(e) { alert(""); } }
                
                const existingIndex = state.playlist.findIndex(t => t.displayName === displayName);
                const newTrackData = { id: Date.now(), displayName, musicPath: musicResult.path, musicSha: musicResult.sha, lrcPath: lrcResult.path, lrcSha: lrcResult.sha };
                if (existingIndex > -1) state.playlist[existingIndex] = { ...state.playlist[existingIndex], ...newTrackData }; else state.playlist.push(newTrackData);
                
                await saveCloudPlaylist();
                renderPlaylists();
                resetUploadForm();
                alert(`"${displayName}" `);
            } catch (e) { if (e.message !== "") alert(await handleApiError(` ${displayName}`, e)); } 
            finally { sm.confirmUploadBtn.textContent = ""; sm.confirmUploadBtn.disabled = false; }
        }
        
        function resetUploadForm() {
            const sm = ui.settingsModal;
            state.pendingMusicFile = null; state.pendingLrcFile = null;
            sm.musicFilePicker.value = ''; sm.lrcFilePicker.value = '';
            sm.musicStatus.textContent = ''; sm.lrcStatus.textContent = '';
            sm.renameInput.value = '';
        }

        return {
            init: () => {
                ui.img.addEventListener('click', () => { const isFullscreen = ui.photoContainer.classList.toggle('fullscreen'); ui.player.container.classList.toggle('hidden', isFullscreen); });
                initGestures(); initPlayer();
            }, start, close,
            updateTheme: () => {
                const isDark = document.body.classList.contains('dark-mode');
                ui.overlay.style.background = isDark ? 'var(--bg-night-element)' : 'var(--bg-day-element)';
                ui.overlay.style.color = isDark ? 'var(--text-night)' : 'var(--text-day)';
            },
            togglePlayerCollapse: () => {
                const isCollapsed = ui.player.container.classList.toggle('collapsed');
                ui.player.mainContent.style.transform = isCollapsed ? `translateY(-${ui.player.container.offsetHeight - 30}px)` : 'translateY(0)';
            },
        };
    })();
    // ===== [END] WANDER VIEW LOGIC =====
    
    async function getSecureFileUrl(path) {
        if (!path) return '';
        if (secureFileCache.has(path)) {
            const cached = secureFileCache.get(path);
            if (typeof cached.then === 'function') {
                return await cached;
            }
            return cached;
        }

        const fetchPromise = new Promise(async (resolve, reject) => {
            try {
                if (!path.startsWith('projects/') && !path.startsWith('memory/')) {
                    resolve(path);
                    return;
                }
                
                const { data: metaData, error: metaError } = await fetchFromGithub(path, 'contents');
                if (metaError || !metaData || !metaData.sha) {
                    throw new Error(`Could not get metadata for ${path}. ${metaError || 'No SHA found.'}`);
                }

                const { data: blobData, error: blobError } = await fetchFromGithub(`blobs/${metaData.sha}`, 'git');

                if (blobError || !blobData || !blobData.content) {
                    throw new Error(`Could not get blob content for ${path}. ${blobError || 'No content returned.'}`);
                }
                
                const contentType = path.toLowerCase().endsWith('.html') || path.toLowerCase().endsWith('.htm') ? 'text/html' : metaData.type;
const blob = b64toBlob(blobData.content, contentType);

                const blobUrl = URL.createObjectURL(blob);
                
                secureFileCache.set(path, blobUrl);
                resolve(blobUrl);

            } catch (error) {
                console.error(`Failed to retrieve file: ${path}`, error);
                secureFileCache.delete(path);
                resolve('');
            }
        });

        secureFileCache.set(path, fetchPromise);
        return await fetchPromise;
    }


    function checkAppUpdate() {
        const lastSeenVersion = localStorage.getItem('lastSeenVersion');
        if (lastSeenVersion !== CURRENT_APP_VERSION) {
            document.getElementById('helpBtn').classList.add('has-update');
        }
    }

    window.addEventListener('load', async () => {
        initTheme(); 
        loadGithubConfig();
        checkAppUpdate();
        await loadInitialData();
        setupModals();
        MemoryApp.init();
        WanderView.init();
        FloatingBallManager.init();
        setupBgImageManager();
        setupColorSync(colorModal.pickerD1, colorModal.hexD1, 'dayColor1'); 
        setupColorSync(colorModal.pickerD2, colorModal.hexD2, 'dayColor2');
        setupColorSync(colorModal.pickerN1, colorModal.hexN1, 'nightColor1'); 
        setupColorSync(colorModal.pickerN2, colorModal.hexN2, 'nightColor2');
 function showIosWarning() {
            //  iOS  (iPhone, iPad, iPod)
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            //  localStorage 
            const hasBeenShown = localStorage.getItem('iosWarningShown') === 'true';
            if (isIOS && !hasBeenShown) {
                const modal = document.getElementById('iosWarningModal');
                const confirmBtn = document.getElementById('iosWarningConfirmBtn');
                // 
                modal.classList.add('show');
                // 
                confirmBtn.addEventListener('click', () => {
                    // 
                    modal.classList.remove('show');
                    //  localStorage 
                    localStorage.setItem('iosWarningShown', 'true');
                }, { once: true }); //  once: true 
            }
        }
        showIosWarning();
        /* =============================================================== */
        /* ============== []  V1.0 ============= */
        /* =============================================================== */
        const DragAndSort = (() => {
            let draggedEl = null;      // 
            let ghostEl = null;        // 
            let dropTarget = null;     // 
            let longPressTimer = null; // 
            let isDragging = false;    // 
            let startPos = { x: 0, y: 0 };
            let offset = { x: 0, y: 0 };

            const LONG_PRESS_DELAY = 300; //  300 
            const DRAG_THRESHOLD = 5;     //  5px 

            // 
            function startDrag(event) {
                if (!draggedEl) return;
                isDragging = true;
                
                const rect = draggedEl.getBoundingClientRect();

                // 1. 
                ghostEl = draggedEl.cloneNode(true);
                ghostEl.classList.add('drag-ghost');
                document.body.appendChild(ghostEl);
                
                // 
                ghostEl.style.width = `${rect.width}px`;
                ghostEl.style.height = `${rect.height}px`;
                ghostEl.style.left = `${rect.left}px`;
                ghostEl.style.top = `${rect.top}px`;

                // /
                offset.x = startPos.x - rect.left;
                offset.y = startPos.y - rect.top;

                // 2. body
                draggedEl.classList.add('dragging');
                document.body.classList.add('dragging-active');

                // 3. 
                moveGhost(startPos.x, startPos.y);
            }

            // 
            function moveGhost(clientX, clientY) {
                if (!ghostEl) return;
                ghostEl.style.left = `${clientX - offset.x}px`;
                ghostEl.style.top = `${clientY - offset.y}px`;
            }

            // 
            function onDragMove(event) {
                const a = event.touches ? event.touches[0] : event;
                const { clientX, clientY } = a;

                // 
                if (!isDragging) {
                    if (Math.abs(clientX - startPos.x) > DRAG_THRESHOLD || Math.abs(clientY - startPos.y) > DRAG_THRESHOLD) {
                        clearTimeout(longPressTimer); // 
                    }
                    return;
                }

                event.preventDefault(); // 
                moveGhost(clientX, clientY);

                // 
                ghostEl.style.display = 'none';
                const elementBelow = document.elementFromPoint(clientX, clientY);
                ghostEl.style.display = '';

                // 
                if (dropTarget) {
                    dropTarget.classList.remove('drag-over');
                    dropTarget = null;
                }
                
                // 
                const potentialTarget = elementBelow ? elementBelow.closest('.nav-btn, .category-pill') : null;
                if (potentialTarget && potentialTarget !== draggedEl && draggedEl.classList.contains(potentialTarget.classList[0])) {
                    dropTarget = potentialTarget;
                    dropTarget.classList.add('drag-over');
                }
            }

            // 
            function onDragEnd(event) {
                clearTimeout(longPressTimer);
                if (!isDragging) return;

                // 
                if (dropTarget) {
                    dropTarget.classList.remove('drag-over');
                    
                    const parent = draggedEl.parentNode;
                    const nextSiblingOfTarget = dropTarget.nextSibling;
                    
                    // DOM
                    parent.insertBefore(draggedEl, nextSiblingOfTarget);
                    parent.insertBefore(dropTarget, draggedEl);

                    // 
                    updateDataModel(draggedEl, dropTarget, parent);
                }

                // 
                draggedEl.classList.remove('dragging');
                document.body.classList.remove('dragging-active');
                if (ghostEl) {
                    ghostEl.remove();
                }
                
                draggedEl = null;
                ghostEl = null;
                dropTarget = null;
                isDragging = false;
                
                document.removeEventListener('mousemove', onDragMove);
                document.removeEventListener('touchmove', onDragMove);
                document.removeEventListener('mouseup', onDragEnd);
                document.removeEventListener('touchend', onDragEnd);
            }

            // 
            function onDragStart(event) {
                // 
                if (!document.body.classList.contains('management-active')) return;
                
                const target = event.target.closest('.nav-btn, .category-pill');
                if (!target || isDragging) return;

                // 
                if (event.target.classList.contains('delete-icon')) return;

                draggedEl = target;
                const a = event.touches ? event.touches[0] : event;
                startPos.x = a.clientX;
                startPos.y = a.clientY;

                // 
                longPressTimer = setTimeout(() => startDrag(event), LONG_PRESS_DELAY);

                // 
                document.addEventListener('mousemove', onDragMove);
                document.addEventListener('touchmove', onDragMove, { passive: false });
                document.addEventListener('mouseup', onDragEnd, { once: true });
                document.addEventListener('touchend', onDragEnd, { once: true });
            }

            // 
            function updateDataModel(el1, el2, parent) {
                // 
                if (parent.id === 'navContainer') {
                    const category = currentConfig.categories.find(c => c.name === currentCategory);
                    if (!category) return;

                    const allButtons = Array.from(parent.querySelectorAll('.nav-btn'));
                    const newButtonOrder = allButtons.map(btn => {
                        return category.buttons.find(b => b.href === btn.dataset.href);
                    }).filter(Boolean); // 

                    category.buttons = newButtonOrder;
                }
                // 
                else if (parent.id === 'categoryNav') {
                    const allPills = Array.from(parent.querySelectorAll('.category-pill'));
                    const newCategoryOrder = allPills.map(pill => {
                        return currentConfig.categories.find(c => c.name === pill.dataset.category);
                    }).filter(Boolean);

                    // 
                    const allCategory = newCategoryOrder.find(c => c.name === '');
                    const otherCategories = newCategoryOrder.filter(c => c.name !== '');
                    if (allCategory) {
                        currentConfig.categories = [allCategory, ...otherCategories];
                    } else {
                        currentConfig.categories = newCategoryOrder;
                    }
                }
                
                saveGlobalConfig('Reorder items via drag and drop');
            }

            // 
            return {
                init() {
                    console.log("Drag and Sort functionality initialized.");
                    const mainContainer = document.getElementById('navContainer');
                    const categoryContainer = document.getElementById('categoryNav');

                    // 
                    mainContainer.addEventListener('mousedown', onDragStart);
                    mainContainer.addEventListener('touchstart', onDragStart, { passive: true });
                    
                    categoryContainer.addEventListener('mousedown', onDragStart);
                    categoryContainer.addEventListener('touchstart', onDragStart, { passive: true });
                }
            };
        })();

        // 
        DragAndSort.init();
        /* =============================================================== */
        /* ========================= [] ========================== */
        /* =============================================================== */

    });
    </script>
</body>
</html>
